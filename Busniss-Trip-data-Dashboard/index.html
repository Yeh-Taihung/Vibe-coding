<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç”¢å“å·¥ç¨‹éƒ¨å‡ºå·®çµ±è¨ˆçœ‹æ¿ | Vibe Coding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* --------- å…¨åŸŸè®Šæ•¸èˆ‡é‡ç½® --------- */
    :root {
      --bg-body: #f3f5f4;
      --bg-card: #ffffff;
      --text-main: #22302c;
      --text-muted: #7d8c86;
      --border-color: #dde5df;
      --accent-primary: #8ba47c;
      --shadow-card: 0 4px 16px rgba(128, 143, 140, 0.08);
      --brand-gradient: linear-gradient(135deg, #b4cfa4, #81b2d9);
    }

    [data-theme="dark"] {
      --bg-body: #1a1d1c;
      --bg-card: #242826;
      --text-main: #e0e6e3;
      --text-muted: #8fa099;
      --border-color: #353d39;
      --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* --------- Header & Nav --------- */
    .page-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-body);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 12px;
    }

    .page-header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 20px 0;
    }

    .brand-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-img {
      height: 40px;
      width: auto;
    }

    .page-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
    }

    .theme-toggle {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .theme-toggle:hover {
      background: var(--border-color);
    }

    .nav-pills {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .nav-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid transparent;
      background: var(--bg-card);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: 0.2s;
    }
    .nav-btn:hover {
      border-color: #81b2d9;
      color: #81b2d9;
      transform: translateY(-1px);
    }

    /* --------- Main Layout --------- */
    .container {
      max-width: 1200px;
      margin: 20px auto 60px;
      padding: 0 20px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-card);
      border: 1px solid var(--border-color);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    /* --------- Controls --------- */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    select, input {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-main);
      font-family: inherit;
    }

    /* --------- Charts --------- */
    
    /* 1. ç›´æ¢åœ–å®¹å™¨ (å›ºå®šé«˜åº¦) */
    .chart-container-vertical {
      position: relative;
      width: 100%;
      height: 400px; 
      margin-top: 10px;
    }
    
    /* 2. æ©«æ¢åœ–å®¹å™¨ (å‹•æ…‹é«˜åº¦ï¼Œé è¨­ min-height) */
    .chart-container-horizontal {
      position: relative;
      width: 100%;
      min-height: 200px; /* JS æœƒè¦†å¯«é€™å€‹é«˜åº¦ */
      margin-top: 10px;
    }
    
    .chart-wrapper-scrollable {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(to bottom, var(--bg-card), var(--bg-body));
    }
    
    .chart-wrapper-base {
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(to bottom, var(--bg-card), var(--bg-body));
    }

    /* --------- Utilization Cards --------- */
    .util-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }
    .util-card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      overflow: hidden;
    }
    .util-level-tag {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .util-val { font-size: 24px; font-weight: 700; margin: 4px 0; }
    .util-desc { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
    .util-bar {
      height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden;
    }
    .util-bar-fill { height: 100%; border-radius: 3px; }

    /* --------- Timeline (Reverted to Tooltip Mode) --------- */
    .timeline-wrapper {
      width: 100%;
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
    }

    .timeline-grid-layout {
      display: grid;
      grid-template-columns: 100px repeat(12, 1fr); 
      min-width: 800px;
    }

    .timeline-header {
      border-bottom: 1px solid var(--border-color);
      background: rgba(180, 207, 164, 0.1);
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .timeline-header-cell {
      padding: 10px 4px;
      text-align: center;
      border-right: 1px dashed var(--border-color);
    }
    .timeline-header-cell:first-child { text-align: right; padding-right: 10px; }
    .timeline-header-cell:last-child { border-right: none; }

    .timeline-row {
      border-bottom: 1px solid var(--border-color);
      position: relative;
      height: 44px; /* é«˜åº¦èª¿å›ç·Šæ¹Šå‹ */
      align-items: center;
    }
    .timeline-row:last-child { border-bottom: none; }

    .timeline-name-col {
      padding: 0 10px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      border-right: 1px solid var(--border-color);
      background: var(--bg-card);
      z-index: 2;
    }

    .timeline-bars-container {
      grid-column: 2 / span 12; 
      position: relative;
      height: 100%;
    }

    .grid-lines {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      pointer-events: none;
      z-index: 0;
    }
    .grid-line {
      border-right: 1px dashed var(--border-color);
      height: 100%;
    }

    .timeline-item {
      position: absolute;
      top: 10px;
      bottom: 10px;
      border-radius: 4px;
      display: block; 
      /* æ¢å¾©åŸå§‹è¨­å®šï¼šéš±è—è¶…å‡ºå…§å®¹ï¼Œæ»‘é¼ ç§»ä¸Šå»æ‰é¡¯ç¤º */
      overflow: hidden; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      z-index: 1;
      opacity: 0.9;
      transition: all 0.2s;
      cursor: help; /* æç¤ºå¯ Hover */
    }
    .timeline-item:hover {
      transform: scaleY(1.15);
      z-index: 10;
      opacity: 1;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* ç§»é™¤ä¹‹å‰çš„ .timeline-label ç›¸é—œæ¨£å¼ï¼Œæ”¹ç”¨ Tooltip */

    .status-done { background: #8ba47c; }
    .status-active { background: #f4d35e; }
    .status-future { background: #fbc2c2; }

    /* --------- Table & Filters --------- */
    .table-header-actions {
      flex-grow: 1;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      gap: 8px;
    }
    
    .filter-select {
      padding: 6px 24px 6px 10px; /* å³å´ç•™ç©ºé–“çµ¦ç®­é ­ */
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-body);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%237d8c86%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 8px auto;
    }

    .table-container {
      overflow-x: auto;
      border: 1px solid var(--border-color);
      border-radius: 12px;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: rgba(0,0,0,0.02); text-align: left; padding: 12px; color: var(--text-muted); }
    td { padding: 10px 12px; border-top: 1px solid var(--border-color); }
    tr:hover td { background: rgba(0,0,0,0.02); }

    .highlight-num { font-weight: 700; color: var(--accent-primary); }
    
    /* RWD */
    @media (max-width: 768px) {
      .timeline-grid-layout { min-width: 600px; }
      .nav-pills { padding-bottom: 8px; }
      .brand-row { flex-direction: column; align-items: flex-start; gap: 10px; }
      .theme-toggle { position: absolute; top: 16px; right: 20px; }
      .card-header { flex-direction: column; align-items: flex-start; }
      .table-header-actions { justify-content: flex-start; width: 100%; }
      .filter-group { width: 100%; display: flex; gap: 8px; }
      .filter-select { flex: 1; }
      #searchInput { width: 100% !important; margin-top: 4px; }
    }
  </style>
</head>
<body>

  <header class="page-header">
    <div class="page-header-inner">
      <div class="brand-row">
        <div class="logo-area">
          <img src="./icons/logo.png" alt="å¯¶æ–° Logo" class="logo-img">
          <div style="font-size: 18px; font-weight:700;">ç”¢å“å·¥ç¨‹éƒ¨å‡ºå·®çµ±è¨ˆçœ‹æ¿</div>
        </div>
        <button class="theme-toggle" id="themeBtn">
          <span>â—</span> åˆ‡æ›æ¨¡å¼
        </button>
      </div>
      <p class="page-desc">æ•´åˆ Google è¡¨å–®è³‡æ–™ï¼Œå³æ™‚è¦–è¦ºåŒ–å¹´åº¦å‡ºå·®åˆ†ä½ˆèˆ‡äººåŠ›è² è¼‰ã€‚</p>
      
      <div class="nav-pills" style="margin-top: 12px;">
        <button class="nav-btn" onclick="scrollToId('section-stats')">ğŸ“Š çµ±è¨ˆåœ–è¡¨</button>
        <button class="nav-btn" onclick="scrollToId('section-util')">ğŸ° åˆ©ç”¨ç‡</button>
        <button class="nav-btn" onclick="scrollToId('section-timeline')">ğŸ“… æ™‚é–“è»¸</button>
        <button class="nav-btn" onclick="scrollToId('section-list')">ğŸ“ è©³ç´°åˆ—è¡¨</button>
      </div>
    </div>
  </header>

  <main class="container">
    
    <div class="controls">
      <label>
        é¸æ“‡å¹´ä»½ï¼š
        <select id="yearSelect"></select>
      </label>
      <span style="color: var(--text-muted); font-size: 12px;">(è³‡æ–™ä¾†æºï¼šGoogle è©¦ç®—è¡¨ CSV)</span>
    </div>

    <section id="section-stats" class="card">
      <div class="card-header">
        <div class="card-title">å‡ºå·®å¤©æ•¸çµ±è¨ˆ</div>
      </div>
      <div class="card-subtitle">ä¾äººå“¡èˆ‡å°ˆæ¡ˆçµ±è¨ˆè©²å¹´åº¦ç´¯ç©å‡ºå·®ç¸½å¤©æ•¸ã€‚</div>

      <div style="font-weight:600; font-size:14px; margin-bottom:8px;">1. ä¾äººå“¡çµ±è¨ˆ (ç›´æ¢åœ–)</div>
      <div class="chart-wrapper-base">
        <div class="chart-container-vertical">
          <canvas id="peopleChart"></canvas>
        </div>
      </div>
      
      <div style="margin-top:20px; font-weight:600; font-size:14px; margin-bottom:8px;">2. ä¾å°ˆæ¡ˆ/é …ç›®çµ±è¨ˆ (æ©«æ¢åœ–)</div>
      <div class="chart-wrapper-scrollable">
        <div class="chart-container-horizontal" id="projectChartContainer">
          <canvas id="projectChart"></canvas>
        </div>
      </div>
    </section>

    <section id="section-util" class="card">
      <div class="card-header">
        <div class="card-title">å‡ºå·®åˆ©ç”¨ç‡ (äººåŠ›è² è¼‰)</div>
        <div style="font-size:12px; color:var(--text-muted);">åŸºæº–ï¼š<span class="highlight-num">240å¤©</span>/å¹´</div>
      </div>
      <div class="card-subtitle" style="line-height: 1.6;">
        <span style="color:#8ba47c; font-weight:600;">Aç´š â‰¥80%</span>ï¼šé«˜åˆ©ç”¨ (éœ€ç•™æ„ç–²å‹èˆ‡è¼ªæ›¿)<br>
        <span style="color:#f4d35e; font-weight:600;">Bç´š 60-80%</span>ï¼šå‡ºå·®ä¸»åŠ› (ç©©å®šæ”¯æ´)<br>
        <span style="color:#ffb88a; font-weight:600;">Cç´š 40-60%</span>ï¼šå‡è¡¡å‹ (å¯è¦–æƒ…æ³èª¿æ•´)<br>
        <span style="color:#e39b99; font-weight:600;">Dç´š <40%</span>ï¼šæ©Ÿå‹•æ”¯æ´ (å¯å¢åŠ å®‰æ’)
      </div>
      <div id="utilGrid" class="util-grid">
        </div>
    </section>

    <section id="section-timeline" class="card">
      <div class="card-header">
        <div class="card-title">å¹´åº¦å‡ºå·®æ™‚é–“è»¸</div>
      </div>
      <div class="card-subtitle">
        <span style="color:#8ba47c">â— å·²å®Œæˆ</span> &nbsp; 
        <span style="color:#f4d35e">â— é€²è¡Œä¸­</span> &nbsp; 
        <span style="color:#fbc2c2">â— æœªä¾†è¨ˆç•«</span>
        <span style="margin-left:12px; color:var(--text-muted); font-size:12px;">(æ»‘é¼ æ‡¸åœæ–¼å€å¡Šå¯æŸ¥çœ‹è©³ç´°æ—¥æœŸ)</span>
      </div>

      <div class="timeline-wrapper">
        <div class="timeline-grid-layout timeline-header">
          <div class="timeline-header-cell">äººå“¡</div>
          <div class="timeline-header-cell">1æœˆ</div><div class="timeline-header-cell">2æœˆ</div>
          <div class="timeline-header-cell">3æœˆ</div><div class="timeline-header-cell">4æœˆ</div>
          <div class="timeline-header-cell">5æœˆ</div><div class="timeline-header-cell">6æœˆ</div>
          <div class="timeline-header-cell">7æœˆ</div><div class="timeline-header-cell">8æœˆ</div>
          <div class="timeline-header-cell">9æœˆ</div><div class="timeline-header-cell">10æœˆ</div>
          <div class="timeline-header-cell">11æœˆ</div><div class="timeline-header-cell">12æœˆ</div>
        </div>
        <div id="timelineBody" class="timeline-body"></div>
      </div>
    </section>

    <section id="section-list" class="card">
      <div class="card-header">
        <div class="card-title">è©³ç´°è³‡æ–™åˆ—è¡¨</div>
        <div class="table-header-actions">
          <div class="filter-group">
            <select id="filterName" class="filter-select">
              <option value="">å…¨éƒ¨äººå“¡</option>
            </select>
            <select id="filterLocation" class="filter-select">
              <option value="">å…¨éƒ¨åœ°é»</option>
            </select>
          </div>
          <input type="text" id="searchInput" placeholder="æœå°‹å°ˆæ¡ˆé—œéµå­—..." style="width:200px;">
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>å§“å</th>
              <th>åœ°é»</th>
              <th>æ—¥æœŸå€é–“</th>
              <th>å¤©æ•¸</th>
              <th>å°ˆæ¡ˆå…§å®¹</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    /* =========================================
       1. Configuration & Data Parsing
       ========================================= */
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQI-ac_9JPcK5zQSCPT6xS1YYWUAv7n8-isJ_TrHuFSHGAK4I7d0EG8ZofBK36dvd9e4HM5FZCbVCr1/pub?output=csv";
    const MORANDI_COLORS = ["#b4cfa4", "#81b2d9", "#f4d35e", "#ffb88a", "#e39b99", "#a0c5e3", "#d3b8e1"];
    
    let allRecords = [];
    let currentYear = new Date().getFullYear();
    let chartInstances = {}; 

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchData();
      setupEvents();
      setupTheme();
    });

    async function fetchData() {
      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        allRecords = parseCsv(text);
        
        const years = [...new Set(allRecords.map(r => r.year))].sort((a,b)=>b-a);
        const sel = document.getElementById("yearSelect");
        if(years.length > 0) currentYear = years[0]; 
        
        years.forEach(y => {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        });

        renderAll(currentYear);

      } catch (err) {
        console.error("Data Load Error:", err);
        alert("ç„¡æ³•è®€å– CSV è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµã€‚");
      }
    }

    function parseCsv(csvText) {
      const lines = csvText.trim().split(/\r?\n/);
      const data = [];
      for(let i=1; i<lines.length; i++) {
        const cols = lines[i].split(','); 
        if(cols.length < 5) continue;
        const name = cols[1];
        const start = new Date(cols[3]);
        const end = new Date(cols[4]);
        const project = cols[5] || "æœªåˆ†é¡";
        if(isNaN(start) || isNaN(end)) continue;
        let curr = new Date(start);
        while(curr <= end) {
          const y = curr.getFullYear();
          const yearEnd = new Date(y, 11, 31);
          const segmentEnd = yearEnd < end ? yearEnd : end;
          const days = Math.floor((segmentEnd - curr)/(86400000)) + 1;
          data.push({
            name: name,
            location: cols[2],
            startDate: new Date(curr),
            endDate: new Date(segmentEnd),
            year: y,
            days: days,
            project: project,
            fullStartStr: cols[3],
            fullEndStr: cols[4]
          });
          curr = new Date(y + 1, 0, 1);
        }
      }
      return data;
    }

    function renderAll(year) {
      const yearData = allRecords.filter(r => r.year == year);
      renderCharts(yearData);
      renderUtil(yearData);
      renderTimeline(yearData, year);
      renderDropdownFilters(yearData); // æ¸²æŸ“ä¸‹æ‹‰é¸å–®é¸é …
      renderTable(yearData);
    }

    /* =========================================
       2. Charts (Mixed: Vertical & Horizontal)
       ========================================= */
    function renderCharts(data) {
      const peopleMap = {};
      const projectMap = {};
      data.forEach(d => {
        peopleMap[d.name] = (peopleMap[d.name] || 0) + d.days;
        projectMap[d.project] = (projectMap[d.project] || 0) + d.days;
      });

      // 1. äººå“¡ï¼šç›´æ¢åœ– (Vertical)
      drawVerticalChart('peopleChart', peopleMap, "äººå“¡å‡ºå·®å¤©æ•¸");
      
      // 2. å°ˆæ¡ˆï¼šæ©«æ¢åœ– (Horizontal) + å‹•æ…‹é«˜åº¦
      drawHorizontalChart('projectChart', 'projectChartContainer', projectMap, "å°ˆæ¡ˆæŠ•å…¥å¤©æ•¸");
    }

    function drawVerticalChart(canvasId, dataMap, label) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const sorted = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
      
      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

      chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(k => k[0]),
          datasets: [{
            label: label,
            data: sorted.map(v => v[1]),
            backgroundColor: sorted.map((_, i) => MORANDI_COLORS[i % MORANDI_COLORS.length]),
            borderRadius: 4,
            maxBarThickness: 50
          }]
        },
        options: {
          indexAxis: 'x', // ç›´æ¢
          maintainAspectRatio: false,
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function drawHorizontalChart(canvasId, containerId, dataMap, label) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      const sorted = Object.entries(dataMap).sort((a,b) => b[1] - a[1]);
      const labels = sorted.map(k => k[0]);
      
      // è¨ˆç®—å‹•æ…‹é«˜åº¦ï¼šæ¯å€‹ Bar çµ¦äºˆ 40pxï¼ŒåŠ ä¸Šä¸€äº›ç·©è¡
      const container = document.getElementById(containerId);
      const dynamicHeight = Math.max(200, labels.length * 40 + 50);
      container.style.height = `${dynamicHeight}px`;

      if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

      chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: sorted.map(v => v[1]),
            backgroundColor: sorted.map((_, i) => MORANDI_COLORS[i % MORANDI_COLORS.length]),
            borderRadius: 4,
            maxBarThickness: 30
          }]
        },
        options: {
          indexAxis: 'y', // æ©«æ¢
          maintainAspectRatio: false,
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { beginAtZero: true },
            y: { grid: { display: false } }
          }
        }
      });
    }

    /* =========================================
       3. Utilization
       ========================================= */
    function renderUtil(data) {
      const container = document.getElementById('utilGrid');
      container.innerHTML = "";
      const peopleMap = {};
      data.forEach(d => peopleMap[d.name] = (peopleMap[d.name] || 0) + d.days);

      Object.entries(peopleMap)
        .sort((a,b) => b[1] - a[1])
        .forEach(([name, days]) => {
          const rate = Math.round((days / 240) * 100);
          let level = "D";
          let color = "#e39b99";
          let desc = "æ©Ÿå‹•æ”¯æ´ï¼Œå¯å¢åŠ å®‰æ’";

          if (rate >= 80) { 
            level="A"; color="#8ba47c"; desc = "é«˜åˆ©ç”¨ï¼Œéœ€ç•™æ„ç–²å‹";
          } else if (rate >= 60) { 
            level="B"; color="#f4d35e"; desc = "å‡ºå·®ä¸»åŠ›ï¼Œç©©å®šæ”¯æ´";
          } else if (rate >= 40) { 
            level="C"; color="#ffb88a"; desc = "å‡è¡¡å‹ï¼Œå¯è¦–æƒ…æ³èª¿æ•´";
          }

          const html = `
            <div class="util-card">
              <span class="util-level-tag" style="background:${color}33; color:${color}">ç­‰ç´š ${level}</span>
              <div style="font-weight:600; color:var(--text-muted)">${name}</div>
              <div class="util-val" style="color:${color}">${rate}%</div>
              <div class="util-desc">${desc}</div>
              <div style="font-size:12px; color:var(--text-muted); margin-bottom:6px;">ç´¯ç© ${days} å¤©</div>
              <div class="util-bar">
                <div class="util-bar-fill" style="width:${Math.min(rate,100)}%; background:${color}"></div>
              </div>
            </div>
          `;
          container.insertAdjacentHTML('beforeend', html);
        });
    }

    /* =========================================
       4. Timeline (Simplified for Clarity)
       ========================================= */
    function renderTimeline(data, year) {
      const body = document.getElementById('timelineBody');
      body.innerHTML = "";
      const groups = {};
      data.forEach(d => {
        if(!groups[d.name]) groups[d.name] = [];
        groups[d.name].push(d);
      });
      const sortedNames = Object.keys(groups).sort();
      const today = new Date();

      sortedNames.forEach(name => {
        const row = document.createElement('div');
        row.className = "timeline-grid-layout timeline-row";
        const nameCol = document.createElement('div');
        nameCol.className = "timeline-name-col";
        nameCol.textContent = name;
        row.appendChild(nameCol);
        
        const barsContainer = document.createElement('div');
        barsContainer.className = "timeline-bars-container";
        const gridLines = document.createElement('div');
        gridLines.className = "grid-lines";
        for(let i=0; i<12; i++) {
          const line = document.createElement('div');
          line.className = "grid-line";
          gridLines.appendChild(line);
        }
        barsContainer.appendChild(gridLines);

        groups[name].forEach(trip => {
          const startDay = getDayOfYear(trip.startDate);
          const endDay = getDayOfYear(trip.endDate);
          const totalDays = isLeap(year) ? 366 : 365;
          const leftPct = ((startDay - 1) / totalDays) * 100;
          const widthPct = ((endDay - startDay + 1) / totalDays) * 100;

          const bar = document.createElement('div');
          bar.className = "timeline-item";
          let statusClass = "status-future";
          if (trip.endDate < today) statusClass = "status-done";
          else if (trip.startDate <= today && trip.endDate >= today) statusClass = "status-active";
          bar.classList.add(statusClass);
          bar.style.left = `${leftPct}%`;
          bar.style.width = `${Math.max(widthPct, 0.5)}%`; 
          
          // Tooltip: æ»‘é¼ ç§»ä¸Šå»é¡¯ç¤ºè©³ç´°è³‡è¨Š (è§£æ±ºæ–‡å­—é‡ç–Šå•é¡Œçš„æœ€ä½³è§£æ³•)
          bar.title = `${trip.project}\nåœ°é»: ${trip.location}\næ—¥æœŸ: ${trip.startDate.getMonth()+1}/${trip.startDate.getDate()} - ${trip.endDate.getMonth()+1}/${trip.endDate.getDate()} (${trip.days}å¤©)`;

          barsContainer.appendChild(bar);
        });
        row.appendChild(barsContainer);
        body.appendChild(row);
      });
    }

    function getDayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff = date - start;
      const oneDay = 1000 * 60 * 60 * 24;
      return Math.floor(diff / oneDay);
    }
    function isLeap(year) {
      return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }

    /* =========================================
       5. Table & Filters (Dropdowns)
       ========================================= */
    
    // æ¸²æŸ“ä¸‹æ‹‰é¸å–®çš„é¸é …
    function renderDropdownFilters(data) {
      const nameSelect = document.getElementById('filterName');
      const locSelect = document.getElementById('filterLocation');
      
      // æ¸…ç©ºèˆŠé¸é …ï¼Œä¿ç•™ç¬¬ä¸€é …ã€Œå…¨éƒ¨ã€
      nameSelect.innerHTML = '<option value="">å…¨éƒ¨äººå“¡</option>';
      locSelect.innerHTML = '<option value="">å…¨éƒ¨åœ°é»</option>';

      const uniqueNames = [...new Set(data.map(d => d.name))].filter(Boolean).sort();
      const uniqueLocations = [...new Set(data.map(d => d.location))].filter(Boolean).sort();

      uniqueNames.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });

      uniqueLocations.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l;
        opt.textContent = l;
        locSelect.appendChild(opt);
      });
    }

    // æ•´åˆæ‰€æœ‰ç¯©é¸æ¢ä»¶çš„ renderTable
    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      const nameVal = document.getElementById('filterName').value;
      const locVal = document.getElementById('filterLocation').value;
      const searchVal = document.getElementById('searchInput').value.toLowerCase();

      tbody.innerHTML = "";
      
      // å¤šé‡ç¯©é¸é‚è¼¯
      const filtered = data.filter(d => {
        const matchName = nameVal === "" || d.name === nameVal;
        const matchLoc = locVal === "" || d.location === locVal;
        const matchSearch = searchVal === "" || 
          d.project.toLowerCase().includes(searchVal) ||
          d.location.toLowerCase().includes(searchVal) || 
          d.name.toLowerCase().includes(searchVal);
        
        return matchName && matchLoc && matchSearch;
      });

      const sorted = filtered.sort((a,b) => a.startDate - b.startDate);
      
      if(sorted.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--text-muted);">ç„¡ç¬¦åˆè³‡æ–™</td></tr>';
        return;
      }

      sorted.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-weight:600">${d.name}</td>
          <td>${d.location}</td>
          <td style="font-size:12px; color:var(--text-muted)">
            ${d.startDate.toISOString().slice(0,10)} ~ ${d.endDate.toISOString().slice(0,10)}
          </td>
          <td><span style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:11px;">${d.days}å¤©</span></td>
          <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.project}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function setupEvents() {
      // å¹´ä»½åˆ‡æ›
      document.getElementById('yearSelect').addEventListener('change', (e) => {
        currentYear = e.target.value;
        renderAll(currentYear);
      });

      // ç¯©é¸äº‹ä»¶ç›£è½ï¼šä»»ä½•ä¸€å€‹è®Šå‹•éƒ½æœƒè§¸ç™¼é‡æ–°æ¸²æŸ“è¡¨æ ¼
      ['filterName', 'filterLocation', 'searchInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          const yearData = allRecords.filter(r => r.year == currentYear);
          renderTable(yearData);
        });
      });

      // Dark Mode
      const btn = document.getElementById('themeBtn');
      btn.addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      });
    }

    function setupTheme() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    }

    function scrollToId(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  </script>
</body>
</html>