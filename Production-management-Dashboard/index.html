<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é …ç›®ç®¡ç†çœ‹æ¿ v15 | RWD Mobile Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --------- Theme Variables --------- */
    :root {
      --color-primary: #00a99d;      
      --color-primary-light: #e0f2f1;
      --color-secondary: #f4d35e;    
      --color-accent: #ff8c42;       
      
      --bg-body: #f4f8f8;            
      --bg-card: #ffffff;
      
      --text-main: #2d3748;          
      --text-muted: #718096;         
      --border-light: #e2e8f0;
      
      --status-success: #00a99d;     
      --status-warning: #f6ad55;     
      --status-danger: #e53e3e;      
      --status-info: #63b3ed;        
      --status-neutral: #cbd5e0;     

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-card: 0 4px 15px -2px rgba(0, 0, 0, 0.05);
      --radius-card: 16px;
      --radius-input: 10px;
    }

    [data-theme="dark"] {
      --bg-body: #171923;
      --bg-card: #2d3748;
      --text-main: #f7fafc;
      --text-muted: #a0aec0;
      --border-light: #4a5568;
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; 
      font-family: 'Roboto', 'Noto Sans TC', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-main); 
      -webkit-font-smoothing: antialiased;
      padding-bottom: 40px;
    }
    .back-home-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background-color: var(--bg-color); /* æˆ–è‡ªè¨‚é¡è‰² */
    color: var(--text-main);
    border: 1px solid var(--accent);
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
}

.back-home-btn:hover {
    background-color: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

    /* --------- Sticky Header (Mobile Optimized) --------- */
    .sticky-header-wrapper {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
    }
    [data-theme="dark"] .sticky-header-wrapper { background: rgba(45, 55, 72, 0.98); }

    .brand-bar {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1280px;
        margin: 0 auto;
    }
    .logo-area { 
        font-size: 16px; font-weight: 700; color: var(--color-primary); 
        display: flex; align-items: center; gap: 8px;
    }
    .logo-icon {
        background: var(--color-primary); color: white;
        width: 28px; height: 28px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px;
    }
    .theme-toggle { 
        background: transparent; border: 1px solid var(--border-light); 
        color: var(--text-muted); padding: 6px 12px; border-radius: 20px; 
        cursor: pointer; font-size: 12px; font-weight: 600;
    }

    /* Controls Bar - RWD Grid */
    .controls-bar {
        padding: 0 16px 12px;
        max-width: 1280px;
        margin: 0 auto;
    }
    .controls-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* è‡ªå‹•é©æ‡‰å¯¬åº¦ */
        gap: 8px; 
        align-items: end;
    }
    /* æ‰‹æ©Ÿç‰¹åˆ¥å„ªåŒ–ï¼šæœå°‹æ¬„ä½”æ»¿ä¸€è¡Œ */
    @media (max-width: 600px) {
        .controls-grid { grid-template-columns: 1fr 1fr; }
        .controls-grid .search-group { grid-column: 1 / -1; }
    }

    .filter-group label { 
        display: block; font-size: 11px; color: var(--text-muted); 
        margin-bottom: 4px; font-weight: 600; 
    }
    select, input { 
        padding: 0 10px; /* Reset padding */
        border-radius: var(--radius-input); 
        border: 1px solid var(--border-light); 
        background: var(--bg-card); 
        color: var(--text-main); 
        width: 100%; 
        font-size: 14px; /* æ‰‹æ©Ÿä¸Šæ–‡å­—å¤§ä¸€é» */
        height: 40px; /* æ‰‹æ©Ÿæ˜“é»æ“Šé«˜åº¦ */
        line-height: 40px;
        appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
    }

    /* KPI Bar - Scrollable on Mobile */
    .kpi-bar {
        padding: 0 16px 12px;
        max-width: 1280px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    @media (max-width: 600px) {
        .kpi-bar { 
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿå–®æ¬„ */
            gap: 8px;
        }
    }

    .kpi-card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        border: 1px solid var(--border-light);
        position: relative;
        overflow: hidden;
    }
    .kpi-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background: var(--kpi-color);
    }
    .kpi-info { display: flex; flex-direction: column; }
    .kpi-title { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-bottom: 2px; }
    .kpi-val { font-size: 18px; font-weight: 700; color: var(--text-main); }

    /* --------- Content Area --------- */
    .container { max-width: 1280px; margin: 16px auto 60px; padding: 0 16px; }
    
    .card { 
        background: var(--bg-card); 
        border-radius: var(--radius-card); 
        padding: 20px; 
        margin-bottom: 20px; 
        box-shadow: var(--shadow-card); 
        border: none;
    }
    /* æ‰‹æ©Ÿç‰ˆå¡ç‰‡å…§è·ç¸®å° */
    @media (max-width: 600px) {
        .card { padding: 16px; margin-bottom: 16px; }
    }

    .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
    .card-title { font-size: 16px; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
    
    /* Project Info Bar - Mobile Grid */
    .project-info-bar { 
        display: flex; flex-wrap: wrap; 
        background: var(--bg-card);
        border: 1px solid var(--border-light);
        border-radius: var(--radius-card); 
        margin-bottom: 20px; 
        overflow: hidden;
        box-shadow: var(--shadow-card);
    }
    .p-item { 
        flex: 1; 
        min-width: 140px; 
        padding: 16px; 
        display: flex; flex-direction: column; justify-content: center;
        border-right: 1px solid var(--border-light);
    }
    .p-item:last-child { border-right: none; }
    
    @media (max-width: 768px) {
        .p-item { 
            flex: 0 0 50%; /* å¼·åˆ¶å…©æ¬„ */
            min-width: 0; /* å…è¨±ç¸®å° */
            border-bottom: 1px solid var(--border-light);
            border-right: 1px solid var(--border-light);
        }
        .p-item:nth-child(even) { border-right: none; } /* å¶æ•¸å€‹ç§»é™¤å³æ¡†ç·š */
    }

    .p-label { 
        font-size: 10px; color: var(--text-muted); font-weight: 600; 
        text-transform: uppercase; margin-bottom: 4px;
        display: flex; align-items: center; gap: 4px;
    }
    .p-value { font-size: 15px; font-weight: 700; color: var(--text-main); word-break: break-all; }

    /* Chart Container */
    .chart-wrapper { position: relative; height: 300px; width: 100%; }

    /* ğŸ”´ GANTT CHART MOBILE FIX (æ ¸å¿ƒä¿®æ­£) */
    .gantt-scroll-wrapper {
        width: 100%;
        overflow-x: auto; /* å…è¨±æ©«å‘æ²å‹• */
        border: 1px solid var(--border-light);
        border-radius: 12px;
        background: var(--bg-card);
        position: relative;
        -webkit-overflow-scrolling: touch; /* iOS é †æ»‘æ²å‹• */
    }
    
    /* è¨­å®šä¸€å€‹è¶³å¤ å¯¬çš„å®¹å™¨ï¼Œç¢ºä¿æœˆä»½ä¸è¢«å£“ç¸® */
    .gantt-min-width-container {
        min-width: 800px; /* æ‰‹æ©Ÿä¸Šå¼·è¿«å¯¬åº¦ï¼Œè§¸ç™¼æ²å‹• */
        position: relative;
    }

    /* å§“åæ¬„ä½å›ºå®šåœ¨å·¦å´ (Sticky Left) */
    .sticky-col-header, .sticky-col-cell {
        position: sticky;
        left: 0;
        z-index: 20; /* æ¯”æ™®é€šå…§å®¹é«˜ */
        background: var(--bg-card);
        border-right: 2px solid var(--border-light); /* æ˜é¡¯åˆ†éš”ç·š */
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        width: 120px;
        flex-shrink: 0;
    }
    [data-theme="dark"] .sticky-col-header, 
    [data-theme="dark"] .sticky-col-cell { background: #2d3748; }

    /* Timeline Header */
    .timeline-header-row {
        display: flex;
        border-bottom: 1px solid var(--border-light);
        background: #f7fafc;
        height: 40px;
    }
    [data-theme="dark"] .timeline-header-row { background: #2d3748; }

    .th-name { 
        display: flex; align-items: center; justify-content: center;
        font-size: 12px; font-weight: 700; color: var(--text-muted);
    }
    .th-months {
        flex-grow: 1;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        height: 100%;
    }
    .th-month {
        display: flex; align-items: center; justify-content: center;
        font-size: 11px; color: var(--text-muted); font-weight: 600;
        border-right: 1px solid var(--border-light);
    }

    /* Person Row */
    .person-row {
        display: flex;
        height: 48px; /* åŠ å¤§é«˜åº¦æ–¹ä¾¿é–±è®€ */
        border-bottom: 1px solid var(--border-light);
        position: relative;
    }
    .person-name {
        display: flex; flex-direction: column; justify-content: center; align-items: flex-start;
        padding-left: 10px;
        font-size: 12px; font-weight: 600;
        overflow: hidden;
    }
    .person-role { font-size: 10px; color: var(--text-muted); font-weight: 400; }
    
    .person-bars-area {
        flex-grow: 1;
        position: relative;
    }

    /* Grid Lines */
    .grid-bg-layer {
        position: absolute; top: 0; left: 120px; /* é¿é–‹ sticky å€ */
        right: 0; bottom: 0;
        display: grid; grid-template-columns: repeat(12, 1fr);
        pointer-events: none; z-index: 1;
    }
    .grid-line { border-right: 1px dashed var(--border-light); height: 100%; }
    
    /* Today Line */
    .today-line { 
        position: absolute; top: 0; bottom: 0; width: 2px; 
        border-left: 2px dashed var(--color-accent); z-index: 15; pointer-events: none; 
    }
    
    /* Gantt Bars */
    .gantt-bar { 
        position: absolute; top: 12px; bottom: 12px; 
        border-radius: 4px; font-size: 10px; color: #fff; 
        display: flex; align-items: center; padding-left: 6px; 
        white-space: nowrap; overflow: hidden; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 5;
    }
    .status-active { background: var(--status-success); } 
    .status-plan { background: #63b3ed; opacity: 0.7; }
    .status-past { background: var(--status-neutral); opacity: 0.6; }

    /* Table Mobile Fix */
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; min-width: 600px; /* å¼·åˆ¶å¯¬åº¦ */ border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 12px; color: var(--text-muted); background: #f7fafc; white-space: nowrap; }
    td { padding: 12px; border-top: 1px solid var(--border-light); white-space: nowrap; }
    [data-theme="dark"] th { background: #2d3748; }

    .tag { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .tag-normal { background: #e6fffa; color: #2c7a7b; }
    .tag-warning { background: #fffaf0; color: #dd6b20; } 
    .tag-expired { background: #ffebee; color: #c53030; } 
    .tag-left { background: #edf2f7; color: #718096; }

  </style>
</head>
<body>

  <header class="sticky-header-wrapper">
      <div class="brand-bar">
          <div class="logo-area">
              <div class="logo-icon">ğŸ“Š</div>
              ç¾å ´äººåŠ›çœ‹æ¿ <span style="font-weight:400; font-size:12px; margin-left:5px; color:var(--text-muted)">v15 Mobile</span>
          </div>
          <button class="theme-toggle" id="themeBtn">â— æ¨¡å¼</button>
      </div>

      <div class="controls-bar">
          <div class="controls-grid">
              <div class="filter-group">
                  <select id="yearSelect"></select>
              </div>
              <div class="filter-group">
                  <select id="filterSupplier"><option value="">å…¨éƒ¨ä¾›æ‡‰å•†</option></select>
              </div>
              <div class="filter-group">
                  <select id="filterLine"><option value="">å…¨éƒ¨ç”¢ç·š</option></select>
              </div>
              <div class="filter-group">
                  <select id="filterRole"><option value="">å…¨éƒ¨å·¥ç¨®</option></select>
              </div>
              <div class="filter-group search-group">
                  <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å§“åã€å·¥ç¨®...">
              </div>
          </div>
      </div>

      <div class="kpi-bar" id="kpiBar"></div>
      <a href="../index.html" class="back-home-btn">
    <i class="fa-solid fa-house"></i> å›åˆ°é¦–é 
</a>
  </header>

  <main class="container">

    <div class="project-info-bar">
      <div class="p-item">
        <div class="p-label" style="color:#3182ce;">ğŸ“… è³‡æ–™æ›´æ–°</div>
        <div class="p-value" id="dataUpdated">-</div>
      </div>
      <div class="p-item">
        <div class="p-label" style="color:#f4d35e;">ğŸ“ åœ°é»</div>
        <div class="p-value" id="projLoc">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">ğŸ å•Ÿå‹•æ—¥</div>
        <div class="p-value" id="projStart">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">ğŸ¯ å®Œæˆæ—¥</div>
        <div class="p-value" id="projEnd">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">â³ å‰©é¤˜å¤©æ•¸</div>
        <div class="p-value" id="projCountdown">-</div>
      </div>
    </div>

    <section class="card">
      <div class="card-header-row">
        <div class="card-title">å·¥ç¨®äººåŠ›åˆ†å¸ƒ</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="roleChart"></canvas>
      </div>
    </section>

    <section class="card">
      <div class="card-header-row">
        <div class="card-title">å·¥ä½œç”˜ç‰¹åœ–</div>
        <select id="ganttFilter" style="width: auto; height: 32px; font-size: 12px;">
            <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
            <option value="active">åƒ…é¡¯ç¤ºåœ¨å´—</option>
        </select>
      </div>
      
      <div class="gantt-scroll-wrapper">
        <div class="gantt-min-width-container">
            <div class="grid-bg-layer" id="gridBgLayer"></div>
            
            <div class="timeline-header-row">
                <div class="th-name sticky-col-header">äººå“¡ / ç”¢ç·š</div>
                <div class="th-months">
                    <div class="th-month">1æœˆ</div><div class="th-month">2æœˆ</div><div class="th-month">3æœˆ</div>
                    <div class="th-month">4æœˆ</div><div class="th-month">5æœˆ</div><div class="th-month">6æœˆ</div>
                    <div class="th-month">7æœˆ</div><div class="th-month">8æœˆ</div><div class="th-month">9æœˆ</div>
                    <div class="th-month">10æœˆ</div><div class="th-month">11æœˆ</div><div class="th-month">12æœˆ</div>
                </div>
            </div>

            <div id="timelineBody"></div>
        </div>
      </div>
      <div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:8px;">
          (å·¦å³æ»‘å‹•å¯æŸ¥çœ‹å®Œæ•´æ™‚é–“è»¸)
      </div>
    </section>

    <section class="card">
      <div class="card-title" style="margin-bottom: 20px;">è©³ç´°åˆ—è¡¨</div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>ç”¢ç·š</th><th>å§“å</th><th>ä¾›æ‡‰å•†</th><th>å·¥ç¨®</th><th>åˆ°å´—æ—¥</th><th>é›¢é–‹æ—¥</th><th>ç°½è­‰ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ğŸ”´ è«‹ä¿ç•™æ‚¨çš„ Google Sheet CSV é€£çµ
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTMpYtnj16wQP-OeZcdw62yofr9JI-sdwElid5nEjbXT4KQoJaVfHU-Aj4jGwCyNn0E8KEiJKL7U5GL/pub?output=csv";

    const ROLE_COLOR_MAP = {
        "PLC": "#00a99d", "æ©Ÿå™¨äºº": "#3182ce", "é›»å·¥": "#f6ad55", "é‰—å·¥": "#e53e3e", "å…¶ä»–": "#a0aec0"      
    };

    let allRecords = [];
    let projectMeta = { start: null, end: null, location: "", lastUpdated: "" };
    let currentYear = new Date().getFullYear();
    let chartInstance = null;
    const TODAY = new Date();

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchData();
      setupEvents();
    });

    async function fetchData() {
      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        parseCsv(text);
        renderYearSelect();
        renderFilters(); 
        renderAll(currentYear);
      } catch (err) {
        console.error(err);
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ CSV é€£çµ");
      }
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      allRecords = [];
      projectMeta = { start: null, end: null, location: "", lastUpdated: "" };

      let foundMeta = false;
      for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
          
          // è§£æ Meta (H-Kæ¬„)
          if (!foundMeta && cols.length >= 8 && cols[7]) {
              const potentialDate = new Date(cols[7]);
              if (!isNaN(potentialDate.getTime())) {
                  projectMeta.start = potentialDate;
                  if (cols[8]) projectMeta.end = new Date(cols[8]);
                  if (cols[9]) projectMeta.location = cols[9];
                  if (cols[10]) projectMeta.lastUpdated = cols[10];
                  foundMeta = true; 
              }
          }

          if (cols.length < 7) continue; 
          
          const arrival = new Date(cols[4]);
          if (isNaN(arrival.getTime())) continue;

          allRecords.push({
            supplier: cols[0], name: cols[1], role: cols[2], line: cols[3], 
            arrivalDate: arrival,
            leaveDate: cols[5] ? new Date(cols[5]) : null,
            visaExpiry: new Date(cols[6]),
            year: arrival.getFullYear()
          });
      }
    }

    function renderFilters() {
        const supplierSet = new Set(), lineSet = new Set(), roleSet = new Set();
        allRecords.forEach(d => {
            if(d.supplier) supplierSet.add(d.supplier);
            if(d.line) lineSet.add(d.line);
            if(d.role) roleSet.add(d.role);
        });
        populateSelect('filterSupplier', supplierSet);
        populateSelect('filterLine', lineSet);
        populateSelect('filterRole', roleSet);
    }

    function populateSelect(id, set) {
        const sel = document.getElementById(id);
        const currentVal = sel.value;
        sel.innerHTML = sel.options[0].outerHTML; 
        [...set].sort().forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            sel.appendChild(opt);
        });
        sel.value = currentVal;
    }

    function renderAll(year) {
      renderProjectInfo();
      const yearData = allRecords.filter(r => r.year == year);
      const filtered = applyFilters(yearData);
      const activePeople = filtered.filter(d => 
        d.arrivalDate <= TODAY && (d.leaveDate === null || d.leaveDate >= TODAY)
      );

      renderKpiBar(activePeople); 
      renderChart(activePeople);   
      renderTimeline(filtered, year); 
      renderTable(filtered); 
      renderBackgroundGrid(year);
    }

    function renderProjectInfo() {
      document.getElementById('projLoc').textContent = projectMeta.location || "-";
      document.getElementById('dataUpdated').textContent = projectMeta.lastUpdated || "-";
      document.getElementById('projStart').textContent = projectMeta.start ? projectMeta.start.toLocaleDateString() : "-";
      document.getElementById('projEnd').textContent = projectMeta.end ? projectMeta.end.toLocaleDateString() : "-";
      
      const pCount = document.getElementById('projCountdown');
      if (projectMeta.end) {
         const diff = Math.ceil((projectMeta.end - TODAY) / (1000 * 60 * 60 * 24));
         if (diff < 0) pCount.innerHTML = `<span style="color:var(--status-danger)">é€¾æœŸ ${Math.abs(diff)} å¤©</span>`;
         else pCount.textContent = `${diff} å¤©`;
      } else {
         pCount.textContent = "-";
      }
    }

    function renderKpiBar(activeData) {
      const container = document.getElementById('kpiBar');
      container.innerHTML = "";
      
      const warningDate = new Date(); warningDate.setDate(TODAY.getDate() + 30);
      const visaWarning = activeData.filter(d => d.visaExpiry > TODAY && d.visaExpiry <= warningDate).length;
      const visaExpired = activeData.filter(d => d.visaExpiry < TODAY).length;

      const kpis = [
        { title: "ç›®å‰åœ¨å´—", val: `${activeData.length} <span style='font-size:12px'>äºº</span>`, color: "var(--status-success)" },
        { title: "ç°½è­‰å³å°‡åˆ°æœŸ", val: `${visaWarning} <span style='font-size:12px'>äºº</span>`, color: "var(--status-warning)" },
        { title: "ç°½è­‰å·²éæœŸ", val: `${visaExpired} <span style='font-size:12px'>äºº</span>`, color: "var(--status-danger)" }
      ];

      kpis.forEach(k => {
        container.innerHTML += `
          <div class="kpi-card" style="--kpi-color: ${k.color}">
            <div class="kpi-info"><div class="kpi-title">${k.title}</div><div class="kpi-val" style="color:${k.color}">${k.val}</div></div>
          </div>`;
      });
    }

    function renderChart(activeData) {
      const ctx = document.getElementById('roleChart').getContext('2d');
      const roleCounts = {};
      activeData.forEach(d => roleCounts[d.role] = (roleCounts[d.role] || 0) + 1);

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(roleCounts),
          datasets: [{
            label: 'äººæ•¸',
            data: Object.values(roleCounts),
            backgroundColor: Object.keys(roleCounts).map(r => ROLE_COLOR_MAP[r] || "#a0aec0"),
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y', 
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderBackgroundGrid(year) {
        const layer = document.getElementById('gridBgLayer');
        layer.innerHTML = ""; 
        for(let i=0; i<12; i++) {
            const div = document.createElement('div');
            div.className = 'grid-line';
            layer.appendChild(div);
        }
        if (year == TODAY.getFullYear()) {
            const pct = ((TODAY - new Date(year, 0, 1)) / (365 * 86400000)) * 100;
            if (pct >= 0 && pct <= 100) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = `${pct}%`;
                layer.appendChild(line);
            }
        }
    }

    function renderTimeline(data, year) {
      const body = document.getElementById('timelineBody');
      body.innerHTML = "";
      const filterMode = document.getElementById('ganttFilter').value; 
      
      const groups = {};
      data.forEach(d => { if(!groups[d.name]) groups[d.name] = []; groups[d.name].push(d); });

      Object.keys(groups).sort().forEach(name => {
        const records = groups[name];
        const lastRec = records[records.length-1]; 
        const isActive = lastRec.arrivalDate <= TODAY && (lastRec.leaveDate === null || lastRec.leaveDate >= TODAY);

        if (filterMode === 'active' && !isActive) return;

        const row = document.createElement('div');
        row.className = 'person-row';
        // å§“åæ¬„ä½ Sticky
        row.innerHTML = `<div class="person-name sticky-col-cell">${name}<div class="person-role">${records[0].role}</div></div>`;

        const barsArea = document.createElement('div');
        barsArea.className = 'person-bars-area';

        records.forEach(trip => {
          let statusClass = "status-active";
          let endDate = trip.leaveDate;
          
          if (trip.arrivalDate > TODAY) statusClass = "status-plan";
          else if (trip.leaveDate && trip.leaveDate < TODAY) statusClass = "status-past";
          
          if (!endDate) endDate = (trip.arrivalDate > TODAY) ? new Date(year, 11, 31) : TODAY;

          const startPct = Math.max(0, ((trip.arrivalDate - new Date(year, 0, 1)) / (365 * 86400000)) * 100);
          const widthPct = Math.min(100 - startPct, ((endDate - trip.arrivalDate) / (365 * 86400000)) * 100);
          
          if (widthPct > 0) {
            const bar = document.createElement('div');
            bar.className = `gantt-bar ${statusClass}`;
            bar.style.left = startPct + '%';
            bar.style.width = widthPct + '%';
            barsArea.appendChild(bar);
          }
        });
        row.appendChild(barsArea);
        body.appendChild(row);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";

      data.sort((a,b) => a.arrivalDate - b.arrivalDate).forEach(d => {
        const tr = document.createElement('tr');
        const daysToVisa = Math.ceil((d.visaExpiry - TODAY) / 86400000);
        let visaTag = daysToVisa < 0 ? `<span class="tag tag-expired">éæœŸ</span>` : 
                      daysToVisa <= 30 ? `<span class="tag tag-warning">å‰©${daysToVisa}å¤©</span>` : 
                      `<span class="tag tag-normal">æ­£å¸¸</span>`;
        
        tr.innerHTML = `
          <td><span style="font-weight:600;color:var(--text-muted)">${d.line}</span></td>
          <td><strong>${d.name}</strong></td>
          <td>${d.supplier}</td>
          <td>${d.role}</td>
          <td>${d.arrivalDate.toLocaleDateString()}</td>
          <td>${d.leaveDate ? d.leaveDate.toLocaleDateString() : 'åœ¨è·'}</td>
          <td>${visaTag}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters(data) {
      const s = document.getElementById('filterSupplier').value;
      const l = document.getElementById('filterLine').value;
      const r = document.getElementById('filterRole').value;
      const q = document.getElementById('searchInput').value.toLowerCase();
      return data.filter(d => 
        (s===""||d.supplier===s) && (l===""||d.line===l) && (r===""||d.role===r) &&
        (q===""||d.name.toLowerCase().includes(q)||d.role.toLowerCase().includes(q))
      );
    }

    function renderYearSelect() {
      const sel = document.getElementById('yearSelect');
      const years = [...new Set(allRecords.map(r=>r.year))].sort((a,b)=>b-a);
      if(years.length === 0) years.push(currentYear);
      sel.innerHTML = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
      sel.value = currentYear;
    }

    function setupEvents() {
      ['yearSelect', 'filterSupplier', 'filterLine', 'filterRole', 'searchInput'].forEach(id => {
          document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', (e) => {
              if (id === 'yearSelect') currentYear = e.target.value;
              renderAll(currentYear);
          });
      });
      document.getElementById('ganttFilter').addEventListener('change', () => renderTimeline(applyFilters(allRecords.filter(r=>r.year==currentYear)), currentYear));
      document.getElementById('themeBtn').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      });
    }
  </script>
</body>
</html>