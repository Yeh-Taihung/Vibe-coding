<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èŠåŠ å“¥é …ç›®ç¾å ´äººåŠ›çœ‹æ¿ v25 | Status Column Added</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --------- Theme Variables --------- */
    :root {
      --color-primary: #00a99d;      
      --color-primary-light: #e0f2f1;
      --color-secondary: #f4d35e;    
      --color-accent: #e53e3e;    
      
      --bg-body: #f4f8f8;            
      --bg-card: #ffffff;
      
      --text-main: #2d3748;          
      --text-muted: #718096;         
      --border-light: #e2e8f0;
      
      --status-success: #00a99d;     
      --status-warning: #f6ad55;     
      --status-danger: #e53e3e;      
      --status-neutral: #cbd5e0;     
      --status-plan: #63b3ed;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-card: 0 4px 15px -2px rgba(0, 0, 0, 0.05);
      --radius-card: 16px;
      --radius-input: 10px;
    }

    [data-theme="dark"] {
      --bg-body: #171923;
      --bg-card: #2d3748;
      --text-main: #f7fafc;
      --text-muted: #a0aec0;
      --border-light: #4a5568;
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; 
      font-family: 'Roboto', 'Noto Sans TC', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-main); 
      -webkit-font-smoothing: antialiased;
      padding-bottom: 40px;
    }

    /* --------- Header Layout --------- */
    .brand-bar {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1280px;
        margin: 0 auto;
        background: var(--bg-body);
    }

    .brand-left { display: flex; align-items: center; gap: 12px; }

    .logo-area { 
        font-size: 18px; font-weight: 700; color: var(--color-primary); 
        display: flex; align-items: center; gap: 10px;
    }
    
    .logo-img { height: 40px; width: auto; object-fit: contain; }

    .brand-actions { display: flex; align-items: center; gap: 12px; }

    .action-btn {
        display: flex; align-items: center; gap: 6px;
        font-size: 13px; font-weight: 500; padding: 6px 12px;
        border-radius: 20px; text-decoration: none;
        transition: all 0.2s; cursor: pointer; border: 1px solid transparent;
    }
    
    .btn-sheet { background-color: #e6f4ea; color: #1e8e3e; border: 1px solid #ceead6; }
    .btn-sheet:hover { background-color: #dcece0; }
    .btn-back { color: var(--text-muted); background: transparent; }
    .btn-back:hover { color: var(--color-primary); background: var(--color-primary-light); }

    .theme-toggle { 
        background: transparent; border: 1px solid var(--border-light); 
        color: var(--text-muted); padding: 6px 12px; border-radius: 20px; 
        cursor: pointer; font-size: 12px; font-weight: 600;
    }

    /* --------- Controls (Sticky) --------- */
    .sticky-controls-wrapper {
        position: sticky; top: 0; z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-light);
        box-shadow: var(--shadow-sm);
        padding: 10px 16px;
    }
    [data-theme="dark"] .sticky-controls-wrapper { background: rgba(45, 55, 72, 0.95); }

    .controls-grid { 
        max-width: 1280px; margin: 0 auto; display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 8px; align-items: center;
    }
    @media (max-width: 600px) {
        .controls-grid { grid-template-columns: 1fr 1fr; }
        .controls-grid .search-group { grid-column: 1 / -1; }
    }

    .filter-group select, .filter-group input { 
        padding: 0 12px; border-radius: var(--radius-input); 
        border: 1px solid var(--border-light); background: var(--bg-card); 
        color: var(--text-main); width: 100%; font-size: 14px; 
        height: 40px; appearance: none; outline: none;
    }

    /* --------- KPI Bar --------- */
    .kpi-bar {
        padding: 16px 16px 0; max-width: 1280px; margin: 0 auto;
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    }
    @media (max-width: 600px) { .kpi-bar { grid-template-columns: 1fr; gap: 8px; } }

    .kpi-card {
        background: var(--bg-card); border-radius: 12px; padding: 12px 16px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid var(--border-light);
        position: relative; overflow: hidden;
    }
    .kpi-card::before {
        content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
        background: var(--kpi-color);
    }
    .kpi-title { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-bottom: 2px; }
    .kpi-val { font-size: 18px; font-weight: 700; color: var(--text-main); }

    /* --------- Content --------- */
    .container { max-width: 1280px; margin: 16px auto 60px; padding: 0 16px; }
    
    .card { 
        background: var(--bg-card); border-radius: var(--radius-card); 
        padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); border: none;
    }
    .card-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap:10px; }
    .card-title { font-size: 16px; font-weight: 700; color: var(--text-main); transition: all 0.3s ease; } 
    
    .project-info-bar { 
        display: flex; flex-wrap: wrap; background: var(--bg-card);
        border: 1px solid var(--border-light); border-radius: var(--radius-card); 
        margin-bottom: 20px; overflow: hidden; box-shadow: var(--shadow-card);
    }
    .p-item { 
        flex: 1; min-width: 140px; padding: 16px; 
        display: flex; flex-direction: column; justify-content: center;
        border-right: 1px solid var(--border-light);
    }
    .p-item:last-child { border-right: none; }
    .p-label { font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
    .p-value { font-size: 15px; font-weight: 700; color: var(--text-main); }

    .chart-wrapper { position: relative; height: 300px; width: 100%; }

    /* Gantt */
    .gantt-scroll-wrapper {
        width: 100%; overflow-x: auto; border: 1px solid var(--border-light);
        border-radius: 12px; background: var(--bg-card); position: relative;
    }
    .gantt-min-width-container { min-width: 800px; position: relative; }
    
    .sticky-col-header, .sticky-col-cell {
        position: sticky; left: 0; z-index: 20; background: var(--bg-card);
        border-right: 2px solid var(--border-light); box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        width: 120px; flex-shrink: 0;
    }
    [data-theme="dark"] .sticky-col-header, [data-theme="dark"] .sticky-col-cell { background: #2d3748; }

    .timeline-header-row { display: flex; border-bottom: 1px solid var(--border-light); background: #f7fafc; height: 40px; }
    .th-months { flex-grow: 1; display: grid; grid-template-columns: repeat(12, 1fr); height: 100%; }
    .th-month { display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-muted); border-right: 1px solid var(--border-light); }
    .th-name { display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: var(--text-muted); }

    .person-row { display: flex; height: 48px; border-bottom: 1px solid var(--border-light); position: relative; }
    .person-name { display: flex; flex-direction: column; justify-content: center; padding-left: 10px; font-size: 12px; font-weight: 600; overflow: hidden; }
    .person-role { font-size: 10px; color: var(--text-muted); }
    .person-bars-area { flex-grow: 1; position: relative; }

    .grid-bg-layer { position: absolute; top: 0; left: 120px; right: 0; bottom: 0; display: grid; grid-template-columns: repeat(12, 1fr); pointer-events: none; z-index: 1; }
    .grid-line { border-right: 1px dashed var(--border-light); height: 100%; }
    
    /* Today Line */
    .today-line { 
        position: absolute; top: 0; bottom: 0; width: 0px; 
        border-left: 2px dashed var(--color-accent); z-index: 15; pointer-events: none; 
    }
    .today-line::after {
        content: 'Today'; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
        background-color: var(--color-accent); color: white; padding: 2px 6px;
        border-radius: 0 0 4px 4px; font-size: 10px; font-weight: bold; white-space: nowrap;
    }
    
    .gantt-bar { 
        position: absolute; top: 12px; bottom: 12px; border-radius: 4px; 
        font-size: 10px; color: #fff; display: flex; align-items: center; padding-left: 6px; 
        white-space: nowrap; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 5;
    }
    
    .status-active { background: var(--status-success); } 
    .status-plan { background: var(--status-plan); opacity: 0.8; }
    .status-past { background: var(--status-neutral); opacity: 0.8; }

    /* Gantt Legend */
    .gantt-legend {
        display: flex; gap: 15px; font-size: 12px; color: var(--text-muted); align-items: center;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

    /* Table */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; min-width: 800px; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 12px; color: var(--text-muted); background: #f7fafc; white-space: nowrap; }
    td { padding: 12px; border-top: 1px solid var(--border-light); white-space: nowrap; }
    [data-theme="dark"] th { background: #2d3748; }

    .tag { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .tag-normal { background: #e6fffa; color: #2c7a7b; }
    .tag-warning { background: #fffaf0; color: #dd6b20; } 
    .tag-expired { background: #ffebee; color: #c53030; } 
    
    .tag-visa { border: 1px solid var(--border-light); color: var(--text-muted); padding: 1px 6px; border-radius: 4px; font-size: 11px; }

    /* ğŸŸ¢ æ–°å¢ï¼šåˆ—è¡¨ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
    .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block; min-width: 60px; text-align: center; color: #fff; }
    .badge-past { background: var(--status-neutral); color: #4a5568; } /* å·²é›¢å´— (ç°è‰²) */
    .badge-active { background: var(--status-success); } /* é€²è¡Œä¸­ (ç¶ è‰²) */
    .badge-plan { background: var(--status-plan); } /* è¨ˆç•«ä¸­ (è—è‰²) */

  </style>
</head>
<body>

  <div class="brand-bar">
      <div class="brand-left">
          <div class="logo-area">
              <img src="../../logo.png" alt="Mr.Yes Logo" class="logo-img">
              <div>
                  <div style="line-height:1.2">èŠåŠ å“¥é …ç›®ç¾å ´äººåŠ›çœ‹æ¿</div>
                  <div style="font-size:11px; font-weight:400; color:var(--text-muted)">Project Field Manpower Dashboard v25</div>
              </div>
          </div>
      </div>

      <div class="brand-actions">
          <a href="https://docs.google.com/spreadsheets/d/1CbePJ4IT-mBH80dQkwb0nP9XIzbN93WhuiwMa6TW1Hs/edit?gid=0#gid=0" target="_blank" class="action-btn btn-sheet">
            <i class="fa-solid fa-file-pen"></i> Edit Data
          </a>
          
          <a href="../index.html" class="action-btn btn-back">
            â† å›åˆ°é …ç›®ç®¡ç†çœ‹æ¿
          </a>

          <button class="theme-toggle" id="themeBtn">â—</button>
      </div>
  </div>

  <div class="sticky-controls-wrapper">
      <div class="controls-grid">
          <div class="filter-group">
              <select id="yearSelect"></select>
          </div>
          <div class="filter-group">
              <select id="filterSupplier"><option value="">å…¨éƒ¨ä¾›æ‡‰å•†</option></select>
          </div>
          <div class="filter-group">
              <select id="filterLine"><option value="">å…¨éƒ¨ç”¢ç·š</option></select>
          </div>
          <div class="filter-group">
              <select id="filterRole"><option value="">å…¨éƒ¨å·¥ç¨®</option></select>
          </div>
          <div class="filter-group search-group">
              <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å§“åã€å·¥ç¨®ã€è·è²¬...">
          </div>
      </div>
  </div>

  <div class="kpi-bar" id="kpiBar"></div>

  <main class="container">

    <div class="project-info-bar">
      <div class="p-item">
        <div class="p-label" style="color:#3182ce;">ğŸ“… è³‡æ–™æ›´æ–°æ—¥æœŸ</div>
        <div class="p-value" id="dataUpdated">-</div>
      </div>
      <div class="p-item">
        <div class="p-label" style="color:#f4d35e;">ğŸ“ é …ç›®åœ°é»</div>
        <div class="p-value" id="projLoc">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">ğŸ é …ç›®å•Ÿå‹•æ—¥</div>
        <div class="p-value" id="projStart">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">ğŸ¯ é …ç›®è¨ˆç•«å®Œæˆæ—¥</div>
        <div class="p-value" id="projEnd">-</div>
      </div>
      <div class="p-item">
        <div class="p-label">â³ é …ç›®å‰©é¤˜å¤©æ•¸</div>
        <div class="p-value" id="projCountdown">-</div>
      </div>
    </div>

    <section class="card">
      <div class="card-header-row">
        <div class="card-title" id="title-role">å·¥ç¨®äººåŠ›åˆ†å¸ƒ</div>
      </div>
      <div class="chart-wrapper">
        <canvas id="roleChart"></canvas>
      </div>
    </section>

    <section class="card">
      <div class="card-header-row">
        <div class="card-title" id="title-gantt">å·¥ä½œç”˜ç‰¹åœ–</div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="gantt-legend" style="display:none;" id="desktopLegend">
                <div class="legend-item"><span class="legend-dot" style="background:var(--status-neutral)"></span>å·²é›¢å´—</div>
                <div class="legend-item"><span class="legend-dot" style="background:var(--status-success)"></span>ç›®å‰åœ¨å´—</div>
                <div class="legend-item"><span class="legend-dot" style="background:var(--status-plan)"></span>è¨ˆç•«å‰å¾€</div>
            </div>
            
            <select id="ganttFilter" style="width: auto; height: 32px; font-size: 12px; border-radius:6px;">
                <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                <option value="active">åƒ…é¡¯ç¤ºåœ¨å´—</option>
            </select>
        </div>
      </div>
      
      <div class="gantt-legend" style="margin-bottom:10px; padding:0 4px;" id="mobileLegend">
          <div class="legend-item"><span class="legend-dot" style="background:var(--status-neutral)"></span>å·²é›¢å´—</div>
          <div class="legend-item"><span class="legend-dot" style="background:var(--status-success)"></span>ç›®å‰åœ¨å´—</div>
          <div class="legend-item"><span class="legend-dot" style="background:var(--status-plan)"></span>è¨ˆç•«å‰å¾€</div>
      </div>

      <div class="gantt-scroll-wrapper">
        <div class="gantt-min-width-container">
            <div class="grid-bg-layer" id="gridBgLayer"></div>
            
            <div class="timeline-header-row">
                <div class="th-name sticky-col-header">äººå“¡ / ç”¢ç·š</div>
                <div class="th-months">
                    <div class="th-month">1æœˆ</div><div class="th-month">2æœˆ</div><div class="th-month">3æœˆ</div>
                    <div class="th-month">4æœˆ</div><div class="th-month">5æœˆ</div><div class="th-month">6æœˆ</div>
                    <div class="th-month">7æœˆ</div><div class="th-month">8æœˆ</div><div class="th-month">9æœˆ</div>
                    <div class="th-month">10æœˆ</div><div class="th-month">11æœˆ</div><div class="th-month">12æœˆ</div>
                </div>
            </div>

            <div id="timelineBody"></div>
        </div>
      </div>
      <div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:8px;">
          (å·¦å³æ»‘å‹•å¯æŸ¥çœ‹å®Œæ•´æ™‚é–“è»¸)
      </div>
    </section>

    <section class="card">
      <div class="card-title" id="title-list" style="margin-bottom: 20px;">è©³ç´°åˆ—è¡¨</div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>ç”¢ç·š</th>
              <th>å§“å</th>
              <th>ç‹€æ…‹</th> <th>ä¾›æ‡‰å•†</th>
              <th>å·¥ç¨®</th>
              <th>è·è²¬</th>
              <th>ç°½è­‰</th>
              <th>åˆ°å´—æ—¥</th>
              <th>é›¢é–‹æ—¥</th>
              <th>ç°½è­‰ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRsvS0O22oXT34Hv9Wt-OBPM4Wixi8CmRsqqaRtZhC7X1diCzK14YFvkwNwUo8H-8MYX3kCNqRjt2md/pub?output=csv";

    const ROLE_COLOR_MAP = {
        "PLC": "#00a99d", "PLCå·¥ç¨‹å¸«": "#00a99d",
        "æ©Ÿå™¨äºº": "#3182ce", "æ©Ÿå™¨äººå·¥ç¨‹å¸«": "#3182ce",
        "é›»å·¥": "#f6ad55",
        "é‰—å·¥": "#e53e3e",
        "ç¾å ´é …ç›®ç¶“ç†": "#805ad5", "é …ç›®ç¶“ç†": "#805ad5",
        "AGV": "#38b2ac",
        "è¦–è¦ºå·¥ç¨‹å¸«": "#d53f8c",
        "MESè»Ÿä»¶å·¥ç¨‹å¸«": "#dd6b20",
        "æ©Ÿæ¢°è¨­è¨ˆ": "#718096", "æ©Ÿæ¢°å·¥ç¨‹å¸«": "#718096",
        "å…¶ä»–": "#cbd5e0"
    };
    
    const FALLBACK_PALETTE = ["#e53e3e", "#dd6b20", "#d69e2e", "#38a169", "#319795", "#3182ce", "#00b5d8", "#805ad5", "#d53f8c"];

    let allRecords = [];
    let projectMeta = { start: null, end: null, location: "", lastUpdated: "" };
    let currentYear = new Date().getFullYear();
    let chartInstance = null;
    const TODAY = new Date();

    document.addEventListener("DOMContentLoaded", async () => {
      if(window.innerWidth > 768) {
          document.getElementById('desktopLegend').style.display = 'flex';
          document.getElementById('mobileLegend').style.display = 'none';
      }
      await fetchData();
      setupEvents();
    });

    async function fetchData() {
      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        parseCsv(text);
        renderYearSelect();
        renderFilters(); 
        renderAll(currentYear);
      } catch (err) {
        console.error(err);
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ CSV é€£çµ");
      }
    }

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      allRecords = [];
      projectMeta = { start: null, end: null, location: "", lastUpdated: "" };

      let foundMeta = false;
      for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
          
          if (!foundMeta && cols.length >= 10 && cols[9]) {
              const potentialDate = new Date(cols[9]);
              if (!isNaN(potentialDate.getTime())) {
                  projectMeta.start = potentialDate;
                  if (cols[10]) projectMeta.end = new Date(cols[10]);
                  if (cols[11]) projectMeta.location = cols[11];
                  if (cols[12]) projectMeta.lastUpdated = cols[12];
                  foundMeta = true; 
              }
          }

          if (cols.length < 7) continue; 
          
          const arrival = new Date(cols[6]);
          if (isNaN(arrival.getTime())) continue;

          allRecords.push({
            supplier: cols[0], name: cols[1], role: cols[2], duty: cols[3] || "-", 
            line: cols[4], visaType: cols[5] || "-", 
            arrivalDate: arrival,
            leaveDate: cols[7] ? new Date(cols[7]) : null, 
            visaExpiry: new Date(cols[8]), 
            year: arrival.getFullYear()
          });
      }
    }

    function renderFilters() {
        const supplierSet = new Set(), lineSet = new Set(), roleSet = new Set();
        allRecords.forEach(d => {
            if(d.supplier) supplierSet.add(d.supplier);
            if(d.line) lineSet.add(d.line);
            if(d.role) roleSet.add(d.role);
        });
        populateSelect('filterSupplier', supplierSet);
        populateSelect('filterLine', lineSet);
        populateSelect('filterRole', roleSet);
    }

    function populateSelect(id, set) {
        const sel = document.getElementById(id);
        const currentVal = sel.value;
        sel.innerHTML = sel.options[0].outerHTML; 
        [...set].sort().forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val;
            sel.appendChild(opt);
        });
        sel.value = currentVal;
    }

    function renderAll(year) {
      renderProjectInfo();
      const yearData = allRecords.filter(r => r.year == year);
      const filtered = applyFilters(yearData);
      const activePeople = filtered.filter(d => 
        d.arrivalDate <= TODAY && (d.leaveDate === null || d.leaveDate >= TODAY)
      );

      // Dynamic Title Prefix
      const s = document.getElementById('filterSupplier').value;
      const l = document.getElementById('filterLine').value;
      const r = document.getElementById('filterRole').value;
      let titlePrefix = "";
      if (s) titlePrefix += s + " ";
      if (l) titlePrefix += l + " ";
      if (r) titlePrefix += r + " ";
      
      document.getElementById('title-role').textContent = titlePrefix + "å·¥ç¨®äººåŠ›åˆ†å¸ƒ";
      document.getElementById('title-gantt').textContent = titlePrefix + "å·¥ä½œç”˜ç‰¹åœ–";
      document.getElementById('title-list').textContent = titlePrefix + "è©³ç´°åˆ—è¡¨";

      renderKpiBar(activePeople, titlePrefix);
      renderChart(activePeople);   
      renderTimeline(filtered, year); 
      renderTable(filtered); 
      renderBackgroundGrid(year);
    }

    function renderProjectInfo() {
      document.getElementById('projLoc').textContent = projectMeta.location || "-";
      document.getElementById('dataUpdated').textContent = projectMeta.lastUpdated || "-";
      document.getElementById('projStart').textContent = projectMeta.start ? projectMeta.start.toLocaleDateString() : "-";
      document.getElementById('projEnd').textContent = projectMeta.end ? projectMeta.end.toLocaleDateString() : "-";
      
      const pCount = document.getElementById('projCountdown');
      if (projectMeta.end) {
         const diff = Math.ceil((projectMeta.end - TODAY) / (1000 * 60 * 60 * 24));
         if (diff < 0) pCount.innerHTML = `<span style="color:var(--status-danger)">é€¾æœŸ ${Math.abs(diff)} å¤©</span>`;
         else pCount.textContent = `${diff} å¤©`;
      } else {
         pCount.textContent = "-";
      }
    }

    function renderKpiBar(activeData, prefix = "") {
      const container = document.getElementById('kpiBar');
      container.innerHTML = "";
      
      const warningDate = new Date(); warningDate.setDate(TODAY.getDate() + 30);
      const visaWarning = activeData.filter(d => d.visaExpiry > TODAY && d.visaExpiry <= warningDate).length;
      const visaExpired = activeData.filter(d => d.visaExpiry < TODAY).length;

      const kpis = [
        { title: `${prefix}ç›®å‰åœ¨å´—`, val: `${activeData.length} <span style='font-size:12px'>äºº</span>`, color: "var(--status-success)" },
        { title: `${prefix}ç°½è­‰å³å°‡åˆ°æœŸ`, val: `${visaWarning} <span style='font-size:12px'>äºº</span>`, color: "var(--status-warning)" },
        { title: `${prefix}ç°½è­‰å·²éæœŸ`, val: `${visaExpired} <span style='font-size:12px'>äºº</span>`, color: "var(--status-danger)" }
      ];

      kpis.forEach(k => {
        container.innerHTML += `
          <div class="kpi-card" style="--kpi-color: ${k.color}">
            <div class="kpi-info"><div class="kpi-title">${k.title}</div><div class="kpi-val" style="color:${k.color}">${k.val}</div></div>
          </div>`;
      });
    }

    function renderChart(activeData) {
      const ctx = document.getElementById('roleChart').getContext('2d');
      const roleCounts = {};
      activeData.forEach(d => roleCounts[d.role] = (roleCounts[d.role] || 0) + 1);

      const labels = Object.keys(roleCounts);
      const data = Object.values(roleCounts);
      const bgColors = labels.map((role, idx) => {
          return ROLE_COLOR_MAP[role] || FALLBACK_PALETTE[idx % FALLBACK_PALETTE.length];
      });

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'äººæ•¸',
            data: data,
            backgroundColor: bgColors, 
            borderRadius: 6,
            maxBarThickness: 40 
          }]
        },
        options: {
          indexAxis: 'y', 
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });
    }

    function renderBackgroundGrid(year) {
        const layer = document.getElementById('gridBgLayer');
        layer.innerHTML = ""; 
        for(let i=0; i<12; i++) {
            const div = document.createElement('div');
            div.className = 'grid-line';
            layer.appendChild(div);
        }
        if (year == TODAY.getFullYear()) {
            const pct = ((TODAY - new Date(year, 0, 1)) / (365 * 86400000)) * 100;
            if (pct >= 0 && pct <= 100) {
                const line = document.createElement('div');
                line.className = 'today-line';
                line.style.left = `${pct}%`;
                layer.appendChild(line);
            }
        }
    }

    function renderTimeline(data, year) {
      const body = document.getElementById('timelineBody');
      body.innerHTML = "";
      const filterMode = document.getElementById('ganttFilter').value; 
      
      const groups = {};
      data.forEach(d => { if(!groups[d.name]) groups[d.name] = []; groups[d.name].push(d); });

      Object.keys(groups).sort().forEach(name => {
        const records = groups[name];
        const lastRec = records[records.length-1]; 
        const isActive = lastRec.arrivalDate <= TODAY && (lastRec.leaveDate === null || lastRec.leaveDate >= TODAY);

        if (filterMode === 'active' && !isActive) return;

        const row = document.createElement('div');
        row.className = 'person-row';
        row.innerHTML = `<div class="person-name sticky-col-cell">${name}<div class="person-role">${records[0].role}</div></div>`;

        const barsArea = document.createElement('div');
        barsArea.className = 'person-bars-area';

        records.forEach(trip => {
          let statusClass = "status-active";
          let endDate = trip.leaveDate;
          
          if (trip.arrivalDate > TODAY) statusClass = "status-plan";
          else if (trip.leaveDate && trip.leaveDate < TODAY) statusClass = "status-past";
          
          if (!endDate) endDate = (trip.arrivalDate > TODAY) ? new Date(year, 11, 31) : TODAY;

          const startPct = Math.max(0, ((trip.arrivalDate - new Date(year, 0, 1)) / (365 * 86400000)) * 100);
          const widthPct = Math.min(100 - startPct, ((endDate - trip.arrivalDate) / (365 * 86400000)) * 100);
          
          if (widthPct > 0) {
            const bar = document.createElement('div');
            bar.className = `gantt-bar ${statusClass}`;
            bar.style.left = startPct + '%';
            bar.style.width = widthPct + '%';
            bar.title = `${name} (${trip.role})\nè·è²¬: ${trip.duty}\nç°½è­‰: ${trip.visaType}\næ—¥æœŸ: ${trip.arrivalDate.toLocaleDateString()} ~ ${trip.leaveDate ? trip.leaveDate.toLocaleDateString() : 'å°šæœªå®š'}`;
            barsArea.appendChild(bar);
          }
        });
        row.appendChild(barsArea);
        body.appendChild(row);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";

      data.sort((a,b) => a.arrivalDate - b.arrivalDate).forEach(d => {
        const tr = document.createElement('tr');
        const daysToVisa = Math.ceil((d.visaExpiry - TODAY) / 86400000);
        let visaTag = daysToVisa < 0 ? `<span class="tag tag-expired">éæœŸ</span>` : 
                      daysToVisa <= 30 ? `<span class="tag tag-warning">å‰©${daysToVisa}å¤©</span>` : 
                      `<span class="tag tag-normal">æ­£å¸¸</span>`;
        
        // ğŸŸ¢ æ–°å¢ï¼šç‹€æ…‹åˆ¤æ–·é‚è¼¯
        let statusHtml = '';
        if (d.leaveDate && d.leaveDate < TODAY) {
            statusHtml = '<span class="status-badge badge-past">å·²é›¢å´—</span>';
        } else if (d.arrivalDate > TODAY) {
            statusHtml = '<span class="status-badge badge-plan">è¨ˆç•«ä¸­</span>';
        } else {
            statusHtml = '<span class="status-badge badge-active">é€²è¡Œä¸­</span>';
        }

        tr.innerHTML = `
          <td><span style="font-weight:600;color:var(--text-muted)">${d.line}</span></td>
          <td><strong>${d.name}</strong></td>
          <td>${statusHtml}</td> <td>${d.supplier}</td>
          <td>${d.role}</td>
          <td>${d.duty}</td> <td><span class="tag-visa">${d.visaType}</span></td> <td>${d.arrivalDate.toLocaleDateString()}</td>
          <td>${d.leaveDate ? d.leaveDate.toLocaleDateString() : 'åœ¨è·'}</td>
          <td>${visaTag}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters(data) {
      const s = document.getElementById('filterSupplier').value;
      const l = document.getElementById('filterLine').value;
      const r = document.getElementById('filterRole').value;
      const q = document.getElementById('searchInput').value.toLowerCase();
      return data.filter(d => 
        (s===""||d.supplier===s) && (l===""||d.line===l) && (r===""||d.role===r) &&
        (q===""||d.name.toLowerCase().includes(q)||d.role.toLowerCase().includes(q)||d.duty.toLowerCase().includes(q))
      );
    }

    function renderYearSelect() {
      const sel = document.getElementById('yearSelect');
      const years = [...new Set(allRecords.map(r=>r.year))].sort((a,b)=>b-a);
      if(years.length === 0) years.push(currentYear);
      sel.innerHTML = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
      sel.value = currentYear;
    }

    function setupEvents() {
      ['yearSelect', 'filterSupplier', 'filterLine', 'filterRole', 'searchInput'].forEach(id => {
          document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', (e) => {
              if (id === 'yearSelect') currentYear = e.target.value;
              renderAll(currentYear);
          });
      });
      document.getElementById('ganttFilter').addEventListener('change', () => renderTimeline(applyFilters(allRecords.filter(r=>r.year==currentYear)), currentYear));
      document.getElementById('themeBtn').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      });
    }
  </script>
</body>
</html>