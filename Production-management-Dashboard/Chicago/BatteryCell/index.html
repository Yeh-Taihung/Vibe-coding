<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>èŠåŠ å“¥-é›»èŠ¯ç”¢ç·šç¸½æ§çœ‹æ¿ v55 | Master Gantt Rich Tooltip</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* --------- 1. Theme Variables --------- */
    :root {
      --color-primary: #008080;      
      --color-primary-light: #E6FFFA;
      
      --status-active: #F6AD55;     
      --status-done: #48BB78;       
      --status-blocked: #F56565;    
      
      --bg-body: #F7FAFC;            
      --bg-card: #FFFFFF;
      --text-main: #2D3748;          
      --text-muted: #718096;         
      --border-light: #E2E8F0;

      --shadow-card: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius-card: 8px;
    }

    [data-theme="dark"] {
      --bg-body: #1A202C;
      --bg-card: #2D3748;
      --text-main: #F7FAFC;
      --text-muted: #A0AEC0;
      --border-light: #4A5568;
    }

    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Inter', 'Noto Sans TC', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-main); 
      padding-bottom: 60px;
    }

    /* --------- 2. Header --------- */
    .brand-bar {
        padding: 12px 24px; 
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-light);
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .logo-area { display: flex; align-items: center; gap: 12px; }
    .logo-icon { font-size: 24px; color: var(--color-primary); }
    .logo-titles { display: flex; flex-direction: column; }
    .logo-main { font-size: 18px; font-weight: 700; color: var(--color-primary); }
    .logo-sub { font-size: 12px; color: var(--text-muted); }

    .brand-actions { display: flex; gap: 12px; align-items: center; }
    
    .action-btn { 
        padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; 
        text-decoration: none; color: var(--text-muted); transition: 0.2s;
        display: flex; align-items: center; gap: 6px; cursor: pointer;
        border: 1px solid transparent;
    }
    .action-btn:hover { background: #EDF2F7; color: var(--text-main); }
    .btn-green { background: #E6FFFA; color: #2C7A7B; border: 1px solid #B2F5EA; }
    .btn-green:hover { background: #B2F5EA; }

    /* --------- 3. Controls --------- */
    .sticky-controls {
        position: sticky; top: 0; z-index: 999;
        background: rgba(247, 250, 252, 0.95); backdrop-filter: blur(5px);
        border-bottom: 1px solid var(--border-light); padding: 12px 24px;
    }
    .controls-container { 
        max-width: 1400px; margin: 0 auto; 
        display: flex; gap: 12px; flex-wrap: wrap; align-items: center; 
    }
    .filter-group { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    
    .select-wrap select {
        padding: 6px 12px; border-radius: 6px;
        border: 1px solid var(--border-light); background: var(--bg-card);
        color: var(--text-main); font-size: 13px; min-width: 100px;
    }
    .filter-label { font-size: 11px; font-weight: 700; color: var(--color-primary); text-transform: uppercase; margin-right: 4px;}

    .nav-tabs { display: flex; gap: 4px; margin-left: auto; }
    .nav-btn {
        padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;
        border: none; background: transparent; color: var(--text-muted); cursor: pointer;
    }
    .nav-btn.active { background: var(--color-primary); color: white; }

    /* --------- 4. Layout --------- */
    .main-container { max-width: 1400px; margin: 24px auto; padding: 0 24px; }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .kpi-card-v2 {
        background: var(--bg-card); border: 1px solid var(--border-light); border-left-width: 5px; 
        border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
        box-shadow: var(--shadow-card);
    }
    .kpi-header { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; }
    .kpi-value-big { font-size: 32px; font-weight: 700; color: var(--text-main); line-height: 1; }
    .kpi-green { border-left-color: #38B2AC; } .kpi-green .kpi-header { color: #38B2AC; }
    .kpi-orange { border-left-color: #ED8936; } .kpi-orange .kpi-header { color: #ED8936; }
    .kpi-red { border-left-color: #E53E3E; } .kpi-red .kpi-header { color: #E53E3E; }

    .card {
        background: var(--bg-card); border-radius: var(--radius-card); padding: 20px; 
        margin-bottom: 24px; border: 1px solid var(--border-light); box-shadow: var(--shadow-card);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .card-title { font-size: 16px; font-weight: 700; border-left: 4px solid var(--color-primary); padding-left: 10px; }

    /* Gantt Structure */
    :root {
        --w-col-sec: 70px; 
        --w-col-proc: 90px; 
        --w-col-zone: 70px; 
        --w-col-owner: 70px; 
        --w-col-man: 140px; 
    }
    .gantt-wrapper { border: 1px solid var(--border-light); border-radius: 6px; overflow: hidden; display: flex; flex-direction: column; }
    .gantt-row { display: flex; border-bottom: 1px solid var(--border-light); background: var(--bg-card); height: 32px; min-width: fit-content; }
    
    .sticky-cell {
        position: sticky; z-index: 10; background: var(--bg-card);
        display: flex; align-items: center; padding: 0 8px; 
        font-size: 13px; border-right: 1px solid var(--border-light); flex-shrink: 0;
        justify-content: center; text-align: center; white-space: nowrap;
    }
    .gantt-header .sticky-cell { background: #F7FAFC; font-weight: 700; color: var(--text-muted); font-size: 12px; }

    .col-section { width: var(--w-col-sec); left: 0; font-weight: 600; color: var(--color-primary); }
    .col-process { width: var(--w-col-proc); left: var(--w-col-sec); font-weight: 600; }
    .col-zone    { width: var(--w-col-zone); left: calc(var(--w-col-sec) + var(--w-col-proc)); color: var(--text-muted); font-size: 12px;}
    .col-owner   { width: var(--w-col-owner); left: calc(var(--w-col-sec) + var(--w-col-proc) + var(--w-col-zone)); border-right: 2px solid var(--border-light); }

    .timeline-cell { flex-grow: 1; position: relative; min-width: 900px; }
    .timeline-months { display: grid; grid-template-columns: repeat(12, 1fr); height: 100%; background: #F7FAFC; }
    .month-item { display: flex; align-items: center; justify-content: center; border-right: 1px dashed var(--border-light); font-size: 12px; color: var(--text-muted); }
    .timeline-grid { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(12, 1fr); pointer-events: none; }
    .grid-line { border-right: 1px dashed var(--border-light); height: 100%; }

    /* Master Gantt Bars */
    .bar-plan {
        position: absolute; height: 18px; top: 7px; 
        background: repeating-linear-gradient(45deg, #E2E8F0, #E2E8F0 5px, #CBD5E0 5px, #CBD5E0 10px);
        border-radius: 0 6px 6px 0; opacity: 0.5; z-index: 1;
        cursor: pointer;
    }
    .bar-actual {
        position: absolute; height: 12px; top: 10px; border-radius: 0 4px 4px 0; 
        z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    .stage-platform { background: #4299E1; } 
    .stage-equip    { background: #48BB78; } 
    .stage-single   { background: #ED8936; } 
    .stage-material { background: #9F7AEA; } 
    .stage-default  { background: #A0AEC0; }
    
    .gantt-bar-container:hover .bar-actual { transform: scaleY(1.1); transition: 0.2s; z-index: 5;}
    
    .today-marker { position: absolute; top: 0; bottom: 0; border-left: 2px dashed #E53E3E; z-index: 30; pointer-events: none; }

    /* Manpower Specific Styles */
    .bar-manpower {
        position: absolute; 
        height: 20px; 
        top: 6px;     
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 5;
        cursor: pointer; 
        transition: opacity 0.2s;
    }
    .bar-manpower:hover { opacity: 0.9; }

    .mp-active { background-color: #319795; } /* Teal */
    .mp-left { background-color: #CBD5E0; }   /* Gray */
    .mp-planned { background-color: #63B3ED; } /* Blue */

    /* Custom Tooltip Style */
    #gantt-tooltip {
        position: fixed; 
        display: none;
        background: #FFFFFF;
        border: 1px solid #E2E8F0;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        padding: 12px;
        border-radius: 8px;
        z-index: 9999;
        pointer-events: none;
        font-size: 13px;
        color: #2D3748;
        min-width: 220px;
    }
    #gantt-tooltip h4 { margin: 0 0 8px 0; font-size: 14px; color: #1A202C; border-bottom: 1px solid #E2E8F0; padding-bottom: 6px;}
    #gantt-tooltip .tt-row { display: flex; justify-content: space-between; margin-bottom: 4px; gap: 12px; }
    #gantt-tooltip .tt-label { color: #718096; white-space: nowrap;}
    #gantt-tooltip .tt-val { font-weight: 600; text-align: right; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px; background: #F7FAFC; color: var(--text-muted); white-space: nowrap; }
    td { padding: 10px; border-top: 1px solid var(--border-light); white-space: nowrap;}
    .tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; }
    .tag-green { background: #C6F6D5; color: #22543D; }
    .tag-gray { background: #EDF2F7; color: #718096; }
    .tag-blue { background: #EBF8FF; color: #2B6CB0; }

    .overflow-x-auto { overflow-x: auto; }

    /* DEBUG PANEL */
    #debugPanel {
        margin-top: 40px; padding: 20px; background: #2D3748; color: #A0AEC0; 
        font-family: monospace; font-size: 12px; border-radius: 8px;
        white-space: pre-wrap; 
    }
  </style>
</head>
<body>

  <div id="gantt-tooltip"></div>

  <header class="brand-bar">
    <div class="logo-area">
      <i class="fa-solid fa-industry logo-icon"></i>
      <div class="logo-titles">
          <div class="logo-main">èŠåŠ å“¥-é›»èŠ¯ç”¢ç·šç¸½æ§çœ‹æ¿</div>
          <div class="logo-sub">Chicago Battery Cell Master Schedule v55</div>
      </div>
    </div>
    <div class="brand-actions">
        <a href="https://docs.google.com/spreadsheets/d/1HFUFC8GZd08h4dcmKPJTp-q5ogtr-bmF4hovGTnAHmo/edit" target="_blank" class="action-btn btn-green">
         <i class="fa-solid fa-file-pen"></i> ç·¨è¼¯è³‡æ–™
       </a>
       <a href="../index.html" class="action-btn">
         <i class="fa-solid fa-reply"></i> å›åˆ°èŠåŠ å“¥é¸å–®
       </a>
       <button class="action-btn" id="themeBtn" style="width:36px; padding:8px;">
         <i class="fa-solid fa-moon"></i>
       </button>
    </div>
  </header>

  <div class="sticky-controls">
    <div class="controls-container">
        <div class="filter-group">
            <div class="select-wrap"><select id="yearSelect"></select></div>
        </div>
        <div style="width: 1px; height: 20px; background: var(--border-light); margin: 0 4px;"></div>
        <div class="filter-group">
            <span class="filter-label">ç‹€æ…‹:</span>
            <div class="select-wrap">
                <select id="filterStatus">
                    <option value="" selected>å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="active">ç›®å‰åœ¨å´—</option>
                    <option value="planned">è¨ˆç•«ä¸­</option>
                    <option value="left">å·²é›¢å´—</option>
                </select>
            </div>
        </div>
        <div class="filter-group">
            <span class="filter-label">ç¸½æ§:</span>
            <div class="select-wrap"><select id="filterSection"><option value="">æ‰€æœ‰å·¥æ®µ</option></select></div>
            <div class="select-wrap"><select id="filterProcess"><option value="">æ‰€æœ‰å·¥åº</option></select></div>
        </div>
        <div class="filter-group">
            <span class="filter-label">äººåŠ›:</span>
            <div class="select-wrap"><select id="filterRole"><option value="">æ‰€æœ‰å·¥ç¨®</option></select></div>
            <div class="select-wrap"><select id="filterName"><option value="">å…¨éƒ¨äººå“¡</option></select></div>
        </div>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="scrollToSection('chart')">åœ–è¡¨</button>
            <button class="nav-btn" onclick="scrollToSection('master')">ç¸½æ§</button>
            <button class="nav-btn" onclick="scrollToSection('manpower')">äººåŠ›</button>
            <button class="nav-btn" onclick="scrollToSection('list')">æ¸…å–®</button>
        </div>
    </div>
  </div>

  <main class="main-container">

    <div class="kpi-grid" id="kpiContainer"></div>

    <section id="section-chart" class="card">
        <div class="card-header"><div class="card-title">å·¥ç¨®äººåŠ›åˆ†å¸ƒ</div></div>
        <div style="height: 200px; width: 100%;"><canvas id="roleChart"></canvas></div>
    </section>

    <section id="section-master" class="card">
        <div class="card-header">
            <div class="card-title">å®‰è£ç¸½æ§ç”˜ç‰¹åœ– (Master Schedule)</div>
            <div style="font-size: 11px; display: flex; gap: 8px;">
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#4299E1; border-radius:2px"></span>å¹³å°å®‰è£</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#48BB78; border-radius:2px"></span>è¨­å‚™å®‰è£</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#ED8936; border-radius:2px"></span>å–®æ©Ÿèª¿è©¦</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#9F7AEA; border-radius:2px"></span>å¸¶æ–™èª¿è©¦</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#CBD5E0; border-radius:2px"></span>è¨ˆç•«æ™‚é–“</span>
            </div>
        </div>
        <div class="gantt-wrapper overflow-x-auto">
            <div class="gantt-row gantt-header" style="height: 32px;">
                <div class="sticky-cell col-section">å·¥æ®µ</div>
                <div class="sticky-cell col-process">å·¥åº</div>
                <div class="sticky-cell col-zone">å€åŸŸ</div>
                <div class="sticky-cell col-owner">å–®ä½</div>
                <div class="timeline-cell">
                    <div class="timeline-months">
                        <div class="month-item">1æœˆ</div><div class="month-item">2æœˆ</div><div class="month-item">3æœˆ</div>
                        <div class="month-item">4æœˆ</div><div class="month-item">5æœˆ</div><div class="month-item">6æœˆ</div>
                        <div class="month-item">7æœˆ</div><div class="month-item">8æœˆ</div><div class="month-item">9æœˆ</div>
                        <div class="month-item">10æœˆ</div><div class="month-item">11æœˆ</div><div class="month-item">12æœˆ</div>
                    </div>
                </div>
            </div>
            <div id="masterGanttBody"></div>
        </div>
    </section>

    <section id="section-manpower" class="card">
        <div class="card-header">
            <div class="card-title">äººåŠ›æŠ•å…¥ç”˜ç‰¹åœ–</div>
            <div style="font-size: 11px; display: flex; gap: 12px; margin-right: 10px;">
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#CBD5E0; border-radius:2px"></span>å·²é›¢å´—</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#319795; border-radius:2px"></span>ç›®å‰åœ¨å´—</span>
                <span style="display:flex; align-items:center; gap:4px;"><span style="width:10px; height:10px; background:#63B3ED; border-radius:2px"></span>è¨ˆç•«å‰å¾€</span>
            </div>
        </div>
        <div class="gantt-wrapper overflow-x-auto">
             <div class="gantt-row gantt-header" style="height: 32px;">
                <div class="sticky-cell" style="width: var(--w-col-man); left:0; border-right: 2px solid var(--border-light); justify-content: flex-start; padding-left: 15px;">äººå“¡ / å·¥ç¨®</div>
                <div class="timeline-cell">
                    <div class="timeline-months">
                        <div class="month-item">1æœˆ</div><div class="month-item">2æœˆ</div><div class="month-item">3æœˆ</div>
                        <div class="month-item">4æœˆ</div><div class="month-item">5æœˆ</div><div class="month-item">6æœˆ</div>
                        <div class="month-item">7æœˆ</div><div class="month-item">8æœˆ</div><div class="month-item">9æœˆ</div>
                        <div class="month-item">10æœˆ</div><div class="month-item">11æœˆ</div><div class="month-item">12æœˆ</div>
                    </div>
                </div>
             </div>
             <div id="manpowerBody"></div>
        </div>
    </section>

    <section id="section-list" class="card">
        <div class="card-title" style="margin-bottom: 16px;">è©³ç´°äººå“¡æ¸…å–®</div>
        <div class="overflow-x-auto">
            <table>
                <thead><tr><th>å§“å</th><th>å·¥ç¨®</th><th>ä¾›æ‡‰å•†</th><th>è¨ˆç•«åˆ°å´—</th><th>å¯¦éš›åˆ°å´—</th><th>é è¨ˆé›¢å´—</th><th>ç°½è­‰åˆ°æœŸ</th><th>ç‹€æ…‹</th></tr></thead>
                <tbody id="listBody"></tbody>
            </table>
        </div>
    </section>

    <div id="debugPanel">
        <h3>ğŸ”§ è³‡æ–™é™¤éŒ¯è³‡è¨Š (Debug Info)</h3>
        <div id="debugOutput">è®€å–ä¸­...</div>
    </div>

  </main>

  <script>
    const CSV_URL_MANPOWER = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKQd6NZRtyoDpbIgwFo_fU4Erzd4oTPNlKKlk7oNhsOXRUOSJbm8km2HY76349TypTw_ME98ZLV_J/pub?gid=0&single=true&output=csv";
    const CSV_URL_TASK = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSrKQd6NZRtyoDpbIgwFo_fU4Erzd4oTPNlKKlk7oNhsOXRUOSJbm8km2HY76349TypTw_ME98ZLV_J/pub?gid=389207647&single=true&output=csv";

    let taskData = [];
    let manpowerData = [];
    const TODAY = new Date(); TODAY.setHours(0,0,0,0);
    let selectedYear = new Date().getFullYear();
    let chartInstance = null;

    document.addEventListener("DOMContentLoaded", async () => {
        await fetchData();
        setupControls();
        renderAll();
    });

    // --- CSV Parser ---
    function parseCSV(text) {
        const rows = [];
        let currentRow = [];
        let currentCell = '';
        let insideQuotes = false;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];
            
            if (char === '"') {
                if (insideQuotes && nextChar === '"') {
                    currentCell += '"';
                    i++; 
                } else {
                    insideQuotes = !insideQuotes;
                }
            } else if (char === ',' && !insideQuotes) {
                currentRow.push(currentCell.trim());
                currentCell = '';
            } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                if (char === '\r' && nextChar === '\n') i++;
                currentRow.push(currentCell.trim());
                if (currentRow.length > 0) rows.push(currentRow);
                currentRow = [];
                currentCell = '';
            } else {
                currentCell += char;
            }
        }
        if (currentCell || currentRow.length > 0) {
            currentRow.push(currentCell.trim());
            rows.push(currentRow);
        }
        return rows;
    }

    function findColIndex(headers, possibleNames) {
        if(!headers) return -1;
        const lowerHeaders = headers.map(h => h.toLowerCase().replace(/[\r\n]/g, '').trim());
        for (const name of possibleNames) {
            const idx = lowerHeaders.findIndex(h => h.includes(name.toLowerCase()));
            if (idx !== -1) return idx;
        }
        return -1;
    }

    async function fetchData() {
        try {
            const timestamp = new Date().getTime();
            const [resMp, resTask] = await Promise.all([ 
                fetch(CSV_URL_MANPOWER + "&t=" + timestamp), 
                fetch(CSV_URL_TASK + "&t=" + timestamp) 
            ]);
            
            if(!resMp.ok || !resTask.ok) throw new Error("ç¶²è·¯è«‹æ±‚å¤±æ•—");

            const mpText = await resMp.text();
            const taskText = await resTask.text();

            manpowerData = parseSmartData(mpText, 'manpower');
            taskData = parseSmartData(taskText, 'task');
            
            // Auto Set Year
            const allYears = [...taskData, ...manpowerData].map(d => d.year).filter(y => !isNaN(y));
            const yearCounts = {};
            allYears.forEach(y => { yearCounts[y] = (yearCounts[y] || 0) + 1; });
            
            let maxCount = 0;
            let bestYear = new Date().getFullYear();
            Object.keys(yearCounts).forEach(y => {
                if(yearCounts[y] > maxCount) { maxCount = yearCounts[y]; bestYear = parseInt(y); }
            });
            if(allYears.length > 0) selectedYear = bestYear;

            document.getElementById('debugOutput').innerHTML = `
                <b>Manpower Loaded:</b> ${manpowerData.length} rows<br/>
                <b>Tasks Loaded:</b> ${taskData.length} rows<br/>
                <b>Detected Year:</b> ${selectedYear}<br/>
                <span style="color:#48BB78">è³‡æ–™è§£ææˆåŠŸ (V55 Rich Master Tooltip)</span>
            `;

            populateFilters();
        } catch (e) {
            console.error("Data load failed", e);
            document.getElementById('debugOutput').innerText = "éŒ¯èª¤: " + e.message;
        }
    }

    function parseSmartData(text, type) {
        const rows = parseCSV(text); 
        if(rows.length < 2) return [];

        const headers = rows[0];
        let map = {};
        if (type === 'task') {
            map = {
                section: findColIndex(headers, ['å·¥æ®µ', 'stage']),
                process: findColIndex(headers, ['å·¥åº', 'process']),
                zone: findColIndex(headers, ['å€åŸŸ', 'zone']),
                task: findColIndex(headers, ['ä»»å‹™', 'task']),
                planStart: findColIndex(headers, ['è¨ˆç•«é–‹å§‹', 'forecast start', 'forecaststart']), 
                planEnd: findColIndex(headers, ['è¨ˆç•«çµæŸ', 'forecast end', 'forecastend']),
                actualStart: findColIndex(headers, ['å¯¦éš›é–‹å§‹', 'plan start', 'planstart']),     
                actualEnd: findColIndex(headers, ['å¯¦éš›çµæŸ', 'plan end', 'planend']),
                owner: findColIndex(headers, ['å–®ä½', 'owner']),
                status: findColIndex(headers, ['ç‹€æ…‹', 'status']),
                // Added status description (Column K)
                statusDesc: findColIndex(headers, ['ç‹€æ…‹æè¿°', 'status description', 'note'])
            };
        } else {
            map = {
                supplier: findColIndex(headers, ['ä¾›æ‡‰å•†', 'supplier']),
                name: findColIndex(headers, ['å§“å', 'name']),
                role: findColIndex(headers, ['å·¥ç¨®', 'role']),
                duty: findColIndex(headers, ['è·è²¬', 'duty']), 
                visaType: findColIndex(headers, ['ç°½è­‰', 'visa type']), 
                arrival: findColIndex(headers, ['åˆ°å´—æ—¥', 'arrivaldata', 'arrival']), 
                plannedArrival: findColIndex(headers, ['è¨ˆç•«åˆ°å´—', 'planned arrival']), 
                planLeave: findColIndex(headers, ['é è¨ˆé›¢å´—', 'planned leave']),
                actualLeave: findColIndex(headers, ['å¯¦éš›é›¢å´—', 'actual leave']),
                visaExp: findColIndex(headers, ['ç°½è­‰', 'visaexpiry', 'visa'])
            };
        }

        const result = [];
        for(let i=1; i<rows.length; i++) {
            const cols = rows[i];
            if(cols.length < 3) continue;

            if(type === 'task') {
                const idxSection = map.section > -1 ? map.section : 0;
                const idxProcess = map.process > -1 ? map.process : 1;
                const pStart = safeDate(cols[map.planStart]);
                
                result.push({
                    section: cols[idxSection], 
                    process: cols[idxProcess], 
                    zone: map.zone>-1 ? cols[map.zone] : '', 
                    task: map.task>-1 ? cols[map.task] : '',
                    planStart: pStart,
                    planEnd: safeDate(cols[map.planEnd]),
                    actualStart: safeDate(cols[map.actualStart]),
                    actualEnd: safeDate(cols[map.actualEnd]),
                    owner: map.owner>-1 ? cols[map.owner] : '',
                    status: map.status>-1 ? cols[map.status] : '',
                    // Capture status description
                    statusDesc: map.statusDesc>-1 ? cols[map.statusDesc] : '',
                    year: pStart ? pStart.getFullYear() : 2026 
                });
            } else {
                if (map.name === -1 && cols.length > 2) {
                     map.name = 1; map.role = 2; map.arrival = 6;
                }
                
                const arrival = safeDate(cols[map.arrival]);
                const pArrival = safeDate(cols[map.plannedArrival]);

                result.push({
                    supplier: map.supplier>-1 ? cols[map.supplier] : '', 
                    name: cols[map.name], 
                    role: map.role>-1 ? cols[map.role] : '', 
                    duty: map.duty>-1 ? cols[map.duty] : '', 
                    visaType: map.visaType>-1 ? cols[map.visaType] : '', 
                    arrival: arrival,
                    plannedArrival: pArrival, 
                    planLeave: safeDate(cols[map.planLeave]),
                    actualLeave: safeDate(cols[map.actualLeave]),
                    visaExp: safeDate(cols[map.visaExp]),
                    year: (arrival || pArrival) ? (arrival || pArrival).getFullYear() : 2026
                });
            }
        }
        return result;
    }

    function safeDate(str) {
        if(!str) return null;
        const d = new Date(str);
        return isNaN(d.getTime()) ? null : d;
    }

    function getStageClass(taskName) {
        if(!taskName) return 'stage-default';
        if(taskName.includes('å¹³å°å®‰è£')) return 'stage-platform';
        if(taskName.includes('è¨­å‚™å®‰è£')) return 'stage-equip';
        if(taskName.includes('å–®æ©Ÿèª¿è©¦')) return 'stage-single';
        if(taskName.includes('å¸¶æ–™èª¿è©¦')) return 'stage-material';
        return 'stage-default';
    }

    // --- Updated Master Gantt Render with Tooltips ---
    function renderMasterGantt(data) {
        const container = document.getElementById('masterGanttBody');
        container.innerHTML = "";
        const tooltip = document.getElementById('gantt-tooltip');
        
        if(data.length === 0) { 
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#718096;">ç„¡ä»»å‹™è³‡æ–™ (è«‹æª¢æŸ¥å¹´ä»½æˆ–ç¯©é¸)</div>'; 
            return; 
        }

        const groups = {};
        data.forEach(task => {
            const key = (task.section||'') + '|' + (task.process||''); 
            if(!groups[key]) groups[key] = [];
            groups[key].push(task);
        });

        Object.keys(groups).forEach(key => {
            const tasks = groups[key];
            const first = tasks[0]; 

            const row = document.createElement('div');
            row.className = 'gantt-row';
            row.style.height = '32px'; 
            
            row.innerHTML = `
                <div class="sticky-cell col-section">${first.section}</div>
                <div class="sticky-cell col-process">${first.process}</div>
                <div class="sticky-cell col-zone">${first.zone || '-'}</div>
                <div class="sticky-cell col-owner">${first.owner || '-'}</div>
            `;
            
            const timeline = document.createElement('div');
            timeline.className = 'timeline-cell';
            
            const grid = document.createElement('div');
            grid.className = 'timeline-grid';
            for(let i=0; i<12; i++) grid.appendChild(document.createElement('div')).className = 'grid-line';
            timeline.appendChild(grid);

            if(selectedYear === TODAY.getFullYear()) {
                const line = document.createElement('div');
                line.className = 'today-marker';
                line.style.left = getYearPercentage(TODAY) + '%';
                timeline.appendChild(line);
            }

            tasks.forEach(task => {
                const colorClass = getStageClass(task.task);
                
                // 1. Forecast (Gray Bar)
                if(task.planStart && task.planEnd) {
                    const startPct = getYearPercentage(task.planStart);
                    const widthPct = getYearPercentage(task.planEnd) - startPct;
                    const planDays = calculateDaysWorked(task.planStart, task.planEnd);

                    if(widthPct > 0) {
                        const planBar = document.createElement('div');
                        planBar.className = 'bar-plan'; 
                        planBar.style.left = `${startPct}%`;
                        planBar.style.width = `${Math.max(widthPct, 0.5)}%`;
                        // Remove simple title
                        
                        // Add Rich Tooltip for Plan Bar
                        planBar.addEventListener('mouseenter', (e) => {
                            tooltip.style.display = 'block';
                            tooltip.innerHTML = `
                                <h4>${task.task} <span style="font-weight:400; font-size:12px; color:#718096">(è¨ˆç•«)</span></h4>
                                <div class="tt-row"><span class="tt-label">å·¥åº:</span> <span class="tt-val">${task.section} - ${task.process}</span></div>
                                <div class="tt-row"><span class="tt-label">æ—¥æœŸ:</span> <span class="tt-val">${formatDate(task.planStart)} ~ ${formatDate(task.planEnd)}</span></div>
                                <div class="tt-row"><span class="tt-label">é è¨ˆå·¥æœŸ:</span> <span class="tt-val">${planDays} å¤©</span></div>
                            `;
                            positionTooltip(e, tooltip);
                        });
                        planBar.addEventListener('mousemove', (e) => positionTooltip(e, tooltip));
                        planBar.addEventListener('mouseleave', () => tooltip.style.display = 'none');

                        timeline.appendChild(planBar);
                    }
                }
                
                // 2. Actual (Colored Bar)
                if (task.actualStart) {
                    const actEnd = task.actualEnd || TODAY;
                    const actStartPct = getYearPercentage(task.actualStart);
                    const actWidthPct = getYearPercentage(actEnd) - actStartPct;
                    const actDays = calculateDaysWorked(task.actualStart, task.actualEnd); // If no end, it calcs to today in helper? No, need to be careful.
                    
                    // Specific logic for days worked display
                    let daysDisplay = 0;
                    if(task.actualEnd) daysDisplay = calculateDaysWorked(task.actualStart, task.actualEnd);
                    else daysDisplay = calculateDaysWorked(task.actualStart, TODAY);

                    if(actWidthPct >= 0) { 
                        const actBar = document.createElement('div');
                        actBar.className = `bar-actual ${colorClass}`;
                        actBar.style.left = `${actStartPct}%`;
                        actBar.style.width = `${Math.max(actWidthPct, 0.5)}%`;
                        
                        // Add Rich Tooltip for Actual Bar
                        actBar.addEventListener('mouseenter', (e) => {
                            tooltip.style.display = 'block';
                            let statusColor = task.status === 'å®Œæˆ' ? '#48BB78' : (task.status === 'å¡é—œ' ? '#F56565' : '#3182CE');
                            
                            tooltip.innerHTML = `
                                <h4>${task.task} <span style="font-weight:400; font-size:12px; color:${statusColor}">(${task.status||'é€²è¡Œä¸­'})</span></h4>
                                <div class="tt-row"><span class="tt-label">å·¥åº:</span> <span class="tt-val">${task.section} - ${task.process}</span></div>
                                <div class="tt-row"><span class="tt-label">å–®ä½:</span> <span class="tt-val">${task.owner||'-'}</span></div>
                                <div class="tt-row"><span class="tt-label">æ—¥æœŸ:</span> <span class="tt-val">${formatDate(task.actualStart)} ~ ${task.actualEnd ? formatDate(task.actualEnd) : 'é€²è¡Œä¸­'}</span></div>
                                <div class="tt-row"><span class="tt-label">å·²é€²è¡Œ:</span> <span class="tt-val">${daysDisplay} å¤©</span></div>
                                ${task.statusDesc ? `<div style="margin-top:6px; padding-top:6px; border-top:1px dashed #E2E8F0; color:#E53E3E; font-size:12px;"><strong>ç•°å¸¸:</strong> ${task.statusDesc}</div>` : ''}
                            `;
                            positionTooltip(e, tooltip);
                        });
                        actBar.addEventListener('mousemove', (e) => positionTooltip(e, tooltip));
                        actBar.addEventListener('mouseleave', () => tooltip.style.display = 'none');

                        timeline.appendChild(actBar);
                    }
                } 
            });
            row.appendChild(timeline);
            container.appendChild(row);
        });
    }

    // Helper for tooltip positioning
    function positionTooltip(e, tooltip) {
        const x = e.clientX + 15;
        const y = e.clientY + 15;
        tooltip.style.left = Math.min(x, window.innerWidth - 240) + 'px'; // Prevent overflow right
        tooltip.style.top = y + 'px';
    }

    function renderManpowerGantt(data) {
        const container = document.getElementById('manpowerBody'); 
        container.innerHTML = "";
        const tooltip = document.getElementById('gantt-tooltip');
        
        if(data.length === 0) { 
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#718096;">ç„¡äººå“¡è³‡æ–™</div>'; 
            return; 
        }
        
        const groups = {}; 
        data.forEach(d => { if(!d.name) return; if(!groups[d.name]) groups[d.name]=[]; groups[d.name].push(d); });
        
        Object.keys(groups).forEach(name => {
            const records = groups[name];
            const row = document.createElement('div'); 
            row.className = 'gantt-row'; 
            row.style.height = '32px';

            row.innerHTML = `
                <div class="sticky-cell" style="width:var(--w-col-man); left:0; border-right:2px solid var(--border-light); flex-direction:column; justify-content: flex-start; align-items: flex-start; padding-left: 15px; text-align: left;">
                    <div style="font-weight:600; font-size:13px; color:var(--text-main); line-height:1.2; margin-top:2px;">${name}</div>
                    <div style="font-size:11px; color:var(--text-muted); line-height:1.2;">${records[0].role || '-'}</div>
                </div>`;
            
            const timeline = document.createElement('div'); 
            timeline.className = 'timeline-cell';
            const grid = document.createElement('div'); 
            grid.className = 'timeline-grid';
            for(let i=0; i<12; i++) grid.appendChild(document.createElement('div')).className = 'grid-line';
            timeline.appendChild(grid);
            
            if(selectedYear === TODAY.getFullYear()) { 
                const l = document.createElement('div'); 
                l.className='today-marker'; 
                l.style.left=getYearPercentage(TODAY)+'%'; 
                timeline.appendChild(l); 
            }
            
            records.forEach(r => {
                const status = getPersonStatus(r);
                
                let startDate, endDate;
                let colorClass = 'mp-active';
                let typeText = "åœ¨å´—";
                let dayLabel = "å·²å·¥ä½œ";
                let days = 0;

                if (status === 'planned') {
                    colorClass = 'mp-planned';
                    startDate = r.plannedArrival;
                    endDate = r.planLeave || new Date(selectedYear, 11, 31); 
                    typeText = "è¨ˆç•«è¡Œç¨‹";
                    dayLabel = "è¨ˆç•«å¤©æ•¸";
                    days = calculateDaysWorked(startDate, endDate);
                } else if (status === 'left') {
                    colorClass = 'mp-left';
                    startDate = r.arrival;
                    endDate = r.actualLeave;
                    typeText = "å·²é›¢å´—";
                    days = calculateDaysWorked(startDate, endDate);
                } else {
                    // Active
                    startDate = r.arrival;
                    endDate = TODAY;
                    days = calculateDaysWorked(startDate, TODAY);
                }
                
                if(!startDate) return;

                const startPct = getYearPercentage(startDate);
                const widthPct = Math.max(getYearPercentage(endDate)-startPct, 0.5);

                const bar = document.createElement('div'); 
                bar.className = `bar-manpower ${colorClass}`;
                if(r.actualLeave && r.actualLeave < TODAY) bar.style.opacity = "0.7";
                
                bar.style.left = startPct + '%';
                bar.style.width = widthPct + '%';
                
                // --- Tooltip Event Listeners ---
                bar.addEventListener('mouseenter', (e) => {
                    tooltip.style.display = 'block';
                    tooltip.innerHTML = `
                        <h4>${r.name} <span style="font-weight:400; font-size:12px">(${r.role})</span></h4>
                        <div class="tt-row"><span class="tt-label">è·è²¬:</span> <span class="tt-val">${r.duty || '-'}</span></div>
                        <div class="tt-row"><span class="tt-label">ç°½è­‰:</span> <span class="tt-val">${r.visaType || '-'}</span></div>
                        <div class="tt-row"><span class="tt-label">æ—¥æœŸ:</span> <span class="tt-val">${formatDate(startDate)} ~ ${status==='active' ? 'åœ¨è·' : formatDate(endDate)}</span></div>
                        <div class="tt-row"><span class="tt-label">${dayLabel}:</span> <span class="tt-val">${days} å¤©</span></div>
                        ${status === 'planned' ? '<div style="margin-top:4px; font-size:11px; color:#3182CE">â„¹ï¸ æ­¤ç‚ºé è¨ˆè¡Œç¨‹</div>' : ''}
                    `;
                    positionTooltip(e, tooltip);
                });

                bar.addEventListener('mousemove', (e) => positionTooltip(e, tooltip));
                bar.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                
                timeline.appendChild(bar);
            });
            
            row.append(timeline); 
            container.appendChild(row);
        });
    }

    function renderRoleChart(data) {
        const ctx = document.getElementById('roleChart').getContext('2d');
        const counts = {}; data.forEach(d => { if(d.role) counts[d.role] = (counts[d.role] || 0) + 1; });
        const labels = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'äººå“¡', data: labels.map(r=>counts[r]), backgroundColor: ['#319795','#E53E3E','#DD6B20','#38B2AC','#D53F8C'], borderRadius:4, barPercentage:0.6, maxBarThickness:30 }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x:{beginAtZero:true, grid:{color:'#E2E8F0'}, ticks:{stepSize:1}}, y:{grid:{display:false}} } }
        });
    }

    function renderKPI(data) {
        const active = data.filter(d => getPersonStatus(d) === 'active').length;
        const expired = data.filter(d => d.visaExp && d.visaExp < TODAY).length;
        const warning = data.filter(d => d.visaExp && d.visaExp > TODAY && d.visaExp < new Date(TODAY.getTime()+30*86400000)).length;
        document.getElementById('kpiContainer').innerHTML = `
            <div class="kpi-card-v2 kpi-green"><div class="kpi-header">ç›®å‰åœ¨å´—</div><div class="kpi-value-big">${active} <span>äºº</span></div></div>
            <div class="kpi-card-v2 kpi-orange"><div class="kpi-header">ç°½è­‰å³å°‡åˆ°æœŸ</div><div class="kpi-value-big">${warning} <span>äºº</span></div></div>
            <div class="kpi-card-v2 kpi-red"><div class="kpi-header">ç°½è­‰ç•°å¸¸</div><div class="kpi-value-big">${expired} <span>äºº</span></div></div>
        `;
    }

    function renderList(data) {
        document.getElementById('listBody').innerHTML = data.map(d => {
            const s = getPersonStatus(d);
            const badge = s==='active'?'<span class="tag tag-green">åœ¨å´—</span>':(s==='left'?'<span class="tag tag-gray">å·²é›¢å´—</span>':'<span class="tag tag-blue">è¨ˆç•«ä¸­</span>');
            
            return `<tr>
                <td><strong>${d.name}</strong></td>
                <td>${d.role}</td>
                <td>${d.supplier}</td>
                <td style="color:#2B6CB0">${formatDate(d.plannedArrival)}</td>
                <td style="font-weight:600">${formatDate(d.arrival)}</td>
                <td>${formatDate(d.planLeave)}</td>
                <td style="${d.visaExp<TODAY?'color:red':''}">${formatDate(d.visaExp)}</td>
                <td>${badge}</td>
            </tr>`;
        }).join('');
    }

    function getPersonStatus(d) {
        if (d.actualLeave && d.actualLeave < TODAY) return "left";
        if (d.arrival) return "active"; 
        if (d.plannedArrival) return "planned";
        return "unknown";
    }

    function calculateDaysWorked(start, end) {
        if (!start) return 0;
        let endDate = end || TODAY;
        // Simple logic: difference in days
        const diffTime = Math.abs(endDate - start);
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    }

    function getYearPercentage(date) { 
        if(!date) return 0;
        return Math.max(0, Math.min(100, ((date - new Date(selectedYear,0,1)) / 86400000 / 365) * 100)); 
    }
    function formatDate(date) { return date ? `${date.getMonth()+1}/${date.getDate()}` : '-'; }
    function setupControls() {
        ['yearSelect','filterStatus','filterSection','filterProcess','filterRole','filterName'].forEach(id => document.getElementById(id).addEventListener('change', renderAll));
        document.getElementById('themeBtn').addEventListener('click', () => document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'));
    }
    
    function populateFilters() {
        const years = [...new Set([...taskData.map(d=>d.year), ...manpowerData.map(d=>d.year)])].sort();
        document.getElementById('yearSelect').innerHTML = years.map(y => `<option value="${y}" ${y==selectedYear?'selected':''}>${y}å¹´</option>`).join('');
        
        const unique = (arr, key) => [...new Set(arr.map(d=>d[key]).filter(Boolean))].sort();
        
        ['Section','Process'].forEach(k => {
            const el = document.getElementById('filter'+k);
            const currentVal = el.value;
            el.innerHTML = `<option value="">æ‰€æœ‰${k==='Section'?'å·¥æ®µ':'å·¥åº'}</option>` + unique(taskData, k.toLowerCase()).map(v => `<option value="${v}">${v}</option>`).join('');
            if(currentVal) el.value = currentVal;
        });
        ['Role','Name'].forEach(k => {
            const el = document.getElementById('filter'+k);
            const currentVal = el.value;
            el.innerHTML = `<option value="">æ‰€æœ‰${k==='Role'?'å·¥ç¨®':'äººå“¡'}</option>` + unique(manpowerData, k.toLowerCase()).map(v => `<option value="${v}">${v}</option>`).join('');
            if(currentVal) el.value = currentVal;
        });
    }

    function renderAll() {
        selectedYear = parseInt(document.getElementById('yearSelect').value || new Date().getFullYear());
        const fStatus = document.getElementById('filterStatus').value;
        const fSection = document.getElementById('filterSection').value;
        const fProcess = document.getElementById('filterProcess').value;
        const fRole = document.getElementById('filterRole').value;
        const fName = document.getElementById('filterName').value;

        const tData = taskData.filter(d => d.year === selectedYear && (!fSection || d.section === fSection) && (!fProcess || d.process === fProcess));
        
        const mData = manpowerData.filter(d => {
            const status = getPersonStatus(d);
            const startOfYear = new Date(selectedYear, 0, 1);
            const endOfYear = new Date(selectedYear, 11, 31);
            
            const effectiveStart = d.arrival || d.plannedArrival;
            const left = d.actualLeave || d.planLeave || new Date(9999,0,1);
            
            const activeInYear = effectiveStart && effectiveStart <= endOfYear && left >= startOfYear;
            
            return activeInYear && (!fStatus || status === fStatus) && (!fName || d.name === fName) && (!fRole || d.role === fRole);
        });

        renderKPI(manpowerData); 
        renderRoleChart(mData); 
        renderMasterGantt(tData); 
        renderManpowerGantt(mData); 
        renderList(mData);
    }

    function scrollToSection(id) { document.getElementById('section-'+id).scrollIntoView({behavior:'smooth', block:'start'}); }
  </script>
</body>
</html>