<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç”¢å“å·¥ç¨‹éƒ¨å‡ºå·®çµ±è¨ˆçœ‹æ¿</title>
  <style>
    /* ===== åŸºæœ¬è‰²èª¿ï¼šåæ—¥ç³»ç¶ è‰²ç³» ===== */
    :root {
      --primary: #1aa39a;      /* ä¸»è‰²ï¼šç¶ è—è‰² */
      --primary-dark: #76c8c0; /* èª¿äº®å¾Œï¼Œçµ¦å´é‚Šæ¬„ç”¨ */
      --accent: #f6b26b;       /* é‡é»ï¼šæš–æ©˜ */
      --bg-soft: #f4faf8;      /* èƒŒæ™¯æ·¡ç¶  */
      --border-subtle: #dde5e3;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px 20px 20px 78px; /* å·¦å´é ç•™ç©ºé–“çµ¦å´é‚Šæ¬„ */
      background: var(--bg-soft);
      color: #222;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 8px;
      color: var(--primary);
    }
    h2 {
      margin: 0 0 6px;
      color: #111827;
      font-size: 1.2rem;
    }
    h2 .year-label {
      color: var(--primary);
      margin-right: 4px;
      font-weight: 700;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #607076;
      margin-bottom: 16px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      border: 1px solid var(--border-subtle);
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    button {
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      background: var(--primary);
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .status {
      font-size: 0.85rem;
      color: #4b5563;
    }
    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .error {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 6px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e0f4f1;
      color: var(--primary);
      margin-left: 6px;
    }

    /* å´é‚Šå¿«æ·åˆ—ï¼ˆä½¿ç”¨ä½ çµ¦çš„ Iconï¼‰ */
    .sidebar {
      position: fixed;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      border-radius: 24px;
      background: var(--primary-dark); /* è®Šäº®çš„ç¶ è—è‰² */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 6px;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 1000;
    }
    .side-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .side-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    .side-btn img {
      width: 22px;
      height: 22px;
      display: block;
    }

    /* åœ–è¡¨å€ */
    .chart-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .chart-controls label {
      font-size: 0.85rem;
      color: #374151;
    }
    select {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      background: #fff;
    }
    .chart-wrapper {
      margin-top: 12px;
    }
    .chart-wrapper h3 {
      margin: 4px 0 4px;
      font-size: 0.95rem;
      color: #111827;
    }
    canvas {
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #fbfbfc;
    }

    /* å¹´åº¦æ™‚é–“è»¸ */
    .timeline-wrapper {
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 8px 12px;
      overflow-x: auto;
    }
    .timeline-header {
      display: grid;
      grid-template-columns: 120px repeat(12, 1fr);
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
      align-items: center;
    }
    .timeline-header div {
      text-align: center;
      padding: 2px 0;
    }
    .timeline-header .th-name {
      text-align: left;
      padding-left: 6px;
      font-weight: 600;
    }
    .timeline-header .th-month {
      border-left: 1px solid #e5e7eb;
    }
    .timeline-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      align-items: center;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .timeline-name {
      padding: 4px 6px;
      white-space: nowrap;
      color: #374151;
    }
    .timeline-lane {
      position: relative;
      height: 32px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: inset 0 0 0 1px #e5e7eb;
      overflow: hidden;
    }
    .timeline-bar {
      position: absolute;
      top: 4px;
      height: 24px;
      border-radius: 12px;
      font-size: 11px;
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      box-sizing: border-box;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .timeline-legend {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #4b5563;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 999px;
    }
    .legend-past   { background: #80c4b7; }
    .legend-now    { background: #f6b26b; }
    .legend-future { background: #a0c5e3; }

    /* åˆ©ç”¨ç‡å¡ç‰‡ */
    .util-wrapper {
      margin-top: 8px;
    }
    .util-controls {
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #374151;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .util-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .util-card {
      flex: 1 1 220px;
      min-width: 220px;
      max-width: 260px;
      border-radius: 16px;
      background: #fbfdfc;
      border: 1px solid #e5e7eb;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .util-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: #111827;
    }
    .util-percent {
      font-size: 1.6rem;
      font-weight: 700;
      margin-top: 4px;
    }
    .util-desc {
      font-size: 0.8rem;
      color: #4b5563;
    }
    .util-bar {
      margin-top: 6px;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .util-bar-fill {
      height: 100%;
      border-radius: 999px;
    }

    /* è¡¨æ ¼å€ */
    .table-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .table-title {
      font-weight: 600;
      font-size: 1.05rem;
      color: #111827;
    }
    .table-tools {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .search-input {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      min-width: 220px;
      background: #fff;
    }
    .sort-toggle {
      font-size: 0.85rem;
      color: var(--primary);
      cursor: pointer;
      user-select: none;
    }
    .sort-toggle span {
      font-weight: 600;
    }

    .table-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.85rem;
      color: #374151;
    }
    .table-filters label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      border-radius: 12px;
      overflow: hidden;
    }
    thead {
      background: #eaf4f3;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      text-align: left;
    }
    th {
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    tbody tr:hover {
      outline: 1px solid rgba(26,163,154,0.25);
    }
    .col-name {
      width: 100px;
      white-space: nowrap;
    }
    .col-dest {
      width: 90px;
      white-space: nowrap;
    }
    .col-date {
      width: 110px;
      white-space: nowrap;
    }
    .col-days {
      width: 70px;
      white-space: nowrap;
    }
    .col-project {
      width: 160px;
    }
    .col-desc {
      min-width: 200px;
    }
    .no-data {
      text-align: center;
      padding: 14px 0;
      color: #9ca3af;
    }

    @media (max-width: 800px) {
      body {
        padding: 12px 12px 70px 12px;
      }
      table {
        font-size: 0.8rem;
      }
      .col-project, .col-desc {
        min-width: 140px;
      }
      .sidebar {
        left: 50%;
        top: auto;
        bottom: 16px;
        transform: translateX(-50%);
        flex-direction: row;
        width: auto;
        border-radius: 999px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- å´é‚Šå¿«æ·åˆ—ï¼šè«‹å°‡ Icon åœ–æª”æ”¾åœ¨ ./icons è³‡æ–™å¤¾ä¸­ -->
  <div class="sidebar">
    <a href="#chartsSection" class="side-btn" title="å‡ºå·®çµ±è¨ˆåœ–è¡¨">
      <img src="icons/icon-chart.png" alt="å‡ºå·®çµ±è¨ˆåœ–è¡¨" />
    </a>
    <a href="#utilSection" class="side-btn" title="å‡ºå·®åˆ©ç”¨ç‡">
      <img src="icons/icon-util.png" alt="å‡ºå·®åˆ©ç”¨ç‡" />
    </a>
    <a href="#timelineSection" class="side-btn" title="å¹´åº¦æ™‚é–“è»¸">
      <img src="icons/icon-timeline.png" alt="å¹´åº¦æ™‚é–“è»¸" />
    </a>
    <a href="#tableSection" class="side-btn" title="å‡ºå·®åˆ—è¡¨">
      <img src="icons/icon-list.png" alt="å‡ºå·®åˆ—è¡¨" />
    </a>
  </div>

  <h1>ç”¢å“å·¥ç¨‹éƒ¨å‡ºå·®çµ±è¨ˆçœ‹æ¿</h1>
  <div class="subtitle">
    è³‡æ–™ä¾†æºï¼šGoogle è¡¨å–® âœ Google è©¦ç®—è¡¨ï¼ˆCSV åŒ¯å‡ºï¼‰<br />
    é¡¯ç¤ºæ–¹å¼ï¼šå¹´åº¦çµ±è¨ˆåœ–è¡¨ + å‡ºå·®åˆ©ç”¨ç‡ + å¹´åº¦æ™‚é–“è»¸ + å‡ºå·®åˆ—è¡¨
  </div>

  <!-- é‡æ–°è¼‰å…¥è³‡æ–™å€ -->
  <div class="card">
    <div class="controls">
      <button id="reloadBtn">é‡æ–°è¼‰å…¥è³‡æ–™</button>
      <span class="status" id="statusText">å°šæœªè¼‰å…¥è³‡æ–™</span>
    </div>
    <div class="small">
      ğŸ”§ è‹¥æ–°å¢äº†æ–°çš„è¡¨å–®å›è¦†ï¼Œåªè¦é»æ“Šã€Œé‡æ–°è¼‰å…¥è³‡æ–™ã€å³å¯æ›´æ–°çµ±è¨ˆçµæœã€‚
    </div>
    <div id="errorBox" class="error"></div>
  </div>

  <!-- åœ–è¡¨å€ -->
  <div class="card" id="chartsSection">
    <h2><span class="year-label" id="chartsYearLabel"></span>å‡ºå·®çµ±è¨ˆåœ–è¡¨</h2>
    <div class="chart-controls">
      <label>
        é¸æ“‡å¹´ä»½ï¼š
        <select id="yearSelect"></select>
      </label>
      <label>
        æ’åºæ–¹å¼ï¼š
        <select id="chartSortSelect">
          <option value="desc">å¤©æ•¸å¤š â†’ å°‘</option>
          <option value="asc">å¤©æ•¸å°‘ â†’ å¤š</option>
        </select>
      </label>
      <span class="small" id="chartHint">è¼‰å…¥è³‡æ–™å¾Œæœƒè‡ªå‹•é¸æ“‡æœ€æ–°å¹´åº¦ã€‚</span>
    </div>

    <div class="chart-wrapper">
      <h3>å„äººå“¡å‡ºå·®å¤©æ•¸ï¼ˆå¤©ï¼‰</h3>
      <canvas id="personChart"></canvas>
      <div class="small">æ¯ä½åŒä»åœ¨è©²å¹´åº¦ç´¯ç©çš„å‡ºå·®å¤©æ•¸ï¼ˆæ©«å‘æ¢ç‹€åœ–ï¼‰ã€‚</div>
    </div>

    <div class="chart-wrapper">
      <h3>å„å°ˆæ¡ˆå‡ºå·®å¤©æ•¸ï¼ˆå¤©ï¼‰</h3>
      <canvas id="projectChart"></canvas>
      <div class="small">ä¾å°ˆæ¡ˆ/é …ç›®åç¨±çµ±è¨ˆå‡ºå·®æŠ•å…¥çš„ç¸½å¤©æ•¸ã€‚</div>
    </div>
  </div>

  <!-- å‡ºå·®åˆ©ç”¨ç‡å€ -->
  <div class="card" id="utilSection">
    <h2><span class="year-label" id="utilYearLabel"></span>å‡ºå·®åˆ©ç”¨ç‡æ¦‚æ³</h2>
    <div class="small">
      åˆ©ç”¨ç‡å®šç¾©ï¼š<strong>å‡ºå·®å¤©æ•¸ Ã· å¹´å·¥ä½œå¤©æ•¸</strong>ã€‚ç›®å‰å‡è¨­å¹´å·¥ä½œå¤©æ•¸ = <strong>240 å¤©</strong>ï¼ˆç´„ 5 å¤© Ã— 48 é€±ï¼‰ï¼Œä¹‹å¾Œå¯ä¾å…¬å¸åˆ¶åº¦è‡ªè¡Œèª¿æ•´ã€‚
    </div>
    <div class="util-controls">
      <label>
        æ’åºæ–¹å¼ï¼š
        <select id="utilSortSelect">
          <option value="desc">å‡ºå·®å¤©æ•¸å¤š â†’ å°‘</option>
          <option value="asc">å‡ºå·®å¤©æ•¸å°‘ â†’ å¤š</option>
        </select>
      </label>
    </div>
    <div class="util-wrapper">
      <div class="util-grid" id="utilCards"></div>
    </div>
  </div>

  <!-- å¹´åº¦æ™‚é–“è»¸å€ -->
  <div class="card" id="timelineSection">
    <h2><span class="year-label" id="timelineYearLabel"></span>å¹´åº¦å‡ºå·®æ™‚é–“è»¸</h2>
    <div class="small">
      X è»¸ï¼š1ï½12 æœˆï¼›Y è»¸ï¼šå‡ºå·®äººå“¡ã€‚é¡è‰²ä»£è¡¨ç›®å‰å‡ºå·®ç‹€æ…‹ï¼ˆä¾ä»Šæ—¥æ—¥æœŸåˆ¤å®šï¼‰ã€‚
    </div>
    <div class="timeline-wrapper">
      <div class="timeline-header" id="timelineHeader"></div>
      <div id="timelineBody"></div>
    </div>
    <div class="timeline-legend">
      <div class="legend-item">
        <span class="legend-color legend-past"></span> å·²å®Œæˆå‡ºå·®ä»»å‹™ï¼ˆçµæŸæ—¥æœŸæ—©æ–¼ä»Šæ—¥ï¼‰
      </div>
      <div class="legend-item">
        <span class="legend-color legend-now"></span> é€²è¡Œä¸­çš„å‡ºå·®ä»»å‹™ï¼ˆä»Šæ—¥ä»‹æ–¼é–‹å§‹èˆ‡çµæŸä¹‹é–“ï¼‰
      </div>
      <div class="legend-item">
        <span class="legend-color legend-future"></span> æœªä¾†å³å°‡å‡ºå·®çš„ä»»å‹™ï¼ˆé–‹å§‹æ—¥æœŸæ™šæ–¼ä»Šæ—¥ï¼‰
      </div>
    </div>
  </div>

  <!-- å‡ºå·®åˆ—è¡¨è¡¨æ ¼ -->
  <div class="card" id="tableSection">
    <div class="table-header-row">
      <div class="table-title">
        <span class="year-label" id="tableYearLabel"></span>å‡ºå·®åˆ—è¡¨ï¼ˆè©²å¹´åº¦å…¨éƒ¨ç´€éŒ„ï¼‰
        <span class="badge" id="tripCountBadge">0 ç­†</span>
      </div>
      <div class="table-tools">
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="æœå°‹å§“åã€åœ°é»æˆ–å°ˆæ¡ˆé—œéµå­—â€¦"
        />
        <div id="sortToggle" class="sort-toggle">
          ä¾é–‹å§‹æ—¥æœŸæ’åº <span id="sortIcon">â–²ï¼ˆèˆŠâ†’æ–°ï¼‰</span>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šå§“å / ç›®çš„åœ° / å°ˆæ¡ˆ ç¯©é¸ -->
    <div class="table-filters">
      <label>
        å§“åï¼š
        <select id="nameFilter">
          <option value="">å…¨éƒ¨</option>
        </select>
      </label>
      <label>
        ç›®çš„åœ° / åœ°é»ï¼š
        <select id="destFilter">
          <option value="">å…¨éƒ¨</option>
        </select>
      </label>
      <label>
        å°ˆæ¡ˆ / é …ç›®ï¼š
        <select id="projectFilter">
          <option value="">å…¨éƒ¨</option>
        </select>
      </label>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="col-name">å§“å</th>
            <th class="col-dest">ç›®çš„åœ° / åœ°é»</th>
            <th class="col-date">é–‹å§‹æ—¥æœŸ</th>
            <th class="col-date">çµæŸæ—¥æœŸ</th>
            <th class="col-days">å¤©æ•¸</th>
            <th class="col-project">å°ˆæ¡ˆ / é …ç›®</th>
            <th class="col-desc">å·¥ä½œå…§å®¹</th>
          </tr>
        </thead>
        <tbody id="tripTableBody">
          <tr><td colspan="7" class="no-data">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ğŸ”— æŠŠé€™è£¡æ›æˆä½ è‡ªå·±çš„ Google Sheetã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ CSV ç¶²å€
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQI-ac_9JPcK5zQSCPT6xS1YYWUAv7n8-isJ_TrHuFSHGAK4I7d0EG8ZofBK36dvd9e4HM5FZCbVCr1/pub?output=csv";

    // å¹´å·¥ä½œå¤©æ•¸ï¼ˆå¯ä¾å…¬å¸åˆ¶åº¦èª¿æ•´ï¼‰
    const WORK_DAYS_PER_YEAR = 240;

    // æŸ”å’Œè«è˜­è¿ªèª¿è‰²ç›¤
    const PERSON_COLOR_PALETTE = [
      "#A0C5E3", // æŸ”è—
      "#B4CFA4", // æ·¡ç¶ 
      "#FBC2C2", // æ·¡ç²‰
      "#BBA6DD", // æ·¡ç´«
      "#E39B99", // æš–ç«ç‘°
      "#8BA47C", // è‰ç¶ 
      "#81B2D9"  // ä¸­è—
    ];

    const PROJECT_COLOR_PALETTE = [
      "#A0C5E3",
      "#B4CFA4",
      "#FBC2C2",
      "#BBA6DD",
      "#8BA47C"
    ];

    // å›ºå®šæŒ‡å®šçš„äººåé¡è‰²ï¼Œå…¶é¤˜ç”±å§“å hash åˆ†é…
    const PERSON_COLOR_MAP = {
      "ç‹å°æ˜": "#A0C5E3",
      "è‘‰å¤§é›„": "#E39B99",
      "è‘‰æ³°å®": "#E39B99"
    };

    // æ™‚é–“è»¸ä¸‰ç¨®ç‹€æ…‹é¡è‰²
    const TIMELINE_COLOR_PAST   = "#80c4b7"; // å·²å®Œæˆ
    const TIMELINE_COLOR_NOW    = "#f6b26b"; // é€²è¡Œä¸­
    const TIMELINE_COLOR_FUTURE = "#a0c5e3"; // æœªä¾†

    // å‡ºå·®åˆ©ç”¨ç‡å€é–“é¡è‰²ï¼ˆA,B,C,Dï¼‰
    const UTIL_COLOR_A = "#1aa39a"; // >80%
    const UTIL_COLOR_B = "#f4b35e"; // 60~80
    const UTIL_COLOR_C = "#f9d28c"; // 40~60
    const UTIL_COLOR_D = "#fbc2c2"; // <40

    const reloadBtn = document.getElementById("reloadBtn");
    const statusText = document.getElementById("statusText");
    const errorBox = document.getElementById("errorBox");

    const yearSelect = document.getElementById("yearSelect");
    const chartSortSelect = document.getElementById("chartSortSelect");
    const chartHint = document.getElementById("chartHint");
    const personChartCanvas = document.getElementById("personChart");
    const projectChartCanvas = document.getElementById("projectChart");

    const utilSortSelect = document.getElementById("utilSortSelect");
    const utilCards = document.getElementById("utilCards");

    const timelineHeader = document.getElementById("timelineHeader");
    const timelineBody = document.getElementById("timelineBody");

    const tripTableBody = document.getElementById("tripTableBody");
    const tripCountBadge = document.getElementById("tripCountBadge");
    const searchInput = document.getElementById("searchInput");
    const sortToggle = document.getElementById("sortToggle");
    const sortIcon = document.getElementById("sortIcon");

    const nameFilterSelect = document.getElementById("nameFilter");
    const destFilterSelect = document.getElementById("destFilter");
    const projectFilterSelect = document.getElementById("projectFilter");

    const chartsYearLabel = document.getElementById("chartsYearLabel");
    const utilYearLabel = document.getElementById("utilYearLabel");
    const timelineYearLabel = document.getElementById("timelineYearLabel");
    const tableYearLabel = document.getElementById("tableYearLabel");

    let globalTrips = [];
    let filteredTrips = [];
    let personYearStats = {};
    let projectYearStats = {};
    let availableYears = [];
    let sortAsc = true; // table ç”¨ï¼štrue=èˆŠâ†’æ–°
    let currentYear = null; // ç›®å‰åœ–è¡¨ï¼æ™‚é–“è»¸ï¼åˆ©ç”¨ç‡ï¼åˆ—è¡¨é¡¯ç¤ºçš„å¹´åº¦

    function setStatus(text) { statusText.textContent = text; }
    function setError(text) { errorBox.textContent = text || ""; }

    function parseDate(str) {
      const d = new Date(str);
      if (!isNaN(d.getTime())) return d;
      return null;
    }
    function calcDays(startDate, endDate) {
      if (!startDate || !endDate) return 0;
      const msPerDay = 1000 * 60 * 60 * 24;
      const diff = endDate - startDate;
      return Math.floor(diff / msPerDay) + 1;
    }

    function csvToRows(text) {
      const lines = text.trim().split("\n");
      return lines.map(line => line.replace(/\r/g, "").split(","));
    }

    function findColIndex(headerRow, candidates, fallback) {
      for (const name of candidates) {
        const idx = headerRow.indexOf(name);
        if (idx !== -1) return idx;
      }
      return fallback;
    }

    function hexToRgba(hex, alpha) {
      const h = hex.replace("#", "");
      const r = parseInt(h.substring(0, 2), 16);
      const g = parseInt(h.substring(2, 4), 16);
      const b = parseInt(h.substring(4, 6), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // å§“å â†’ é¡è‰²ï¼ˆå›ºå®šï¼‰
    function getPersonColor(name) {
      if (PERSON_COLOR_MAP[name]) return PERSON_COLOR_MAP[name];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = (hash * 31 + name.charCodeAt(i)) >>> 0;
      }
      const idx = hash % PERSON_COLOR_PALETTE.length;
      return PERSON_COLOR_PALETTE[idx];
    }

    // æ›´æ–°å„å€å¡Šæ¨™é¡Œä¸­çš„å¹´ä»½
    function updateSectionYearLabels() {
      const labelText = currentYear ? `${currentYear} å¹´` : "";
      chartsYearLabel.textContent = labelText;
      utilYearLabel.textContent = labelText;
      timelineYearLabel.textContent = labelText;
      tableYearLabel.textContent = labelText;
    }

    // ä¸»è¦è¼‰å…¥æµç¨‹
    async function loadData() {
      setError("");
      setStatus("è¼‰å…¥ä¸­...");
      reloadBtn.disabled = true;
      yearSelect.innerHTML = "";
      chartHint.textContent = "æ­£åœ¨è¼‰å…¥è³‡æ–™â€¦";
      tripTableBody.innerHTML = '<tr><td colspan="7" class="no-data">è¼‰å…¥ä¸­â€¦</td></tr>';
      timelineHeader.innerHTML = "";
      timelineBody.innerHTML = "";
      utilCards.innerHTML = "";
      currentYear = null;
      updateSectionYearLabels();

      try {
        const res = await fetch(CSV_URL);
        if (!res.ok) throw new Error("ç„¡æ³•å–å¾— CSVï¼ŒHTTP ç‹€æ…‹ç¢¼ï¼š" + res.status);

        const text = await res.text();
        const rows = csvToRows(text);
        if (rows.length <= 1) {
          globalTrips = [];
          filteredTrips = [];
          renderTable();
          drawBarChart(personChartCanvas, [], [], null);
          drawBarChart(projectChartCanvas, [], [], null);
          setStatus("è¼‰å…¥å®Œæˆï¼ˆ0 ç­†è³‡æ–™ï¼‰");
          reloadBtn.disabled = false;
          return;
        }

        const [header, ...dataRows] = rows;

        const colIndex = {
          timestamp: 0,
          employeeName: findColIndex(header, ["å‡ºå·®äººå“¡å§“å", "å‡ºå·®äººå“¡"], 1),
          destination: findColIndex(header, ["ç›®çš„åœ° / åœ°é»", "ç›®çš„åœ°", "åœ°é»"], 2),
          startDate: findColIndex(header, ["å‡ºå·®é–‹å§‹æ—¥"], 3),
          endDate: findColIndex(header, ["å‡ºå·®çµæŸæ—¥"], 4),
          description: findColIndex(header, ["ä¸»è¦å·¥ä½œå…§å®¹", "å·¥ä½œå…§å®¹"], 5),
          projectName: findColIndex(header, ["å°ˆæ¡ˆ/é …ç›®åç¨±", "å°ˆæ¡ˆåç¨±", "é …ç›®åç¨±"], header.length - 1),
        };

        const trips = [];
        for (const row of dataRows) {
          if (row.length < 5) continue;

          const employeeName = row[colIndex.employeeName] || "";
          const destination = row[colIndex.destination] || "";
          const startDateStr = row[colIndex.startDate] || "";
          const endDateStr = row[colIndex.endDate] || "";
          const description = row[colIndex.description] || "";
          const projectName = row[colIndex.projectName] || "";

          const startDate = parseDate(startDateStr);
          const endDate = parseDate(endDateStr);
          const days = calcDays(startDate, endDate);
          if (!employeeName || !startDate || !endDate || !days) continue;

          trips.push({ employeeName, destination, startDate, endDate, days, description, projectName });
        }

        globalTrips = trips;
        buildStats(trips);
        initCharts(); // æœƒé †ä¾¿åˆå§‹åŒ–æ™‚é–“è»¸ & åˆ©ç”¨ç‡ & ç¯©é¸ & åˆ—è¡¨
        setStatus(`è¼‰å…¥å®Œæˆï¼ˆ${trips.length} ç­†å‡ºå·®ç´€éŒ„ï¼‰`);
      } catch (err) {
        console.error(err);
        setError("è¼‰å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
        setStatus("è¼‰å…¥å¤±æ•—");
        globalTrips = [];
        filteredTrips = [];
        renderTable();
        drawBarChart(personChartCanvas, [], [], null);
        drawBarChart(projectChartCanvas, [], [], null);
      } finally {
        reloadBtn.disabled = false;
      }
    }

    function buildStats(trips) {
      personYearStats = {};
      projectYearStats = {};
      const yearSet = new Set();

      for (const t of trips) {
        const year = t.startDate.getFullYear();
        yearSet.add(year);

        if (!personYearStats[year]) personYearStats[year] = {};
        if (!projectYearStats[year]) projectYearStats[year] = {};

        if (!personYearStats[year][t.employeeName]) personYearStats[year][t.employeeName] = 0;
        personYearStats[year][t.employeeName] += t.days;

        const projKey = t.projectName || "(æœªå¡«å°ˆæ¡ˆ)";
        if (!projectYearStats[year][projKey]) projectYearStats[year][projKey] = 0;
        projectYearStats[year][projKey] += t.days;
      }

      availableYears = Array.from(yearSet).sort((a, b) => a - b);
    }

    function initCharts() {
      if (!availableYears.length) {
        yearSelect.innerHTML = "";
        chartHint.textContent = "ç›®å‰æ²’æœ‰å¯ç”¨çš„å¹´åº¦è³‡æ–™ã€‚";
        drawBarChart(personChartCanvas, [], [], null);
        drawBarChart(projectChartCanvas, [], [], null);
        updateTimelineForYear(null);
        updateUtilizationForYear(null);
        populateFiltersForYear(null);
        filteredTrips = [];
        renderTable();
        return;
      }

      yearSelect.innerHTML = "";
      availableYears.forEach(year => {
        const opt = document.createElement("option");
        opt.value = year;
        opt.textContent = year + " å¹´";
        yearSelect.appendChild(opt);
      });

      const defaultYear = availableYears[availableYears.length - 1];
      yearSelect.value = defaultYear;
      currentYear = defaultYear;
      chartHint.textContent = `ç›®å‰é¡¯ç¤ºï¼š${defaultYear} å¹´çµ±è¨ˆ`;
      updateSectionYearLabels();

      updateChartsForYear(defaultYear);
      updateTimelineForYear(defaultYear);
      updateUtilizationForYear(defaultYear);
      populateFiltersForYear(defaultYear);
      applySearchAndSort(); // åˆå§‹åŒ–åˆ—è¡¨

      yearSelect.onchange = () => {
        const y = parseInt(yearSelect.value, 10);
        currentYear = y;
        chartHint.textContent = `ç›®å‰é¡¯ç¤ºï¼š${y} å¹´çµ±è¨ˆ`;
        updateSectionYearLabels();
        updateChartsForYear(y);
        updateTimelineForYear(y);
        updateUtilizationForYear(y);
        populateFiltersForYear(y);
        applySearchAndSort();
      };
    }

    function getSortedLabelsAndValues(statObj, sortMode) {
      const entries = Object.entries(statObj);
      entries.sort((a, b) => sortMode === "asc" ? a[1] - b[1] : b[1] - a[1]);
      return {
        labels: entries.map(([k]) => k),
        values: entries.map(([, v]) => v)
      };
    }

    function updateChartsForYear(year) {
      const personData = personYearStats[year] || {};
      const projectData = projectYearStats[year] || {};
      const sortMode = chartSortSelect.value || "desc";

      const p = getSortedLabelsAndValues(personData, sortMode);
      const r = getSortedLabelsAndValues(projectData, sortMode);

      drawBarChart(
        personChartCanvas,
        p.labels,
        p.values,
        (label) => getPersonColor(label)
      );
      drawBarChart(
        projectChartCanvas,
        r.labels,
        r.values,
        (label, i) => PROJECT_COLOR_PALETTE[i % PROJECT_COLOR_PALETTE.length]
      );
    }

    // === å‡ºå·®åˆ©ç”¨ç‡ ===
    function updateUtilizationForYear(year) {
      utilCards.innerHTML = "";
      if (!year || !personYearStats[year]) {
        const p = document.createElement("div");
        p.className = "small";
        p.style.marginTop = "8px";
        p.textContent = "æ­¤å¹´åº¦ç›®å‰æ²’æœ‰å‡ºå·®ç´€éŒ„ï¼Œç„¡æ³•è¨ˆç®—åˆ©ç”¨ç‡ã€‚";
        utilCards.appendChild(p);
        return;
      }

      const stats = personYearStats[year];
      const entries = Object.entries(stats);
      const sortMode = utilSortSelect.value || "desc";
      entries.sort((a, b) =>
        sortMode === "asc" ? a[1] - b[1] : b[1] - a[1]
      );

      entries.forEach(([name, tripDays]) => {
        const utilization = tripDays / WORK_DAYS_PER_YEAR;
        const percent = utilization * 100;
        const displayPercent = percent.toFixed(1) + "%";

        let color;
        if (percent > 80) {
          color = UTIL_COLOR_A;
        } else if (percent >= 60) {
          color = UTIL_COLOR_B;
        } else if (percent >= 40) {
          color = UTIL_COLOR_C;
        } else {
          color = UTIL_COLOR_D;
        }

        const card = document.createElement("div");
        card.className = "util-card";
        card.style.borderColor = hexToRgba(color, 0.6);

        const nameEl = document.createElement("div");
        nameEl.className = "util-name";
        nameEl.textContent = name;

        const percentEl = document.createElement("div");
        percentEl.className = "util-percent";
        percentEl.style.color = color;
        percentEl.textContent = displayPercent;

        const descEl = document.createElement("div");
        descEl.className = "util-desc";
        descEl.textContent = `å‡ºå·®å¤©æ•¸ï¼š${tripDays} å¤©ï¼å¹´å·¥ä½œå¤©æ•¸ï¼š${WORK_DAYS_PER_YEAR} å¤©`;

        const bar = document.createElement("div");
        bar.className = "util-bar";
        const fill = document.createElement("div");
        fill.className = "util-bar-fill";
        fill.style.backgroundColor = color;
        fill.style.width = Math.min(utilization, 1) * 100 + "%";
        bar.appendChild(fill);

        card.appendChild(nameEl);
        card.appendChild(percentEl);
        card.appendChild(descEl);
        card.appendChild(bar);
        utilCards.appendChild(card);
      });
    }

    // === å¹´åº¦æ™‚é–“è»¸ ===
    function updateTimelineForYear(year) {
      timelineHeader.innerHTML = "";
      timelineBody.innerHTML = "";

      if (!year || !globalTrips.length) return;

      const headerFragment = document.createDocumentFragment();
      const nameDiv = document.createElement("div");
      nameDiv.className = "th-name";
      nameDiv.textContent = "äººå“¡ / æœˆä»½";
      headerFragment.appendChild(nameDiv);
      for (let m = 1; m <= 12; m++) {
        const md = document.createElement("div");
        md.className = "th-month";
        md.textContent = m + " æœˆ";
        headerFragment.appendChild(md);
      }
      timelineHeader.appendChild(headerFragment);

      const yearTrips = globalTrips.filter(t =>
        t.startDate.getFullYear() === year || t.endDate.getFullYear() === year
      );
      if (!yearTrips.length) {
        const row = document.createElement("div");
        row.className = "small";
        row.style.marginTop = "4px";
        row.textContent = "æ­¤å¹´åº¦ç›®å‰æ²’æœ‰å‡ºå·®ç´€éŒ„ã€‚";
        timelineBody.appendChild(row);
        return;
      }

      const personMap = {};
      yearTrips.forEach(t => {
        if (!personMap[t.employeeName]) personMap[t.employeeName] = [];
        personMap[t.employeeName].push(t);
      });

      const persons = Object.keys(personMap).sort();
      const yearStart = new Date(year, 0, 1);
      const yearEnd = new Date(year, 11, 31);
      const yearMs = yearEnd - yearStart + 24 * 60 * 60 * 1000;

      const today = new Date();
      today.setHours(0,0,0,0);

      persons.forEach((name) => {
        const row = document.createElement("div");
        row.className = "timeline-row";

        const nameCell = document.createElement("div");
        nameCell.className = "timeline-name";
        nameCell.textContent = name;
        row.appendChild(nameCell);

        const lane = document.createElement("div");
        lane.className = "timeline-lane";
        row.appendChild(lane);
        timelineBody.appendChild(row);

        const laneWidth = lane.clientWidth || lane.offsetWidth || 600;

        personMap[name].forEach(trip => {
          const s = trip.startDate < yearStart ? yearStart : trip.startDate;
          const e = trip.endDate > yearEnd ? yearEnd : trip.endDate;

          const startRatio = (s - yearStart) / yearMs;
          const endRatio = (e - yearStart) / yearMs;
          const left = startRatio * laneWidth;
          const width = Math.max((endRatio - startRatio) * laneWidth, 20);

          let color;
          if (trip.endDate < today) {
            color = TIMELINE_COLOR_PAST;
          } else if (trip.startDate > today) {
            color = TIMELINE_COLOR_FUTURE;
          } else {
            color = TIMELINE_COLOR_NOW;
          }

          const bar = document.createElement("div");
          bar.className = "timeline-bar";
          bar.style.backgroundColor = color;
          bar.style.left = left + "px";
          bar.style.width = width + "px";

          const label = document.createElement("span");
          const labelStart = `${s.getMonth() + 1}/${s.getDate()}`;
          const labelEnd = `${e.getMonth() + 1}/${e.getDate()}`;
          label.textContent = `${labelStart}ï½${labelEnd} Â· ${trip.days}å¤©`;
          bar.appendChild(label);

          lane.appendChild(bar);
        });
      });
    }

    // === æ©«å‘æŸ±ç‹€åœ–ï¼ˆå›ºå®š bar é«˜åº¦ï¼‰ ===
    function drawBarChart(canvas, labels, values, getColor) {
      const width = canvas.clientWidth || 600;

      // å›ºå®šæ¯æ¢ bar çš„é«˜åº¦ & é–“è·
      const barHeight = 26;
      const barGap = 8;

      const padding = { top: 20, right: 40, bottom: 40, left: 140 };
      const barCount = values.length || 1;
      const chartH = barCount * barHeight + (barCount - 1) * barGap;
      const totalHeight = padding.top + chartH + padding.bottom;

      canvas.width = width;
      canvas.height = totalHeight;

      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, width, totalHeight);

      if (!labels.length || !values.length) {
        ctx.fillStyle = "#999";
        ctx.font = "14px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("ç›®å‰ç„¡è³‡æ–™", width / 2, totalHeight / 2);
        return;
      }

      const chartW = width - padding.left - padding.right;
      const maxVal = Math.max(...values);

      ctx.save();
      ctx.translate(padding.left, padding.top);

      // è»¸ç·š
      ctx.strokeStyle = "#e5e7eb";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, chartH);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(0, chartH);
      ctx.lineTo(chartW, chartH);
      ctx.stroke();

      // X è»¸åˆ»åº¦
      ctx.fillStyle = "#4b5563";
      ctx.font = "12px system-ui";
      ctx.textAlign = "center";

      const tickCount = 4;
      for (let i = 0; i <= tickCount; i++) {
        const ratio = i / tickCount;
        const x = ratio * chartW;
        const val = Math.round(ratio * maxVal);
        ctx.fillText(val.toString(), x, chartH + 18);
        ctx.strokeStyle = "#f3f4f6";
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, chartH);
        ctx.stroke();
      }

      const scale = chartW / maxVal;

      labels.forEach((label, i) => {
        const y = i * (barHeight + barGap);
        const v = values[i];
        const w = v * scale;

        const color = getColor
          ? getColor(label, i)
          : PERSON_COLOR_PALETTE[i % PERSON_COLOR_PALETTE.length];

        ctx.fillStyle = color;
        ctx.fillRect(0, y, w, barHeight);

        ctx.fillStyle = "#111827";
        ctx.font = "12px system-ui";
        ctx.textAlign = "left";
        ctx.fillText(v.toString(), w + 6, y + barHeight / 2 + 4);

        ctx.textAlign = "right";
        ctx.fillStyle = "#4b5563";
        ctx.font = "13px system-ui";
        const labelText = label.length > 12 ? label.slice(0, 12) + "â€¦" : label;
        ctx.fillText(labelText, -10, y + barHeight / 2 + 4);
      });

      ctx.restore();
    }

    // ===== å‡ºå·®åˆ—è¡¨ï¼šæœå°‹ + ä¸‹æ‹‰ç¯©é¸ + å¹´åº¦åŒæ­¥ =====
    function getYearBaseTrips() {
      if (!currentYear) return [];
      return globalTrips.filter(t => t.startDate.getFullYear() === currentYear);
    }

    function populateFiltersForYear(year) {
      nameFilterSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
      destFilterSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
      projectFilterSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';

      if (!year) return;

      const yearTrips = getYearBaseTrips();

      const names = new Set();
      const dests = new Set();
      const projects = new Set();

      yearTrips.forEach(t => {
        if (t.employeeName) names.add(t.employeeName);
        if (t.destination) dests.add(t.destination);
        if (t.projectName) projects.add(t.projectName);
      });

      [...names].sort().forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        nameFilterSelect.appendChild(opt);
      });

      [...dests].sort().forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        destFilterSelect.appendChild(opt);
      });

      [...projects].sort().forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        projectFilterSelect.appendChild(opt);
      });
    }

    function applySearchAndSort() {
      const keyword = (searchInput.value || "").trim().toLowerCase();
      const nameFilter = nameFilterSelect.value;
      const destFilter = destFilterSelect.value;
      const projFilter = projectFilterSelect.value;

      const baseTrips = getYearBaseTrips();

      filteredTrips = baseTrips.filter(t => {
        if (nameFilter && t.employeeName !== nameFilter) return false;
        if (destFilter && t.destination !== destFilter) return false;
        if (projFilter && t.projectName !== projFilter) return false;

        if (!keyword) return true;
        const text = [
          t.employeeName,
          t.destination,
          t.projectName,
          t.description,
        ].join(" ").toLowerCase();
        return text.includes(keyword);
      });

      filteredTrips.sort((a, b) => {
        if (sortAsc) {
          return a.startDate - b.startDate; // èˆŠâ†’æ–°
        } else {
          return b.startDate - a.startDate; // æ–°â†’èˆŠ
        }
      });

      renderTable();
    }

    function renderTable() {
      tripTableBody.innerHTML = "";

      if (!filteredTrips.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-data";
        td.textContent = "ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å‡ºå·®ç´€éŒ„ã€‚";
        tr.appendChild(td);
        tripTableBody.appendChild(tr);
        tripCountBadge.textContent = "0 ç­†";
        return;
      }

      filteredTrips.forEach((t) => {
        const tr = document.createElement("tr");
        const start = t.startDate.toISOString().slice(0, 10);
        const end = t.endDate.toISOString().slice(0, 10);

        const baseColor = getPersonColor(t.employeeName);
        tr.style.backgroundColor = hexToRgba(baseColor, 0.12);

        tr.innerHTML = `
          <td class="col-name" style="color:#111827; font-weight:600;">${t.employeeName}</td>
          <td class="col-dest">${t.destination || "â€”"}</td>
          <td class="col-date">${start}</td>
          <td class="col-date">${end}</td>
          <td class="col-days">${t.days}</td>
          <td class="col-project">${t.projectName || "â€”"}</td>
          <td class="col-desc">${t.description || ""}</td>
        `;
        tripTableBody.appendChild(tr);
      });

      tripCountBadge.textContent = filteredTrips.length + " ç­†";
    }

    // äº‹ä»¶ç¶å®š
    reloadBtn.addEventListener("click", loadData);
    searchInput.addEventListener("input", applySearchAndSort);
    sortToggle.addEventListener("click", () => {
      sortAsc = !sortAsc;
      sortIcon.textContent = sortAsc ? "â–²ï¼ˆèˆŠâ†’æ–°ï¼‰" : "â–¼ï¼ˆæ–°â†’èˆŠï¼‰";
      applySearchAndSort();
    });

    chartSortSelect.addEventListener("change", () => {
      if (currentYear != null) updateChartsForYear(currentYear);
    });

    utilSortSelect.addEventListener("change", () => {
      if (currentYear != null) updateUtilizationForYear(currentYear);
    });

    nameFilterSelect.addEventListener("change", applySearchAndSort);
    destFilterSelect.addEventListener("change", applySearchAndSort);
    projectFilterSelect.addEventListener("change", applySearchAndSort);

    // é è¨­è¼‰å…¥ä¸€æ¬¡
    loadData();
  </script>
</body>
</html>
