<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å‡ºå·®ç´€éŒ„ç®¡ç†</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans TC", sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: #f3f4f6;
      color: #24272b;
    }

    h1 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 24px;
      letter-spacing: 0.08em;
    }

    h2 {
      font-size: 18px;
      margin: 0 0 4px;
      letter-spacing: 0.12em;
    }

    .page-subtitle {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto 16px;
      background: #fdfdfd;
      border-radius: 14px;
      padding: 20px 24px 24px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
      border: 1px solid #e5e7eb;
    }

    .container + .container {
      margin-top: 8px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
    }

    .section-header span {
      font-size: 11px;
      color: #9ca3af;
    }

    .form-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .form-group {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 12px;
      margin-bottom: 4px;
      color: #4b5563;
      letter-spacing: 0.08em;
    }

    input[type="text"],
    input[type="date"],
    textarea {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #f9fafb;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    textarea:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25);
      background: #ffffff;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .left-actions,
    .right-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
      letter-spacing: 0.08em;
    }

    button:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: #60a5fa;
      color: #111827;
      box-shadow: 0 6px 18px rgba(96, 165, 250, 0.35);
    }

    .btn-primary:hover {
      background: #3b82f6;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-text {
      background: transparent;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      letter-spacing: 0.08em;
    }

    .btn-text:hover {
      background: rgba(0, 0, 0, 0.035);
    }

    .btn-danger {
      background: #fca5a5;
      color: #7f1d1d;
      box-shadow: none;
    }

    .btn-danger:hover {
      background: #f87171;
    }

    .search-input {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      min-width: 180px;
      background: #f9fafb;
    }

    .search-input:focus {
      outline: none;
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.25);
      background: #ffffff;
    }

    .table-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #fdfdfd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      text-align: left;
    }

    th {
      font-weight: 500;
      color: #4b5563;
      user-select: none;
      font-size: 12px;
      letter-spacing: 0.12em;
    }

    tr:nth-child(even) td {
      background: #fbfbfc;
    }

    tr:hover td {
      background: #eef2ff;
    }

    .col-actions {
      white-space: nowrap;
      text-align: right;
    }

    .muted {
      color: #9ca3af;
      font-size: 12px;
    }

    .empty-state {
      padding: 18px;
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
    }

    .sort-indicator {
      font-size: 11px;
      margin-left: 2px;
      opacity: 0.8;
    }

    .nowrap {
      white-space: nowrap;
    }

    /* çµ±è¨ˆå€å¡Šï¼ˆæ¨¹ç‹€çµæ§‹ï¼‰ */
    .stats-container {
      padding-top: 18px;
    }

    .stats-hint {
      margin-top: 2px;
      font-size: 11px;
      color: #9ca3af;
    }

    .stats-tree {
      margin-top: 10px;
      border-radius: 12px;
      background: #f9fafb;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
    }

    details {
      margin: 4px 0;
    }

    summary {
      list-style: none;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #374151;
      position: relative;
    }

    summary::before {
      content: "â–¸";
      font-size: 11px;
      color: #9ca3af;
      transition: transform 0.15s ease;
    }

    details[open] > summary::before {
      transform: rotate(90deg);
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .year-summary {
      background: #eef2ff;
      border-radius: 999px;
      padding-right: 10px;
      margin-bottom: 4px;
    }

    .employee-summary {
      background: #fefce8;
      padding-right: 10px;
      margin: 2px 0;
    }

    .stats-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
    }

    .stats-badge-soft {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .stats-subtree {
      margin-left: 16px;
      padding-left: 10px;
      border-left: 1px dashed #e5e7eb;
    }

    .stats-trip-item {
      font-size: 12px;
      padding: 4px 4px;
      color: #4b5563;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .stats-trip-item span {
      white-space: nowrap;
    }

    .stats-trip-dates {
      font-feature-settings: "liga" 0;
    }

    .stats-empty {
      padding: 12px 4px 4px;
      font-size: 12px;
      color: #9ca3af;
    }

    .stats-total {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }

    @media (max-width: 700px) {
      .form-row {
        flex-direction: column;
      }

      .col-actions {
        text-align: left;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
      }

      td {
        border: none;
        padding: 6px 10px;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        display: block;
        margin-bottom: 2px;
        color: #4b5563;
        font-size: 11px;
        letter-spacing: 0.12em;
      }

      .table-wrapper {
        border-radius: 10px;
      }

      .stats-subtree {
        border-left: none;
        padding-left: 0;
        margin-left: 8px;
      }

      .stats-trip-item {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <h1>å‡ºå·®ç´€éŒ„ç®¡ç†</h1>
  <div class="page-subtitle">Business Trip Manager Â· minimal style</div>

  <!-- ä¸»åŠŸèƒ½ï¼šå‡ºå·®ç´€éŒ„ -->
  <div class="container">
    <div class="section-header">
      <h2>å‡ºå·®ç´€éŒ„</h2>
      <span>æ–°å¢ã€æœå°‹ã€ç·¨è¼¯èˆ‡åˆªé™¤å‡ºå·®è³‡è¨Š</span>
    </div>

    <!-- è¡¨å–®å€ -->
    <form id="tripForm">
      <div class="form-row">
        <div class="form-group">
          <label for="employeeName">å§“å (employeeName)</label>
          <input id="employeeName" type="text" required />
        </div>
        <div class="form-group">
          <label for="destination">ç›®çš„åœ° / åœ°é» (destination)</label>
          <input id="destination" type="text" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">é–‹å§‹æ—¥æœŸ (startDate)</label>
          <input id="startDate" type="date" required />
        </div>
        <div class="form-group">
          <label for="endDate">çµæŸæ—¥æœŸ (endDate)</label>
          <input id="endDate" type="date" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="description">ä¸»è¦å·¥ä½œå…§å®¹ (description)</label>
          <textarea id="description" placeholder="å¯ç°¡å–®è¨˜éŒ„å‡ºå·®ç›®çš„èˆ‡å·¥ä½œé‡é»"></textarea>
        </div>
      </div>

      <div class="actions-row">
        <div class="left-actions">
          <button type="submit" class="btn-primary" id="submitBtn">æ–°å¢å‡ºå·®ç´€éŒ„</button>
          <button type="button" class="btn-secondary" id="cancelEditBtn" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
          <span class="muted" id="editHint" style="display:none;">ç›®å‰ç‚ºç·¨è¼¯æ¨¡å¼</span>
        </div>
        <div class="right-actions">
          <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="æœå°‹å§“åæˆ–åœ°é»é—œéµå­—..."
          />
          <button type="button" class="btn-text nowrap" id="sortBtn">
            ä¾é–‹å§‹æ—¥æœŸæ’åº
            <span class="sort-indicator" id="sortIndicator">â–²ï¼ˆèˆŠâ†’æ–°ï¼‰</span>
          </button>
        </div>
      </div>
    </form>

    <!-- è¡¨æ ¼å€ -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>å§“å</th>
            <th>ç›®çš„åœ° / åœ°é»</th>
            <th class="nowrap">é–‹å§‹æ—¥æœŸ</th>
            <th class="nowrap">çµæŸæ—¥æœŸ</th>
            <th>å·¥ä½œå…§å®¹</th>
            <th class="col-actions">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tripTableBody">
          <!-- å‹•æ…‹æ¸²æŸ“ -->
        </tbody>
      </table>
      <div class="empty-state" id="emptyState" style="display:none;">
        ç›®å‰å°šç„¡å‡ºå·®ç´€éŒ„ï¼Œè«‹å…ˆä¸Šæ–¹æ–°å¢ä¸€ç­† ğŸ™Œ
      </div>
    </div>
    <div class="muted" style="margin-top:8px;">
      è³‡æ–™æœƒè‡ªå‹•å„²å­˜åœ¨ç€è¦½å™¨çš„ localStorage ä¸­ï¼Œé‡æ–°æ•´ç†ä¹Ÿä¸æœƒæ¶ˆå¤±ã€‚
    </div>
  </div>

  <!-- çµ±è¨ˆå€å¡Šï¼šæ¯å¹´æ¯äººå‡ºå·®å¤©æ•¸æ¨¹ç‹€çµæ§‹ -->
  <div class="container stats-container">
    <div class="section-header">
      <h2>å‡ºå·®å¤©æ•¸çµ±è¨ˆ</h2>
      <span>æŒ‰å¹´ä»½ Â· å“¡å·¥ Â· å‡ºå·®æœŸé–“ å±•é–‹æª¢è¦–</span>
    </div>
    <div class="stats-hint">å¤©æ•¸è¨ˆç®—æ–¹å¼ï¼šå«èµ·è¿„æ—¥ï¼ˆendDate âˆ’ startDate + 1 æ—¥ï¼‰ã€‚</div>
    <div class="stats-tree" id="statsContainer">
      <!-- å‹•æ…‹çµ±è¨ˆå…§å®¹ -->
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "businessTripRecords_v1";

      // ç‹€æ…‹
      let trips = [];
      let currentSortDirection = "asc"; // asc: èˆŠâ†’æ–°, desc: æ–°â†’èˆŠ
      let currentKeyword = "";
      let editingId = null;

      // DOM å…ƒç´ 
      const tripForm = document.getElementById("tripForm");
      const employeeNameInput = document.getElementById("employeeName");
      const destinationInput = document.getElementById("destination");
      const startDateInput = document.getElementById("startDate");
      const endDateInput = document.getElementById("endDate");
      const descriptionInput = document.getElementById("description");

      const submitBtn = document.getElementById("submitBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");
      const editHint = document.getElementById("editHint");

      const searchInput = document.getElementById("searchInput");
      const sortBtn = document.getElementById("sortBtn");
      const sortIndicator = document.getElementById("sortIndicator");

      const tripTableBody = document.getElementById("tripTableBody");
      const emptyState = document.getElementById("emptyState");

      const statsContainer = document.getElementById("statsContainer");

      // å·¥å…·å‡½å¼ï¼šlocalStorage
      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            trips = [];
            return;
          }
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            trips = parsed;
          } else {
            trips = [];
          }
        } catch (e) {
          console.error("è®€å– localStorage ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
          trips = [];
        }
      }

      function saveToStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(trips));
        } catch (e) {
          console.error("å¯«å…¥ localStorage ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
        }
      }

      function resetForm() {
        tripForm.reset();
        editingId = null;
        submitBtn.textContent = "æ–°å¢å‡ºå·®ç´€éŒ„";
        cancelEditBtn.style.display = "none";
        editHint.style.display = "none";
      }

      function setEditMode(trip) {
        editingId = trip.id;
        employeeNameInput.value = trip.employeeName || "";
        destinationInput.value = trip.destination || "";
        startDateInput.value = trip.startDate || "";
        endDateInput.value = trip.endDate || "";
        descriptionInput.value = trip.description || "";
        submitBtn.textContent = "æ›´æ–°å‡ºå·®ç´€éŒ„";
        cancelEditBtn.style.display = "inline-flex";
        editHint.style.display = "inline";
      }

      function toggleSortDirection() {
        currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
        sortIndicator.textContent =
          currentSortDirection === "asc"
            ? "â–²ï¼ˆèˆŠâ†’æ–°ï¼‰"
            : "â–¼ï¼ˆæ–°â†’èˆŠï¼‰";
        render();
      }

      // è¨ˆç®—æ—¥æœŸå€é–“å¤©æ•¸ï¼ˆå«èµ·è¨–æ—¥ï¼‰
      function calculateTripDays(startDateStr, endDateStr) {
        if (!startDateStr || !endDateStr) return 0;
        const start = new Date(startDateStr);
        const end = new Date(endDateStr);
        if (isNaN(start.getTime()) || isNaN(end.getTime())) return 0;
        const diffMs = end.getTime() - start.getTime();
        if (diffMs < 0) return 0;
        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1;
        return days;
      }

      // ç¯©é¸èˆ‡æ’åºä¸»è¡¨
      function filterAndSortTrips() {
        let filtered = trips;

        if (currentKeyword.trim() !== "") {
          const kw = currentKeyword.trim().toLowerCase();
          filtered = filtered.filter((trip) => {
            const name = (trip.employeeName || "").toLowerCase();
            const dest = (trip.destination || "").toLowerCase();
            return name.includes(kw) || dest.includes(kw);
          });
        }

        filtered = filtered.slice().sort((a, b) => {
          const da = new Date(a.startDate).getTime();
          const db = new Date(b.startDate).getTime();
          if (isNaN(da) && isNaN(db)) return 0;
          if (isNaN(da)) return 1;
          if (isNaN(db)) return -1;
          return currentSortDirection === "asc" ? da - db : db - da;
        });

        return filtered;
      }

      // å»ºç«‹çµ±è¨ˆè³‡æ–™ï¼šyear -> employee -> { totalDays, trips: [] }
      function buildStats() {
        const stats = {};
        trips.forEach((trip) => {
          const { employeeName, startDate, endDate, destination, description, id } = trip;
          if (!startDate) return;
          const year = new Date(startDate).getFullYear();
          if (!year || isNaN(year)) return;

          const empName = employeeName || "ï¼ˆæœªå¡«å§“åï¼‰";
          const days = calculateTripDays(startDate, endDate);
          if (days <= 0) return;

          if (!stats[year]) {
            stats[year] = {};
          }
          if (!stats[year][empName]) {
            stats[year][empName] = {
              totalDays: 0,
              trips: [],
            };
          }

          stats[year][empName].totalDays += days;
          stats[year][empName].trips.push({
            id,
            startDate,
            endDate,
            destination: destination || "",
            description: description || "",
            days,
          });
        });

        return stats;
      }

      // æ¸²æŸ“çµ±è¨ˆæ¨¹ç‹€çµæ§‹
      function renderStats() {
        if (!statsContainer) return;

        if (!trips.length) {
          statsContainer.innerHTML =
            '<div class="stats-empty">ç›®å‰æ²’æœ‰å¯çµ±è¨ˆçš„å‡ºå·®ç´€éŒ„ï¼Œæ–°å¢å¹¾ç­†ä¹‹å¾Œå†å›ä¾†çœ‹çœ‹å§ã€‚</div>';
          return;
        }

        const stats = buildStats();
        const years = Object.keys(stats).map(Number).sort((a, b) => b - a); // å¹´ä»½ç”±æ–°åˆ°èˆŠ

        if (years.length === 0) {
          statsContainer.innerHTML =
            '<div class="stats-empty">ç›®å‰æ²’æœ‰å¯çµ±è¨ˆçš„å‡ºå·®ç´€éŒ„ï¼Œæ–°å¢å¹¾ç­†ä¹‹å¾Œå†å›ä¾†çœ‹çœ‹å§ã€‚</div>';
          return;
        }

        // æ•´é«”ç¸½å¤©æ•¸ï¼ˆæ‰€æœ‰å¹´ï¼‰
        let globalTotalDays = 0;
        years.forEach((year) => {
          const empMap = stats[year];
          Object.values(empMap).forEach((v) => {
            globalTotalDays += v.totalDays;
          });
        });

        let html = "";

        years.forEach((year) => {
          const empMap = stats[year];
          const employees = Object.keys(empMap).sort((a, b) => a.localeCompare(b, "zh-Hant"));
          let yearTotalDays = 0;
          employees.forEach((name) => {
            yearTotalDays += empMap[name].totalDays;
          });

          const employeeCount = employees.length;

          html += `<details class="stats-year" open>
  <summary class="year-summary">
    <span>${year} å¹´</span>
    <span class="stats-badge stats-badge-soft">${yearTotalDays} å¤©</span>
    <span class="stats-badge">${employeeCount} äºº</span>
  </summary>
  <div class="stats-subtree">`;

          employees.forEach((name) => {
            const empData = empMap[name];
            const tripsForEmp = empData.trips.slice().sort((a, b) => {
              return new Date(a.startDate).getTime() - new Date(b.startDate).getTime();
            });

            html += `
    <details class="stats-employee">
      <summary class="employee-summary">
        <span>${name}</span>
        <span class="stats-badge stats-badge-soft">${empData.totalDays} å¤©</span>
        <span class="stats-badge">${tripsForEmp.length} ç­†ç´€éŒ„</span>
      </summary>
      <div class="stats-subtree">`;

            tripsForEmp.forEach((t) => {
              const destText = t.destination ? ` Â· ${t.destination}` : "";
              const descText = t.description
                ? t.description.length > 32
                  ? t.description.slice(0, 32) + "â€¦"
                  : t.description
                : "";
              html += `
        <div class="stats-trip-item">
          <span class="stats-trip-dates">${t.startDate} ï½ ${t.endDate}</span>
          <span>${t.days} å¤©${destText}${descText ? "ï½œ" + descText : ""}</span>
        </div>`;
            });

            html += `
      </div>
    </details>`;
          });

          html += `
  </div>
</details>`;
        });

        html += `<div class="stats-total">å°çµï¼šç›®å‰æ‰€æœ‰å¹´ä»½ç´¯è¨ˆå‡ºå·®å…± <strong>${globalTotalDays} å¤©</strong>ã€‚</div>`;

        statsContainer.innerHTML = html;
      }

      // æ¸²æŸ“ä¸»è¡¨
      function render() {
        const rows = filterAndSortTrips();
        tripTableBody.innerHTML = "";

        if (rows.length === 0) {
          emptyState.style.display = "block";
        } else {
          emptyState.style.display = "none";
        }

        rows.forEach((trip) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = trip.employeeName || "";
          nameTd.setAttribute("data-label", "å§“å");

          const destTd = document.createElement("td");
          destTd.textContent = trip.destination || "";
          destTd.setAttribute("data-label", "ç›®çš„åœ° / åœ°é»");

          const startTd = document.createElement("td");
          startTd.textContent = trip.startDate || "";
          startTd.className = "nowrap";
          startTd.setAttribute("data-label", "é–‹å§‹æ—¥æœŸ");

          const endTd = document.createElement("td");
          endTd.textContent = trip.endDate || "";
          endTd.className = "nowrap";
          endTd.setAttribute("data-label", "çµæŸæ—¥æœŸ");

          const descTd = document.createElement("td");
          descTd.textContent = trip.description || "";
          descTd.setAttribute("data-label", "å·¥ä½œå…§å®¹");

          const actionsTd = document.createElement("td");
          actionsTd.className = "col-actions";
          actionsTd.setAttribute("data-label", "æ“ä½œ");

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn-text";
          editBtn.textContent = "ç·¨è¼¯";
          editBtn.addEventListener("click", () => {
            setEditMode(trip);
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "btn-text btn-danger";
          deleteBtn.textContent = "åˆªé™¤";
          deleteBtn.addEventListener("click", () => {
            const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å‡ºå·®ç´€éŒ„å—ï¼Ÿ");
            if (!ok) return;
            trips = trips.filter((t) => t.id !== trip.id);
            saveToStorage();
            if (editingId === trip.id) {
              resetForm();
            }
            render();
          });

          actionsTd.appendChild(editBtn);
          actionsTd.appendChild(deleteBtn);

          tr.appendChild(nameTd);
          tr.appendChild(destTd);
          tr.appendChild(startTd);
          tr.appendChild(endTd);
          tr.appendChild(descTd);
          tr.appendChild(actionsTd);

          tripTableBody.appendChild(tr);
        });

        // æ¯æ¬¡ä¸»è¡¨æ¸²æŸ“å¾Œï¼ŒåŒæ­¥æ›´æ–°çµ±è¨ˆæ¨¹ç‹€çµæ§‹
        renderStats();
      }

      // äº‹ä»¶ç¶å®š
      tripForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const employeeName = employeeNameInput.value.trim();
        const destination = destinationInput.value.trim();
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const description = descriptionInput.value.trim();

        if (!employeeName || !destination || !startDate || !endDate) {
          alert("è«‹å…ˆå¡«å¯«å§“åã€ç›®çš„åœ°ã€é–‹å§‹èˆ‡çµæŸæ—¥æœŸã€‚");
          return;
        }

        if (new Date(endDate) < new Date(startDate)) {
          const ok = confirm("çµæŸæ—¥æœŸæ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œç¢ºå®šè¦å„²å­˜å—ï¼Ÿ");
          if (!ok) return;
        }

        if (editingId) {
          // æ›´æ–°æ¨¡å¼
          const idx = trips.findIndex((t) => t.id === editingId);
          if (idx !== -1) {
            trips[idx] = {
              ...trips[idx],
              employeeName,
              destination,
              startDate,
              endDate,
              description,
              updatedAt: new Date().toISOString(),
            };
          }
        } else {
          // æ–°å¢æ¨¡å¼
          const newTrip = {
            id: "trip_" + Date.now() + "_" + Math.random().toString(16).slice(2),
            employeeName,
            destination,
            startDate,
            endDate,
            description,
            createdAt: new Date().toISOString(),
          };
          trips.push(newTrip);
        }

        saveToStorage();
        resetForm();
        render();
      });

      cancelEditBtn.addEventListener("click", function () {
        resetForm();
      });

      searchInput.addEventListener("input", function () {
        currentKeyword = searchInput.value;
        render();
      });

      sortBtn.addEventListener("click", function () {
        toggleSortDirection();
      });

      // åˆå§‹åŒ–
      loadFromStorage();
      render();
    })();
  </script>
</body>
</html>
