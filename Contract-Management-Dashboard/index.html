<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>åˆç´„ç®¡ç†çœ‹æ¿ | Contract Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* --------- ğŸ¨ CSS è®Šæ•¸ï¼šè«è˜­è¿ªé…è‰² --------- */
    :root {
      --primary: #6A7B88;         /* è«è˜­è¿ªæ·±ç°è— */
      --primary-light: #E8ECEF;   
      --accent: #D4A5A5;          /* è«è˜­è¿ªç²‰ */
      
      --bg-body: #F5F7FA;         
      --bg-card: #FFFFFF;         
      
      --text-main: #2C3E50;       
      --text-muted: #7F8C8D;      
      --border: #E2E8F0;
      
      /* ç‹€æ…‹é¡è‰² */
      --st-draft: #CBD5E0;        /* è‰æ“¬ - ç° */
      --st-review: #F6AD55;       /* é€å¯© - æ©˜ */
      --st-nego: #63B3ED;         /* å”è­° - è— */
      --st-signed: #48BB78;       /* ç°½è¨‚ - ç¶  */
      --st-cancel: #E53E3E;       /* å–æ¶ˆ - ç´… */

      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Inter', 'Noto Sans TC', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-main); 
      padding-bottom: 40px;
      /* é è¨­éš±è—å…§å®¹ï¼Œç›´åˆ°å¯†ç¢¼é©—è­‰é€šé */
      visibility: hidden; 
    }
    
    /* è®“å¯†ç¢¼é©—è­‰è¦–çª—æœ¬èº«æ˜¯å¯è¦‹çš„ */
    .password-overlay { visibility: visible; }

    /* --------- Header --------- */
    .header {
        background: var(--bg-card);
        padding: 1rem 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
    }
    .header-actions .btn {
        padding: 6px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.85rem;
        margin-left: 8px;
        transition: 0.2s;
        border: 1px solid transparent;
        cursor: pointer;
    }
    .btn-sheet { background: #EDF2F7; color: var(--primary); }
    .btn-sheet:hover { background: #E2E8F0; }
    .btn-back { color: var(--text-muted); }
    .btn-back:hover { color: var(--text-main); }

    /* --------- KPI Cards --------- */
    .container { max-width: 1280px; margin: 20px auto; padding: 0 16px; }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .kpi-card {
        background: var(--bg-card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border-left: 4px solid var(--kpi-color);
        position: relative;
    }
    .kpi-title { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
    .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
    .kpi-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }

    /* --------- Main Grid (Charts) --------- */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    .card.full-width { grid-column: 1 / -1; }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .card-title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }

    /* --------- Filters & Table --------- */
    .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .filter-input, .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        background: #fff;
        color: var(--text-main);
    }
    .filter-input { flex: 1; min-width: 200px; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
    th { text-align: left; padding: 12px; background: #F8FAFC; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:hover td { background: #F8FAFC; }

    /* Status Badges */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; min-width: 60px; text-align: center; }
    .badge-draft { background: var(--st-draft); color: #4A5568; }
    .badge-review { background: var(--st-review); color: #7B341E; }
    .badge-nego { background: var(--st-nego); color: #102A43; }
    .badge-signed { background: var(--st-signed); color: #FFFFFF; }
    .badge-cancel { background: var(--st-cancel); color: #FFFFFF; }

    /* Warning Tags */
    .tag-expiry { font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; display: inline-block;}
    .tag-danger { color: #C53030; background: #FFF5F5; border: 1px solid #FC8181; }
    .tag-warning { color: #C05621; background: #FFFAF0; border: 1px solid #FBD38D; }
    .tag-ok { color: #2F855A; background: #F0FFF4; border: 1px solid #C6F6D5; }
    .tag-neutral { color: var(--text-muted); background: #F1F5F9; border: 1px solid #E2E8F0; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-muted); }
  </style>
</head>
<body>

  <header class="header">
      <div class="brand">
          <i class="fa-solid fa-file-contract"></i>
          <div>
              <div>åˆç´„ç®¡ç†çœ‹æ¿</div>
              <div style="font-size: 0.75rem; font-weight: 400; opacity: 0.8;">Contract Lifecycle Management</div>
          </div>
      </div>
      <div class="header-actions">
          <a href="https://docs.google.com/spreadsheets/d/1fvsEjqiloEsPgBHh4iDXfzVHYFuLMnegEwLWzIoi18A/edit?gid=0#gid=0" target="_blank" class="btn btn-sheet">
              <i class="fa-solid fa-pen-to-square"></i> ç·¨è¼¯è³‡æ–™
          </a>
          <a href="../index.html" class="btn btn-back">
              <i class="fa-solid fa-house"></i> å›åˆ°æ•¸æ“šä¸­æ§å°
          </a>
      </div>
  </header>

  <main class="container">
      
      <div class="kpi-grid" id="kpiArea">
          <div class="loading">æ­£åœ¨è®€å–åˆç´„æ•¸æ“š...</div>
      </div>

      <div class="dashboard-layout">
          <div class="card">
              <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-chart-pie"></i> åˆç´„ç‹€æ…‹åˆ†ä½ˆ</div>
              </div>
              <div style="height: 250px; position: relative;">
                  <canvas id="statusChart"></canvas>
              </div>
          </div>
          <div class="card">
              <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-building-user"></i> ä¸»è¦äº”å¤§åˆä½œå» å•†</div>
              </div>
              <div style="height: 250px; position: relative;">
                  <canvas id="partnerChart"></canvas>
              </div>
          </div>
      </div>

      <div class="card full-width">
          <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-list-check"></i> åˆç´„è©³ç´°åˆ—è¡¨</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);" id="lastUpdate">æ›´æ–°æ–¼: -</div>
          </div>
          
          <div class="filter-bar">
              <input type="text" id="searchInput" class="filter-input" placeholder="ğŸ” æœå°‹åˆç´„åç¨±ã€å» å•†ã€è² è²¬äºº...">
              <select id="statusFilter" class="filter-select">
                  <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                  <option value="åˆç´„ç°½è¨‚">ğŸŸ¢ åˆç´„ç°½è¨‚</option>
                  <option value="é€å¯©ä¸­">ğŸŸ  é€å¯©ä¸­</option>
                  <option value="å”è­°ä¸­">ğŸ”µ å”è­°ä¸­</option>
                  <option value="è‰æ“¬ä¸­">âšª è‰æ“¬ä¸­</option>
              </select>
              <select id="expiryFilter" class="filter-select">
                  <option value="">å…¨éƒ¨æœŸé™</option>
                  <option value="expired">å·²éæœŸ (ç°½è¨‚å¾Œ)</option>
                  <option value="warning">å³å°‡åˆ°æœŸ (30å¤©å…§)</option>
              </select>
          </div>

          <div class="table-container">
              <table id="contractTable">
                  <thead>
                      <tr>
                          <th>åˆç´„ç‹€æ…‹</th>
                          <th>åˆç´„åç¨±</th>
                          <th>åˆç´„ç¨®é¡</th>
                          <th>ç”²æ–¹</th> <th>ä¹™æ–¹</th>
                          <th>é‡‘é¡/è²»ç‡</th>
                          <th>ç”Ÿæ•ˆæ—¥</th>
                          <th>åˆ°æœŸæ—¥</th>
                          <th>é è­¦ç‹€æ…‹</th>
                          <th>ç¶“è¾¦å–®ä½/äºº</th>
                      </tr>
                  </thead>
                  <tbody>
                      </tbody>
              </table>
          </div>
      </div>

  </main>

  <script>
    // ğŸ”’ å¯†ç¢¼ä¿è­·
    (function checkPassword() {
        const MY_PASSWORD = "8888"; 
        let userPass = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥å­˜å–çœ‹æ¿ï¼š", "");
        if (userPass === MY_PASSWORD) {
            document.body.style.visibility = "visible";
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼Œå°‡è¿”å›é¦–é ã€‚");
            window.location.href = "../index.html"; 
        }
    })();

    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJeO861CXhXlcMVU-soyQ4pVsfRZJxJl1WbQF8p6lNVPjlU0wyHOPFXfPSFSHAq-XABOSaM4UR-FcP/pub?output=csv";
    
    const TODAY = new Date();
    TODAY.setHours(0,0,0,0); 

    let allData = [];
    let statusChartRef = null;
    let partnerChartRef = null;

    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        setupFilters();
    });

    async function fetchData() {
        try {
            const res = await fetch(CSV_URL);
            if(!res.ok) throw new Error("Network response was not ok");
            const text = await res.text();
            parseCSV(text);
        } catch (error) {
            console.warn("CSV è®€å–å¤±æ•—ï¼Œä½¿ç”¨é è¨­è³‡æ–™å±•ç¤ºæ¨¡å¼", error);
            useMockData();
        }
    }

    function parseCSV(text) {
        const rows = text.trim().split(/\r?\n/).slice(1); 
        allData = rows.map(row => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
            
            // A[0]:åˆç´„åç¨±, B[1]:ç”²æ–¹, C[2]:ä¹™æ–¹ ...
            const endDateStr = cols[6]; 
            const endDate = endDateStr ? new Date(endDateStr) : null;
            
            return {
                name: cols[0] || "æœªå‘½å",
                partyA: cols[1] || "-",
                partyB: cols[2] || "-",
                status: cols[3] || "è‰æ“¬ä¸­",
                type: cols[4] || "-",
                startDate: cols[5], 
                endDate: endDate,
                amount: cols[7],
                owner: cols[8] || "-"
            };
        });

        updateDashboard();
    }

    function useMockData() {
        allData = [
            { name: "èŠåŠ å“¥ç”¢ç·šå®‰è£å”è­°", partyA: "å¯¶æ–°æ–°èƒ½æº", partyB: "å®‰å¾½å·¨ä¸€", status: "è‰æ“¬ä¸­", type: "å®‰è£äººåŠ›", startDate: "2025/06/01", endDate: new Date("2025/10/31"), amount: "500/Day", owner: "Leo" },
            { name: "å¹´åº¦ä¼ºæœå™¨æ¡è³¼", partyA: "å¯¶æ–°æ–°èƒ½æº", partyB: "æˆ´çˆ¾ç§‘æŠ€", status: "é€å¯©ä¸­", type: "è¨­å‚™è²·è³£", startDate: "2024/01/01", endDate: new Date("2025/12/31"), amount: "1200000", owner: "IT" },
            { name: "å®¢æˆ¶éŠ·å”®åˆç´„", partyA: "Tesla Inc.", partyB: "å¯¶æ–°æ–°èƒ½æº", status: "åˆç´„ç°½è¨‚", type: "éŠ·å”®", startDate: "2024/01/01", endDate: new Date("2026/12/31"), amount: "5000000", owner: "Sales" },
        ];
        updateDashboard();
    }

    function updateDashboard() {
        renderKPI();
        renderCharts();
        renderTable(allData);
        document.getElementById('lastUpdate').textContent = `è³‡æ–™æ›´æ–°æ–¼: ${new Date().toLocaleString()}`;
    }

    function renderKPI() {
        const total = allData.length;
        const pending = allData.filter(d => ["è‰æ“¬ä¸­", "é€å¯©ä¸­", "å”è­°ä¸­"].includes(d.status)).length;
        
        let expired = 0;
        let warning = 0;
        
        allData.forEach(d => {
            if (d.status === "åˆç´„ç°½è¨‚" && d.endDate) {
                const diffDays = (d.endDate - TODAY) / (1000 * 60 * 60 * 24);
                if (diffDays < 0) expired++;
                else if (diffDays <= 30) warning++;
            }
        });

        const kpiHTML = `
            <div class="kpi-card" style="--kpi-color: #6A7B88;">
                <div class="kpi-title">ç¶“æ‰‹åˆç´„æ•¸é‡ç¸½è¨ˆ</div>
                <div class="kpi-value">${total}</div>
                <div class="kpi-sub">åŒ…å«è‰æ“¬èˆ‡å”è­°ä¸­åˆç´„</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #F6AD55;">
                <div class="kpi-title">å¾…ç°½æ ¸/å”è­°ä¸­</div>
                <div class="kpi-value">${pending}</div>
                <div class="kpi-sub">éœ€é—œæ³¨é€²åº¦</div>
            </div>
             <div class="kpi-card" style="--kpi-color: #E53E3E;">
                <div class="kpi-title">å·²éæœŸ</div>
                <div class="kpi-value">${expired}</div>
                <div class="kpi-sub">åˆç´„å·²ç”Ÿæ•ˆä½†æœŸé™å·²é</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #D69E2E;">
                <div class="kpi-title">å³å°‡åˆ°æœŸ (<30å¤©)</div>
                <div class="kpi-value">${warning}</div>
                <div class="kpi-sub">è«‹ç¢ºèªæ˜¯å¦çºŒç´„</div>
            </div>
        `;
        document.getElementById('kpiArea').innerHTML = kpiHTML;
    }

    function renderCharts() {
        const statusCounts = {};
        allData.forEach(d => statusCounts[d.status] = (statusCounts[d.status] || 0) + 1);
        
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        if(statusChartRef) statusChartRef.destroy();
        
        statusChartRef = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['#48BB78', '#F6AD55', '#63B3ED', '#CBD5E0', '#E53E3E'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // åˆä½œå» å•†é‚è¼¯ (æ’é™¤å¯¶æ–°)
        const partnerCounts = {};
        const myCompanyKey = "å¯¶æ–°"; 

        allData.forEach(d => {
            let realPartner = "";
            const pa = d.partyA || "";
            const pb = d.partyB || "";

            if (pa.includes(myCompanyKey)) {
                realPartner = pb;
            } else if (pb.includes(myCompanyKey)) {
                realPartner = pa;
            } else {
                realPartner = pb; // é è¨­å€¼
            }

            if(realPartner && realPartner !== "-" && realPartner !== "") {
                partnerCounts[realPartner] = (partnerCounts[realPartner] || 0) + 1;
            }
        });

        const sortedPartners = Object.entries(partnerCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        const barColors = ['#6A7B88', '#F6AD55', '#D4A5A5', '#63B3ED', '#48BB78'];
        const bgColors = sortedPartners.map((_, i) => barColors[i % barColors.length]);

        const ctxPartner = document.getElementById('partnerChart').getContext('2d');
        if(partnerChartRef) partnerChartRef.destroy();

        partnerChartRef = new Chart(ctxPartner, {
            type: 'bar',
            data: {
                labels: sortedPartners.map(p => p[0]),
                datasets: [{
                    label: 'åˆç´„æ•¸',
                    data: sortedPartners.map(p => p[1]),
                    backgroundColor: bgColors,
                    borderRadius: 4,
                    barThickness: 25 
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: { x: { ticks: { precision: 0 } } },
                plugins: { legend: { display: false } } 
            }
        });
    }

    function renderTable(data) {
        const tbody = document.querySelector('#contractTable tbody');
        tbody.innerHTML = "";

        data.forEach(d => {
            const tr = document.createElement('tr');
            
            let badgeClass = "badge-draft";
            if(d.status === "é€å¯©ä¸­") badgeClass = "badge-review";
            else if(d.status === "å”è­°ä¸­") badgeClass = "badge-nego";
            else if(d.status === "åˆç´„ç°½è¨‚") badgeClass = "badge-signed";
            else if(d.status === "å–æ¶ˆç°½è¨‚") badgeClass = "badge-cancel";
            
            const badgeHtml = `<span class="badge ${badgeClass}">${d.status}</span>`;

            let displayStartDate = "-";
            let displayEndDate = "-";
            let warningHtml = "";

            if (d.status === "åˆç´„ç°½è¨‚") {
                displayStartDate = d.startDate || "-";
                displayEndDate = d.endDate ? d.endDate.toLocaleDateString() : "-";
                
                if (d.endDate) {
                    const diffDays = Math.ceil((d.endDate - TODAY) / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) {
                        warningHtml = `<span class="tag-expiry tag-danger">éæœŸ ${Math.abs(diffDays)} å¤©</span>`;
                    } else if (diffDays <= 30) {
                        warningHtml = `<span class="tag-expiry tag-warning">å‰© ${diffDays} å¤©</span>`;
                    } else {
                        warningHtml = `<span class="tag-expiry tag-ok">æ­£å¸¸</span>`;
                    }
                } else {
                    warningHtml = `<span class="tag-expiry tag-neutral">ç„¡æœŸé™</span>`;
                }
            } else if (d.status === "å–æ¶ˆç°½è¨‚") {
                displayStartDate = "-";
                displayEndDate = "-";
                warningHtml = `<span class="tag-expiry tag-neutral" style="text-decoration:line-through">å·²çµ‚æ­¢</span>`;
            } else {
                displayStartDate = "-";
                displayEndDate = "-";
                warningHtml = `<span class="tag-expiry tag-neutral">${d.status}</span>`;
            }

            let amountDisplay = "-";
            if (d.amount) {
                const cleanNum = d.amount.replace(/,/g, '');
                if (!isNaN(parseFloat(cleanNum)) && isFinite(cleanNum)) {
                    amountDisplay = `$${parseInt(cleanNum).toLocaleString()}`;
                } else {
                    amountDisplay = d.amount;
                }
            }

            // ğŸŸ¢ ä¿®æ”¹ï¼šåœ¨è¡¨æ ¼ä¸­åŠ å…¥ d.partyA
            tr.innerHTML = `
                <td>${badgeHtml}</td>
                <td style="font-weight:600; color:var(--text-main); max-width:200px; white-space:normal;">${d.name}</td>
                <td><span style="font-size:0.8rem; color:#4a5568; background:#edf2f7; padding:2px 6px; border-radius:4px;">${d.type}</span></td>
                <td>${d.partyA}</td> <td>${d.partyB}</td>
                <td style="font-weight:500;">${amountDisplay}</td>
                <td style="color:var(--text-muted);">${displayStartDate}</td>
                <td style="color:var(--text-muted);">${displayEndDate}</td>
                <td>${warningHtml}</td>
                <td>${d.owner}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const expiryFilter = document.getElementById('expiryFilter');

        function filterData() {
            const q = searchInput.value.toLowerCase();
            const s = statusFilter.value;
            const e = expiryFilter.value;

            const filtered = allData.filter(d => {
                const matchText = d.name.toLowerCase().includes(q) || d.partyB.toLowerCase().includes(q) || d.owner.toLowerCase().includes(q);
                const matchStatus = s === "" || d.status === s;
                
                let matchExpiry = true;
                if (e === 'expired') {
                    matchExpiry = d.status === "åˆç´„ç°½è¨‚" && d.endDate && d.endDate < TODAY;
                } else if (e === 'warning') {
                    if (d.status !== "åˆç´„ç°½è¨‚" || !d.endDate) {
                        matchExpiry = false;
                    } else {
                        const diffDays = (d.endDate - TODAY) / (1000 * 60 * 60 * 24);
                        matchExpiry = diffDays >= 0 && diffDays <= 30;
                    }
                }
                return matchText && matchStatus && matchExpiry;
            });
            renderTable(filtered);
        }

        searchInput.addEventListener('input', filterData);
        statusFilter.addEventListener('change', filterData);
        expiryFilter.addEventListener('change', filterData);
    }
  </script>
</body>
</html>