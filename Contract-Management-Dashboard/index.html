<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¶“æ‰‹åˆç´„ç®¡ç†çœ‹æ¿ | Contract Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* --------- ğŸ¨ CSS è®Šæ•¸ï¼šè«è˜­è¿ªé…è‰² (å°ˆæ¥­ã€æ²ˆç©©) --------- */
    :root {
      --primary: #6A7B88;         /* è«è˜­è¿ªæ·±ç°è— (ä¸»è‰²) */
      --primary-light: #E8ECEF;   /* æ·ºç°åº•è‰² */
      --accent: #D4A5A5;          /* è«è˜­è¿ªç²‰ (å¼·èª¿/éæœŸ) */
      --secondary: #9FB1BC;       /* è¼”åŠ©è—ç° */
      
      --bg-body: #F5F7FA;         /* é é¢èƒŒæ™¯ */
      --bg-card: #FFFFFF;         /* å¡ç‰‡èƒŒæ™¯ */
      
      --text-main: #2C3E50;       /* ä¸»è¦æ–‡å­— */
      --text-muted: #7F8C8D;      /* æ¬¡è¦æ–‡å­— */
      --border: #E2E8F0;
      
      /* ç‹€æ…‹é¡è‰² */
      --st-draft: #CBD5E0;        /* è‰æ“¬ (ç°) */
      --st-review: #F6AD55;       /* é€å¯© (æ©˜) */
      --st-nego: #63B3ED;         /* å”è­° (è—) */
      --st-signed: #48BB78;       /* å®Œæˆ (ç¶ ) */
      --st-cancel: #E53E3E;       /* å–æ¶ˆ (ç´…) */

      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Inter', 'Noto Sans TC', sans-serif; 
      background: var(--bg-body); 
      color: var(--text-main); 
      padding-bottom: 40px;
    }

    /* --------- Header --------- */
    .header {
        background: var(--bg-card);
        padding: 1rem 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
    }
    .brand i { font-size: 1.4rem; }
    .header-actions .btn {
        padding: 6px 12px;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.85rem;
        margin-left: 8px;
        transition: 0.2s;
        border: 1px solid transparent;
        cursor: pointer;
    }
    .btn-sheet { background: #EDF2F7; color: var(--primary); }
    .btn-sheet:hover { background: #E2E8F0; }
    .btn-back { color: var(--text-muted); }
    .btn-back:hover { color: var(--text-main); }

    /* --------- KPI Cards --------- */
    .container { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
    
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .kpi-card {
        background: var(--bg-card);
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border-left: 4px solid var(--kpi-color);
    }
    .kpi-title { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
    .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
    .kpi-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }

    /* --------- Main Grid (Charts & Table) --------- */
    .dashboard-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
    }
    @media (max-width: 768px) { .dashboard-layout { grid-template-columns: 1fr; } }

    .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
    }
    .card.full-width { grid-column: 1 / -1; }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .card-title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }

    /* --------- Filters --------- */
    .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .filter-input, .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.9rem;
        background: #fff;
        color: var(--text-main);
    }
    .filter-input { flex: 1; min-width: 200px; }

    /* --------- Table --------- */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
    th { text-align: left; padding: 12px; background: #F8FAFC; color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:hover td { background: #F8FAFC; }

    /* Status Badges */
    .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .badge-draft { background: #EDF2F7; color: #4A5568; }
    .badge-review { background: #FEFCBF; color: #B7791F; }
    .badge-nego { background: #EBF8FF; color: #2B6CB0; }
    .badge-signed { background: #C6F6D5; color: #276749; }
    .badge-cancel { background: #FED7D7; color: #9B2C2C; }

    /* Warning Tags */
    .tag-expiry { font-size: 0.75rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
    .tag-danger { color: #C53030; background: #FFF5F5; border: 1px solid #FC8181; }
    .tag-warning { color: #C05621; background: #FFFAF0; border: 1px solid #FBD38D; }
    .tag-ok { color: #2F855A; background: #F0FFF4; opacity: 0.7; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-muted); }
  </style>
</head>
<body>

  <header class="header">
      <div class="brand">
          <i class="fa-solid fa-file-contract"></i>
          <div>
              <div>ç¶“æ‰‹åˆç´„ç®¡ç†çœ‹æ¿</div>
              <div style="font-size: 0.75rem; font-weight: 400; opacity: 0.8;">Contract Lifecycle Management</div>
          </div>
      </div>
      <div class="header-actions">
          <a href="https://docs.google.com/spreadsheets/d/1fvsEjqiloEsPgBHh4iDXfzVHYFuLMnegEwLWzIoi18A/edit?gid=0#gid=0" target="_blank" class="btn btn-sheet">
              <i class="fa-solid fa-pen-to-square"></i> ç·¨è¼¯è³‡æ–™
          </a>
          <a href="../index.html" class="btn btn-back">
              <i class="fa-solid fa-house"></i> å›é¦–é 
          </a>
      </div>
  </header>

  <main class="container">
      
      <div class="kpi-grid" id="kpiArea">
          <div class="loading">æ­£åœ¨è®€å–åˆç´„æ•¸æ“š...</div>
      </div>

      <div class="dashboard-layout">
          <div class="card">
              <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-chart-pie"></i> åˆç´„ç‹€æ…‹åˆ†ä½ˆ</div>
              </div>
              <div style="height: 250px; position: relative;">
                  <canvas id="statusChart"></canvas>
              </div>
          </div>
          <div class="card">
              <div class="card-header">
                  <div class="card-title"><i class="fa-solid fa-building-user"></i> å‰äº”å¤§åˆä½œå» å•† (ä¹™æ–¹)</div>
              </div>
              <div style="height: 250px; position: relative;">
                  <canvas id="partnerChart"></canvas>
              </div>
          </div>
      </div>

      <div class="card full-width">
          <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-list-check"></i> åˆç´„è©³ç´°åˆ—è¡¨</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);" id="lastUpdate">æ›´æ–°æ–¼: -</div>
          </div>
          
          <div class="filter-bar">
              <input type="text" id="searchInput" class="filter-input" placeholder="ğŸ” æœå°‹åˆç´„åç¨±ã€å» å•†...">
              <select id="statusFilter" class="filter-select">
                  <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                  <option value="é€å¯©ä¸­">é€å¯©ä¸­</option>
                  <option value="å®Œæˆåˆç´„ç°½å®š">å·²ç°½å®š</option>
                  <option value="è‰æ“¬ä¸­">è‰æ“¬ä¸­</option>
              </select>
              <select id="expiryFilter" class="filter-select">
                  <option value="">æ‰€æœ‰æœŸé™</option>
                  <option value="expired">å·²éæœŸ</option>
                  <option value="warning">å³å°‡åˆ°æœŸ (<30å¤©)</option>
              </select>
          </div>

          <div class="table-container">
              <table id="contractTable">
                  <thead>
                      <tr>
                          <th>ç‹€æ…‹</th>
                          <th>åˆç´„åç¨±</th>
                          <th>ä¹™æ–¹ (å» å•†)</th>
                          <th>ç”Ÿæ•ˆæ—¥</th>
                          <th>åˆ°æœŸæ—¥</th>
                          <th>å‰©é¤˜å¤©æ•¸/é è­¦</th>
                          <th>è² è²¬äºº</th>
                      </tr>
                  </thead>
                  <tbody>
                      </tbody>
              </table>
          </div>
      </div>

  </main>

  <script>
    // â—â— è«‹å°‡ä¸‹æ–¹çš„ URL æ›¿æ›æˆä½ çš„ Google Sheet ç™¼å¸ƒ CSV é€£çµ
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJeO861CXhXlcMVU-soyQ4pVsfRZJxJl1WbQF8p6lNVPjlU0wyHOPFXfPSFSHAq-XABOSaM4UR-FcP/pub?output=csv";
    
    // å®šç¾©ä»Šå¤©çš„æ—¥æœŸ (ç”¨æ–¼è¨ˆç®—éæœŸ)
    const TODAY = new Date();
    TODAY.setHours(0,0,0,0); // æ¸…é™¤æ™‚é–“ï¼Œåªæ¯”å°æ—¥æœŸ

    let allData = [];
    let statusChartRef = null;
    let partnerChartRef = null;

    document.addEventListener("DOMContentLoaded", () => {
        fetchData();
        setupFilters();
    });

    async function fetchData() {
        try {
            // ç”±æ–¼é€™æ˜¯ç¤ºç¯„ï¼Œè‹¥é€£çµç„¡æ•ˆæœƒä½¿ç”¨å‡è³‡æ–™
            const res = await fetch(CSV_URL);
            if(!res.ok) throw new Error("Network response was not ok");
            const text = await res.text();
            parseCSV(text);
        } catch (error) {
            console.warn("ä½¿ç”¨é è¨­å‡è³‡æ–™æ¨¡å¼ (å› ç‚º CSV è®€å–å¤±æ•—)", error);
            useMockData();
        }
    }

    // è§£æ CSV
    function parseCSV(text) {
        const rows = text.trim().split(/\r?\n/).slice(1); // å»æ‰æ¨™é¡Œ
        allData = rows.map(row => {
            // è™•ç† CSV çš„é€—è™Ÿåˆ†éš” (ç°¡å–®ç‰ˆ)
            const cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
            
            // å°æ‡‰å‰é¢å®šç¾©çš„ Excel æ¬„ä½ç´¢å¼•
            const endDateStr = cols[5]; // å‡è¨­ F æ¬„æ˜¯çµæŸæ—¥
            const endDate = endDateStr ? new Date(endDateStr) : null;
            
            return {
                name: cols[0] || "æœªå‘½ååˆç´„",
                partyA: cols[1] || "-",
                partyB: cols[2] || "-",
                status: cols[3] || "è‰æ“¬ä¸­",
                startDate: cols[4],
                endDate: endDate,
                amount: cols[6] || 0,
                owner: cols[7] || "-",
                rawDate: endDateStr
            };
        });

        updateDashboard();
    }

    // å‚™ç”¨å‡è³‡æ–™ (è‹¥ç„¡ CSV æ™‚é¡¯ç¤º)
    function useMockData() {
        allData = [
            { name: "å¹´åº¦ä¼ºæœå™¨æ¡è³¼åˆç´„", partyB: "æˆ´çˆ¾ç§‘æŠ€", status: "é€å¯©ä¸­", endDate: new Date("2025-12-31"), owner: "Leo" },
            { name: "è¾¦å…¬å®¤æ¸…æ½”æœå‹™å”è­°", partyB: "æ½”æ·¨å®¶", status: "å®Œæˆåˆç´„ç°½å®š", endDate: new Date("2023-12-15"), owner: "Admin" }, // éæœŸ
            { name: "é›²ç«¯æœå‹™çºŒç´„", partyB: "Google Cloud", status: "å”è­°ä¸­", endDate: new Date(new Date().setDate(TODAY.getDate() + 15)), owner: "IT" }, // å¿«éæœŸ
            { name: "æ–°ç”¢å“è¡ŒéŠ·æ¡ˆ", partyB: "å¥§ç¾å»£å‘Š", status: "è‰æ“¬ä¸­", endDate: null, owner: "Marketing" },
            { name: "æ©Ÿå°ç¶­è­·åˆç´„", partyB: "å°ç©é›»", status: "å®Œæˆåˆç´„ç°½å®š", endDate: new Date("2025-06-30"), owner: "Leo" },
        ];
        updateDashboard();
    }

    function updateDashboard() {
        // 1. ç”¢ç”Ÿ KPI
        renderKPI();
        // 2. ç”¢ç”Ÿåœ–è¡¨
        renderCharts();
        // 3. ç”¢ç”Ÿè¡¨æ ¼
        renderTable(allData);
        
        // æ›´æ–°æ™‚é–“
        document.getElementById('lastUpdate').textContent = `è³‡æ–™æ›´æ–°æ–¼: ${new Date().toLocaleString()}`;
    }

    // --- æ¸²æŸ“ KPI ---
    function renderKPI() {
        const total = allData.length;
        const reviewing = allData.filter(d => d.status.includes("é€å¯©") || d.status.includes("å”è­°")).length;
        
        // è¨ˆç®—éæœŸèˆ‡å³å°‡éæœŸ
        let expired = 0;
        let warning = 0;
        
        allData.forEach(d => {
            if(!d.endDate) return;
            const diffDays = (d.endDate - TODAY) / (1000 * 60 * 60 * 24);
            if (diffDays < 0) expired++;
            else if (diffDays <= 30) warning++;
        });

        const kpiHTML = `
            <div class="kpi-card" style="--kpi-color: #6A7B88;">
                <div class="kpi-title">ç¸½åˆç´„æ•¸</div>
                <div class="kpi-value">${total}</div>
                <div class="kpi-sub">ç›®å‰åˆ—ç®¡ä¸­çš„åˆç´„</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #F6AD55;">
                <div class="kpi-title">å¾…è™•ç† (é€å¯©/å”è­°)</div>
                <div class="kpi-value">${reviewing}</div>
                <div class="kpi-sub">éœ€è¦é—œæ³¨é€²åº¦</div>
            </div>
             <div class="kpi-card" style="--kpi-color: #E53E3E;">
                <div class="kpi-title">å·²éæœŸåˆç´„</div>
                <div class="kpi-value">${expired}</div>
                <div class="kpi-sub">è«‹ç¢ºèªæ˜¯å¦çºŒç´„æˆ–çµæ¡ˆ</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #D69E2E;">
                <div class="kpi-title">30å¤©å…§åˆ°æœŸ</div>
                <div class="kpi-value">${warning}</div>
                <div class="kpi-sub">å³å°‡åˆ°æœŸé è­¦</div>
            </div>
        `;
        document.getElementById('kpiArea').innerHTML = kpiHTML;
    }

    // --- æ¸²æŸ“åœ–è¡¨ ---
    function renderCharts() {
        // åœ“é¤…åœ–ï¼šç‹€æ…‹åˆ†ä½ˆ
        const statusCounts = {};
        allData.forEach(d => statusCounts[d.status] = (statusCounts[d.status] || 0) + 1);
        
        const ctxStatus = document.getElementById('statusChart').getContext('2d');
        if(statusChartRef) statusChartRef.destroy();
        
        statusChartRef = new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    data: Object.values(statusCounts),
                    backgroundColor: ['#CBD5E0', '#F6AD55', '#63B3ED', '#48BB78', '#E53E3E']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // é•·æ¢åœ–ï¼šå‰äº”å¤§å» å•†
        const partnerCounts = {};
        allData.forEach(d => {
            if(d.partyB && d.partyB !== "-") partnerCounts[d.partyB] = (partnerCounts[d.partyB] || 0) + 1;
        });
        const sortedPartners = Object.entries(partnerCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        
        const ctxPartner = document.getElementById('partnerChart').getContext('2d');
        if(partnerChartRef) partnerChartRef.destroy();

        partnerChartRef = new Chart(ctxPartner, {
            type: 'bar',
            data: {
                labels: sortedPartners.map(p => p[0]),
                datasets: [{
                    label: 'åˆç´„æ•¸é‡',
                    data: sortedPartners.map(p => p[1]),
                    backgroundColor: '#9FB1BC',
                    borderRadius: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                indexAxis: 'y'
            }
        });
    }

    // --- æ¸²æŸ“è¡¨æ ¼ (å«é‚è¼¯åˆ¤æ–·) ---
    function renderTable(data) {
        const tbody = document.querySelector('#contractTable tbody');
        tbody.innerHTML = "";

        data.forEach(d => {
            const tr = document.createElement('tr');
            
            // ç‹€æ…‹å¾½ç« é‚è¼¯
            let badgeClass = "badge-draft";
            if(d.status.includes("é€å¯©")) badgeClass = "badge-review";
            else if(d.status.includes("å”è­°")) badgeClass = "badge-nego";
            else if(d.status.includes("å®Œæˆ")) badgeClass = "badge-signed";
            else if(d.status.includes("å–æ¶ˆ")) badgeClass = "badge-cancel";
            
            const badgeHtml = `<span class="badge ${badgeClass}">${d.status}</span>`;

            // åˆ°æœŸæ—¥é‚è¼¯
            let expiryHtml = "-";
            let warningHtml = "-";
            
            if (d.endDate) {
                const dateStr = d.endDate.toLocaleDateString();
                const diffTime = d.endDate - TODAY;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                expiryHtml = dateStr;

                if (diffDays < 0) {
                    warningHtml = `<span class="tag-expiry tag-danger">å·²éæœŸ ${Math.abs(diffDays)} å¤©</span>`;
                } else if (diffDays <= 30) {
                    warningHtml = `<span class="tag-expiry tag-warning">å‰© ${diffDays} å¤©</span>`;
                } else {
                    warningHtml = `<span class="tag-expiry tag-ok">æ­£å¸¸</span>`;
                }
            }

            tr.innerHTML = `
                <td>${badgeHtml}</td>
                <td style="font-weight:600; color:var(--text-main);">${d.name}</td>
                <td>${d.partyB}</td>
                <td style="color:var(--text-muted);">${d.startDate || '-'}</td>
                <td style="color:var(--text-muted);">${expiryHtml}</td>
                <td>${warningHtml}</td>
                <td>${d.owner}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- ç¯©é¸åŠŸèƒ½ ---
    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const expiryFilter = document.getElementById('expiryFilter');

        function filterData() {
            const q = searchInput.value.toLowerCase();
            const s = statusFilter.value;
            const e = expiryFilter.value;

            const filtered = allData.filter(d => {
                // æ–‡å­—æœå°‹
                const matchText = d.name.toLowerCase().includes(q) || d.partyB.toLowerCase().includes(q);
                // ç‹€æ…‹ç¯©é¸
                const matchStatus = s === "" || d.status === s;
                // åˆ°æœŸç¯©é¸
                let matchExpiry = true;
                if (e === 'expired') {
                    matchExpiry = d.endDate && d.endDate < TODAY;
                } else if (e === 'warning') {
                    const diffDays = d.endDate ? (d.endDate - TODAY) / (1000 * 60 * 60 * 24) : 999;
                    matchExpiry = diffDays >= 0 && diffDays <= 30;
                }

                return matchText && matchStatus && matchExpiry;
            });

            renderTable(filtered);
        }

        searchInput.addEventListener('input', filterData);
        statusFilter.addEventListener('change', filterData);
        expiryFilter.addEventListener('change', filterData);
    }

  </script>
</body>
</html>